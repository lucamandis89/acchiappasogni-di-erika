<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Impostazioni - Acchiappasogni di Erika</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1020; color:#e9eefc; }
    header { position: sticky; top:0; backdrop-filter: blur(10px); background: rgba(11,16,32,.8); border-bottom:1px solid rgba(255,255,255,.08); padding:14px 16px; display:flex; align-items:center; gap:10px; z-index:5;}
    header h1 { margin:0; font-size:16px; font-weight:700; }
    header .spacer { flex:1; }
    a.btn, button.btn { border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color:#e9eefc; padding:10px 12px; border-radius:10px; cursor:pointer; text-decoration:none; font-weight:600; }
    a.btn:hover, button.btn:hover { background: rgba(255,255,255,.09); }
    main { padding:16px; max-width:1100px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
    @media (min-width: 960px) { .grid { grid-template-columns: 380px 1fr; } }
    .card { border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.04); border-radius:14px; padding:14px; }
    .card h2 { margin:0 0 10px; font-size:14px; }
    label { display:block; font-size:12px; opacity:.9; margin:10px 0 6px; }
    input, select, textarea { width:100%; box-sizing:border-box; padding:10px 10px; border-radius:10px;
      border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.25); color:#e9eefc; }
    textarea { min-height:88px; resize: vertical; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    .muted { opacity:.75; font-size:12px; line-height:1.35; }
    .actions { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
    .danger { border-color: rgba(255,90,90,.35) !important; background: rgba(255,90,90,.08) !important; }
    .ok { border-color: rgba(60,255,170,.25) !important; background: rgba(60,255,170,.08) !important; }
    .list { display:grid; gap:10px; }
    .item { display:flex; gap:12px; align-items:flex-start; padding:10px; border:1px solid rgba(255,255,255,.10); border-radius:12px; background: rgba(255,255,255,.03); }
    .thumb { width:78px; height:78px; border-radius:12px; object-fit:cover; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); }
    .item h3 { margin:0; font-size:14px; }
    .pill { display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); margin-top:6px; }
    .item .meta { flex:1; }
    .item .controls { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .small { padding:8px 10px !important; border-radius:10px !important; font-size:13px; }
    .hr { height:1px; background: rgba(255,255,255,.10); margin:12px 0; }
    .hidden { display:none !important; }
    code { background: rgba(255,255,255,.08); padding:2px 6px; border-radius:8px; }
  </style>
</head>
<body>
<header>
  <h1>Impostazioni (Admin)</h1>
  <span class="spacer"></span>
  <a class="btn" href="../">Torna al sito</a>
</header>

<main>
  <div id="lockCard" class="card">
    <h2>Accesso</h2>
    <div class="muted">Inserisci la password per aprire il pannello. Password: <code>1234</code></div>
    <div class="row">
      <div>
        <label>Password</label>
        <input id="pw" type="password" placeholder="1234" />
      </div>
      <div style="align-self:end">
        <button class="btn ok" id="btnLogin">Entra</button>
      </div>
    </div>
    <div id="lockErr" class="muted" style="margin-top:10px; color:#ff8e8e; display:none;">Password errata.</div>
  </div>

  <div id="app" class="grid hidden">
    <section class="card">
      <h2>Azioni veloci</h2>
      <div class="muted">
        Le modifiche si salvano <b>in locale</b> (telefono/PC) e il sito le usa subito.
        Per renderle “definitive” su GitHub: usa <b>Esporta JSON</b> e incollalo in <code>data/products.json</code>.
      </div>

      <div class="actions">
        <button class="btn" id="btnLoadFromGitHub">Ricarica da GitHub (reset locale)</button>
        <button class="btn" id="btnSetAll5">Metti tutti i prezzi a 5€</button>
        <button class="btn" id="btnExport">Esporta JSON</button>
        <button class="btn" id="btnImport">Importa JSON</button>
        <button class="btn danger" id="btnClearLocal">Cancella modifiche locali</button>
      </div>

      <div class="hr"></div>

      <h2>Aggiungi / Modifica prodotto</h2>

      <label>ID (unico)</label>
      <input id="f_id" placeholder="AE-1200" />

      <div class="row">
        <div>
          <label>Titolo (es: Acchiappasogni - Modello 1)</label>
          <input id="f_title" placeholder="Acchiappasogni - Modello 1" />
        </div>
        <div>
          <label>Categoria</label>
          <input id="f_category" placeholder="Acchiappasogni Classici" />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Prezzo (€)</label>
          <input id="f_price" type="number" min="0" step="0.01" value="5" />
        </div>
        <div>
          <label>In evidenza</label>
          <select id="f_featured">
            <option value="false">No</option>
            <option value="true">Sì</option>
          </select>
        </div>
        <div>
          <label>Numero modello (solo per ordinare)</label>
          <input id="f_modelNo" type="number" min="1" step="1" value="1" />
        </div>
      </div>

      <label>Descrizione (opzionale)</label>
      <textarea id="f_desc" placeholder="(lascia vuoto se non vuoi descrizione)"></textarea>

      <label>Foto (scegli 1 opzione)</label>
      <div class="muted">
        ✅ <b>Opzione A (consigliata)</b>: metti il percorso GitHub (es: <code>assets/images/acchiappasogni_hd/FB_IMG_....jpg</code>)<br>
        ✅ <b>Opzione B</b>: scegli un file dal telefono → si salva in locale (non va su GitHub).
      </div>

      <label>Percorso/URL immagine (Opzione A)</label>
      <input id="f_image" placeholder="assets/images/acchiappasogni_hd/FB_IMG_....jpg" />

      <label>Carica file immagine (Opzione B - solo locale)</label>
      <input id="f_file" type="file" accept="image/*" />

      <div style="margin-top:10px;">
        <img id="preview" class="thumb" alt="anteprima" />
      </div>

      <div class="actions">
        <button class="btn ok" id="btnSave">Salva (aggiungi / aggiorna)</button>
        <button class="btn" id="btnNew">Nuovo (pulisci campi)</button>
        <button class="btn danger" id="btnDelete">Elimina questo prodotto</button>
      </div>

      <div id="msg" class="muted" style="margin-top:10px;"></div>
    </section>

    <section class="card">
      <h2>Elenco prodotti</h2>
      <div class="muted">Tocca “Modifica” su un prodotto per caricarlo nel form.</div>

      <label>Cerca</label>
      <input id="q" placeholder="cerca titolo / id..." />

      <div class="hr"></div>

      <div id="list" class="list"></div>
    </section>
  </div>

  <div id="exportModal" class="card hidden">
    <h2>Esporta JSON</h2>
    <div class="muted">
      Copia tutto e incollalo in <code>data/products.json</code> su GitHub quando vuoi rendere le modifiche “online”.
    </div>
    <label>JSON</label>
    <textarea id="exportText" style="min-height:260px;"></textarea>
    <div class="actions">
      <button class="btn ok" id="btnCopy">Copia</button>
      <button class="btn" id="btnCloseExport">Chiudi</button>
    </div>
  </div>

  <div id="importModal" class="card hidden">
    <h2>Importa JSON</h2>
    <div class="muted">
      Incolla qui un JSON valido (array di prodotti). Verrà salvato in locale e usato dal sito.
    </div>
    <label>JSON</label>
    <textarea id="importText" style="min-height:220px;"></textarea>
    <div class="actions">
      <button class="btn ok" id="btnDoImport">Importa</button>
      <button class="btn" id="btnCloseImport">Chiudi</button>
    </div>
  </div>
</main>

<script>
(() => {
  const PASS = "1234";
  const KEY = "AE_PRODUCTS_OVERRIDE_V1";
  const GITHUB_PRODUCTS_URL = "../data/products.json";

  // --- DOM
  const $ = (id) => document.getElementById(id);

  const lockCard = $("lockCard");
  const app = $("app");
  const lockErr = $("lockErr");
  const pw = $("pw");
  const btnLogin = $("btnLogin");

  const btnLoadFromGitHub = $("btnLoadFromGitHub");
  const btnSetAll5 = $("btnSetAll5");
  const btnExport = $("btnExport");
  const btnImport = $("btnImport");
  const btnClearLocal = $("btnClearLocal");

  const exportModal = $("exportModal");
  const exportText = $("exportText");
  const btnCopy = $("btnCopy");
  const btnCloseExport = $("btnCloseExport");

  const importModal = $("importModal");
  const importText = $("importText");
  const btnDoImport = $("btnDoImport");
  const btnCloseImport = $("btnCloseImport");

  const f_id = $("f_id");
  const f_title = $("f_title");
  const f_category = $("f_category");
  const f_price = $("f_price");
  const f_featured = $("f_featured");
  const f_modelNo = $("f_modelNo");
  const f_desc = $("f_desc");
  const f_image = $("f_image");
  const f_file = $("f_file");
  const preview = $("preview");

  const btnSave = $("btnSave");
  const btnNew = $("btnNew");
  const btnDelete = $("btnDelete");
  const msg = $("msg");

  const q = $("q");
  const list = $("list");

  // --- STATE
  /** @type {Array<any>} */
  let products = [];

  // --- HELPERS
  function toast(t, ok=true){
    msg.textContent = t;
    msg.style.color = ok ? "#9dffcf" : "#ff9d9d";
    setTimeout(() => { if (msg.textContent === t) msg.textContent = ""; }, 3500);
  }

  function sanitizeNumber(n, fallback=0){
    const x = Number(n);
    return Number.isFinite(x) ? x : fallback;
  }

  function getLocal(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function setLocal(arr){
    localStorage.setItem(KEY, JSON.stringify(arr, null, 2));
  }

  async function fetchGitHubProducts(){
    const res = await fetch(GITHUB_PRODUCTS_URL + "?t=" + Date.now(), { cache:"no-store" });
    if(!res.ok) throw new Error("Impossibile caricare products.json");
    const data = await res.json();
    if(!Array.isArray(data)) throw new Error("JSON non valido: non è un array");
    return data;
  }

  function byModelNo(a,b){
    const an = sanitizeNumber(a.modelNo ?? guessModelNo(a.title), 999999);
    const bn = sanitizeNumber(b.modelNo ?? guessModelNo(b.title), 999999);
    return an - bn;
  }

  function guessModelNo(title=""){
    const m = String(title).match(/modello\s+(\d+)/i);
    return m ? Number(m[1]) : 999999;
  }

  function normalize(p){
    // descrizione opzionale: se vuota la togliamo (così “senza descrizione” resta pulito)
    const out = {
      id: String(p.id || "").trim(),
      title: String(p.title || "").trim(),
      category: String(p.category || "Acchiappasogni Classici").trim(),
      price_from: sanitizeNumber(p.price_from, 5),
      featured: Boolean(p.featured),
      // extra per ordinamento interno
      modelNo: sanitizeNumber(p.modelNo ?? guessModelNo(p.title), 999999),
    };

    const desc = (p.description ?? "").toString().trim();
    if(desc) out.description = desc;

    const img = (p.image ?? "").toString().trim();
    if(img) out.image = img;

    return out;
  }

  function renderList(){
    const query = (q.value || "").toLowerCase().trim();
    const filtered = products
      .slice()
      .sort(byModelNo)
      .filter(p => {
        if(!query) return true;
        return (p.id||"").toLowerCase().includes(query) ||
               (p.title||"").toLowerCase().includes(query);
      });

    list.innerHTML = "";
    if(filtered.length === 0){
      list.innerHTML = `<div class="muted">Nessun prodotto trovato.</div>`;
      return;
    }

    for(const p of filtered){
      const item = document.createElement("div");
      item.className = "item";

      const img = document.createElement("img");
      img.className = "thumb";
      img.alt = p.title || "foto";
      img.loading = "lazy";
      if(p.image){
        img.src = p.image.startsWith("data:") ? p.image : ("../" + p.image.replace(/^\.\//,"").replace(/^\/+/,""));
      } else {
        img.removeAttribute("src");
      }

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `
        <h3>${escapeHtml(p.title || "(senza titolo)")}</h3>
        <div class="pill">${escapeHtml(p.id || "")} · € ${escapeHtml(String(p.price_from ?? ""))}</div>
        <div class="muted" style="margin-top:6px;">${escapeHtml(p.category || "")}${p.featured ? " · In evidenza" : ""}</div>
      `;

      const controls = document.createElement("div");
      controls.className = "controls";
      const b1 = document.createElement("button");
      b1.className = "btn small";
      b1.textContent = "Modifica";
      b1.onclick = () => loadIntoForm(p.id);

      const b2 = document.createElement("button");
      b2.className = "btn small danger";
      b2.textContent = "Elimina";
      b2.onclick = () => {
        if(confirm(`Eliminare "${p.title}"?`)){
          products = products.filter(x => x.id !== p.id);
          setLocal(products);
          renderList();
          toast("Prodotto eliminato.");
          clearForm();
        }
      };

      controls.appendChild(b1);
      controls.appendChild(b2);

      item.appendChild(img);
      item.appendChild(meta);
      item.appendChild(controls);

      list.appendChild(item);
    }
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function clearForm(){
    f_id.value = "";
    f_title.value = "";
    f_category.value = "Acchiappasogni Classici";
    f_price.value = "5";
    f_featured.value = "false";
    f_modelNo.value = "1";
    f_desc.value = "";
    f_image.value = "";
    f_file.value = "";
    preview.src = "";
  }

  function loadIntoForm(id){
    const p = products.find(x => x.id === id);
    if(!p){ toast("Prodotto non trovato.", false); return; }

    f_id.value = p.id || "";
    f_title.value = p.title || "";
    f_category.value = p.category || "Acchiappasogni Classici";
    f_price.value = String(p.price_from ?? 5);
    f_featured.value = p.featured ? "true" : "false";
    f_modelNo.value = String(p.modelNo ?? guessModelNo(p.title) ?? 999999);
    f_desc.value = p.description || "";
    f_image.value = (p.image && !p.image.startsWith("data:")) ? p.image : "";
    f_file.value = "";

    if(p.image){
      preview.src = p.image.startsWith("data:") ? p.image : ("../" + p.image.replace(/^\.\//,"").replace(/^\/+/,""));
    } else {
      preview.src = "";
    }
  }

  function upsertFromForm(){
    const id = f_id.value.trim();
    const title = f_title.value.trim();
    if(!id){ toast("ID obbligatorio.", false); return; }
    if(!title){ toast("Titolo obbligatorio.", false); return; }

    const obj = normalize({
      id,
      title,
      category: f_category.value.trim() || "Acchiappasogni Classici",
      price_from: sanitizeNumber(f_price.value, 5),
      featured: (f_featured.value === "true"),
      modelNo: sanitizeNumber(f_modelNo.value, guessModelNo(title)),
      description: f_desc.value.trim(),
      image: f_image.value.trim()
    });

    // se l’utente ha caricato un file immagine, salviamo dataURL (solo locale)
    const file = f_file.files && f_file.files[0];
    if(file){
      const reader = new FileReader();
      reader.onload = () => {
        obj.image = String(reader.result || "");
        commitUpsert(obj);
      };
      reader.readAsDataURL(file);
      return;
    }

    commitUpsert(obj);
  }

  function commitUpsert(obj){
    // se immagine vuota, la togliamo
    if(!obj.image) delete obj.image;

    const i = products.findIndex(x => x.id === obj.id);
    if(i >= 0){
      products[i] = obj;
      toast("Prodotto aggiornato.");
    } else {
      products.push(obj);
      toast("Prodotto aggiunto.");
    }

    setLocal(products);
    renderList();
    loadIntoForm(obj.id);
  }

  function deleteCurrent(){
    const id = f_id.value.trim();
    if(!id){ toast("Seleziona un prodotto.", false); return; }
    const p = products.find(x => x.id === id);
    if(!p){ toast("Prodotto non trovato.", false); return; }

    if(confirm(`Eliminare "${p.title}"?`)){
      products = products.filter(x => x.id !== id);
      setLocal(products);
      renderList();
      toast("Prodotto eliminato.");
      clearForm();
    }
  }

  function exportJSON(){
    const out = products
      .slice()
      .sort(byModelNo)
      .map(p => {
        // togliamo modelNo prima di esportare se non ti serve nel sito
        const copy = { ...p };
        delete copy.modelNo;
        return copy;
      });

    exportText.value = JSON.stringify(out, null, 2);
    exportModal.classList.remove("hidden");
    importModal.classList.add("hidden");
    window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
  }

  function openImport(){
    importText.value = "";
    importModal.classList.remove("hidden");
    exportModal.classList.add("hidden");
    window.scrollTo({ top: document.body.scrollHeight, behavior:"smooth" });
  }

  function doImport(){
    const raw = importText.value.trim();
    if(!raw){ toast("Incolla un JSON.", false); return; }
    try{
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) throw new Error("Non è un array");
      products = arr.map(normalize);
      setLocal(products);
      renderList();
      toast("Import completato.");
      importModal.classList.add("hidden");
    } catch(e){
      toast("JSON non valido: " + e.message, false);
    }
  }

  function setAllPrices5(){
    products = products.map(p => ({ ...p, price_from: 5 }));
    setLocal(products);
    renderList();
    toast("Ok: tutti i prezzi a 5€.");
  }

  async function initAfterLogin(){
    // carico prima da localStorage, se non c’è allora da GitHub
    const local = getLocal();
    if(local && Array.isArray(local) && local.length){
      products = local.map(normalize);
    } else {
      products = (await fetchGitHubProducts()).map(normalize);
      // IMPORTANTISSIMO: di default mettiamo i prezzi a 5
      products = products.map(p => ({ ...p, price_from: 5 }));
      setLocal(products);
    }

    clearForm();
    renderList();
  }

  // --- EVENTS
  btnLogin.onclick = async () => {
    if(pw.value.trim() !== PASS){
      lockErr.style.display = "block";
      return;
    }
    lockErr.style.display = "none";
    lockCard.classList.add("hidden");
    app.classList.remove("hidden");
    await initAfterLogin();
  };

  pw.addEventListener("keydown", (e) => {
    if(e.key === "Enter") btnLogin.click();
  });

  q.oninput = renderList;

  btnSave.onclick = upsertFromForm;
  btnNew.onclick = clearForm;
  btnDelete.onclick = deleteCurrent;

  f_file.onchange = () => {
    const file = f_file.files && f_file.files[0];
    if(!file){ preview.src = ""; return; }
    const reader = new FileReader();
    reader.onload = () => preview.src = String(reader.result || "");
    reader.readAsDataURL(file);
  };

  btnExport.onclick = exportJSON;
  btnImport.onclick = openImport;

  btnCopy.onclick = async () => {
    try{
      await navigator.clipboard.writeText(exportText.value);
      toast("Copiato negli appunti.");
    } catch {
      toast("Non riesco a copiare: seleziona e copia manualmente.", false);
    }
  };

  btnCloseExport.onclick = () => exportModal.classList.add("hidden");
  btnCloseImport.onclick = () => importModal.classList.add("hidden");
  btnDoImport.onclick = doImport;

  btnSetAll5.onclick = () => {
    if(confirm("Vuoi impostare TUTTI i prodotti a 5€?")) setAllPrices5();
  };

  btnClearLocal.onclick = () => {
    if(confirm("Cancellare tutte le modifiche locali? (torni ai dati GitHub)")){
      localStorage.removeItem(KEY);
      toast("Modifiche locali cancellate.");
      location.reload();
    }
  };

  btnLoadFromGitHub.onclick = async () => {
    if(!confirm("Ricarico da GitHub e sovrascrivo i dati locali?")) return;
    try{
      const gh = await fetchGitHubProducts();
      products = gh.map(normalize).map(p => ({ ...p, price_from: 5 }));
      setLocal(products);
      renderList();
      toast("Ricaricato da GitHub.");
    } catch(e){
      toast("Errore: " + e.message, false);
    }
  };

})();
</script>
</body>
</html>
