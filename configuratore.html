<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Personalizza Acchiappasogni</title>
  <style>
    :root{
      --bg:#eef2ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --accent:#5b4bff;
      --shadow: 0 10px 30px rgba(2,6,23,.14);
      --r:18px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
    .top{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 14px;
      display:flex;align-items:flex-start;gap:12px;justify-content:space-between
    }
    .top h1{margin:0;font-size:20px;line-height:1.1}
    .top p{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      box-shadow: 0 6px 14px rgba(2,6,23,.08);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      align-items:start;
    }
    @media (pointer:coarse), (max-width:900px){
      .grid{grid-template-columns:1fr;}
      .panel{
        position:fixed;left:0;right:0;bottom:0;z-index:30;
        border-top-left-radius:22px;border-top-right-radius:22px;
        max-height:52vh;overflow:auto;
      }
      .stageCard{padding-bottom:calc(52vh + 12px);}
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }
    .stageCard{padding:12px}
    .panel{padding:12px}
    .secTitle{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.06em}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .chip:active{transform:scale(.98)}
    .chip.primary{background:rgba(91,75,255,.12);border-color:rgba(91,75,255,.35)}
    .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}

    /* STAGE */
    #stageWrap{
      width:100%;
      aspect-ratio: 9/16;
      max-height: 78vh;
      margin:0 auto;
      background: linear-gradient(180deg, #111827, #0b1020);
      border-radius: calc(var(--r) - 6px);
      overflow:hidden;
      position:relative;
      touch-action:none; /* per pinch/pan */
    }
    #viewport{
      position:absolute; inset:0;
      transform-origin: 50% 50%;
      will-change: transform;
    }
    /* cerchio base */
    #ring{
      position:absolute;
      left:50%; top:45%;
      width:62%;
      aspect-ratio:1/1;
      transform: translate(-50%,-50%);
      border:8px solid #0b0f1a;
      border-radius:50%;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
      pointer-events:none;
      background: transparent;
    }
    /* ragnatela (SVG) */
    #web{
      position:absolute;
      left:50%; top:45%;
      width:62%;
      aspect-ratio:1/1;
      transform: translate(-50%,-50%);
      pointer-events:none;
      opacity:.9;
    }
    #web svg{width:100%;height:100%;display:block}
    .w1{stroke:rgba(255,255,255,.25);fill:none;stroke-width:2}
    .w2{stroke:rgba(255,255,255,.14);fill:none;stroke-width:2}

    /* elementi trascinabili */
    .el{
      position:absolute;
      min-width:52px; min-height:52px;
      display:flex;align-items:center;justify-content:center;
      border-radius:16px;
      background: rgba(255,255,255,.9);
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 22px rgba(0,0,0,.28);
      user-select:none;
      touch-action:none;
    }
    .el.selected{
      outline: 3px solid rgba(91,75,255,.9);
      box-shadow: 0 0 0 7px rgba(91,75,255,.25), 0 12px 26px rgba(0,0,0,.30);
    }
    .el .emoji{font-size:30px;line-height:1}
    .toolbar{
      display:flex;gap:10px;flex-wrap:wrap;margin-top:10px
    }
    .danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>Personalizza il tuo Acchiappasogni</h1>
      <p>Trascina gli accessori nellâ€™anteprima. Pinch per zoom, 1 dito per spostare.</p>
    </div>
    <button class="btn" id="btnClose">âœ• Chiudi</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card stageCard">
        <div id="stageWrap" aria-label="Anteprima">
          <div id="viewport">
            <div id="ring"></div>
            <div id="web"></div>
            <!-- elementi dinamici qui -->
          </div>
        </div>
        <div class="small">Suggerimento: doppio tap per resettare lo zoom.</div>
      </div>

      <div class="card panel">
        <div class="secTitle">Accessori</div>
        <div class="row" id="palette">
          <div class="chip primary" data-add="ðŸª¶">Piuma</div>
          <div class="chip primary" data-add="âœ¨">Perla</div>
          <div class="chip primary" data-add="ðŸŒ™">Luna</div>
          <div class="chip primary" data-add="â­">Stella</div>
          <div class="chip primary" data-add="ðŸ§¿">Occhio</div>
          <div class="chip primary" data-add="ðŸªµ">Legno</div>
          <div class="chip primary" data-add="ðŸ”—">Catena</div>
          <div class="chip primary" data-add="ðŸŽ€">Fiocco</div>
        </div>

        <div class="secTitle" style="margin-top:14px">Ragnatela</div>
        <div class="row" id="weaves">
          <div class="chip" data-weave="classic">Classica</div>
          <div class="chip" data-weave="spiral">Spirale</div>
          <div class="chip" data-weave="chakra">Chakra</div>
        </div>

        <div class="toolbar">
          <button class="btn" id="btnReset">â†º Reset</button>
          <button class="btn danger" id="btnDelete">ðŸ—‘ Elimina selezionato</button>
        </div>

        <div class="small">
          âœ… Seleziona un accessorio toccandolo (bordo viola).<br/>
          âœ… Trascina per spostare. Pinch zoom funziona su tutto lo stage.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const stage = document.getElementById('stageWrap');
  const viewport = document.getElementById('viewport');
  const web = document.getElementById('web');
  const btnClose = document.getElementById('btnClose');
  const btnReset = document.getElementById('btnReset');
  const btnDelete = document.getElementById('btnDelete');
  const palette = document.getElementById('palette');
  const weaves = document.getElementById('weaves');

  // chiudi (funziona sia in iframe che standalone)
  btnClose.addEventListener('click', () => {
    try { parent.postMessage({ type:'DC_CLOSE' }, '*'); } catch(e) {}
    // fallback se non in iframe
    if(history.length > 1) history.back();
  });

  // ---------- WEB DRAW ----------
  function setWeave(type){
    const s = 100;
    if(type === 'spiral'){
      web.innerHTML = `
        <svg viewBox="0 0 ${s} ${s}">
          <path class="w1" d="M50 50
            m0-40
            a40 40 0 1 1 -1 0
            a39 39 0 1 0 1 0
            a28 28 0 1 1 -1 0
            a20 20 0 1 0 1 0" />
        </svg>`;
    } else if(type === 'chakra'){
      web.innerHTML = `
        <svg viewBox="0 0 ${s} ${s}">
          <circle class="w2" cx="50" cy="50" r="36"/>
          <circle class="w2" cx="50" cy="50" r="28"/>
          <circle class="w2" cx="50" cy="50" r="20"/>
          <circle class="w2" cx="50" cy="50" r="12"/>
          <path class="w1" d="M50 14 L50 86"/>
          <path class="w1" d="M14 50 L86 50"/>
          <path class="w1" d="M24 24 L76 76"/>
          <path class="w1" d="M76 24 L24 76"/>
        </svg>`;
    } else {
      // classic
      web.innerHTML = `
        <svg viewBox="0 0 ${s} ${s}">
          <circle class="w2" cx="50" cy="50" r="36"/>
          <circle class="w2" cx="50" cy="50" r="26"/>
          <circle class="w2" cx="50" cy="50" r="16"/>
          <path class="w1" d="M50 14 L80 30 L72 64 L50 86 L28 64 L20 30 Z"/>
          <path class="w2" d="M50 14 L28 64 L80 30 L20 30 L72 64 L50 86"/>
        </svg>`;
    }
    // UI active
    [...weaves.querySelectorAll('.chip')].forEach(c => c.classList.toggle('primary', c.dataset.weave === type));
  }
  setWeave('classic');

  weaves.addEventListener('click', (e) => {
    const b = e.target.closest('[data-weave]');
    if(!b) return;
    setWeave(b.dataset.weave);
  });

  // ---------- ELEMENTS ----------
  let selectedId = null;
  let idc = 1;
  function deselectAll(){
    selectedId = null;
    viewport.querySelectorAll('.el').forEach(el => el.classList.remove('selected'));
  }
  function selectEl(el){
    deselectAll();
    selectedId = el.dataset.id;
    el.classList.add('selected');
  }

  function addEl(emoji){
    const el = document.createElement('div');
    el.className = 'el';
    el.dataset.id = String(idc++);
    el.innerHTML = `<div class="emoji">${emoji}</div>`;
    // pos iniziale: centro basso
    const rect = stage.getBoundingClientRect();
    el.style.left = (rect.width*0.5) + 'px';
    el.style.top  = (rect.height*0.68) + 'px';
    el.style.transform = 'translate(-50%,-50%)';
    viewport.appendChild(el);
    bindDrag(el);
    selectEl(el);
  }

  palette.addEventListener('click', (e) => {
    const b = e.target.closest('[data-add]');
    if(!b) return;
    addEl(b.dataset.add);
  });

  btnDelete.addEventListener('click', () => {
    if(!selectedId) return;
    const el = viewport.querySelector(`.el[data-id="${CSS.escape(selectedId)}"]`);
    if(el) el.remove();
    deselectAll();
  });

  btnReset.addEventListener('click', () => {
    // remove elements
    viewport.querySelectorAll('.el').forEach(el => el.remove());
    deselectAll();
    // reset transform
    scale = 1; tx = 0; ty = 0; applyTransform();
    setWeave('classic');
  });

  // tap on background deselect
  stage.addEventListener('pointerdown', (e) => {
    const hit = e.target.closest('.el');
    if(!hit) deselectAll();
  });

  // ---------- DRAG (elements) ----------
  function bindDrag(el){
    let start = null;
    el.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      e.stopPropagation();
      selectEl(el);
      el.setPointerCapture(e.pointerId);
      const p = toLocal(e.clientX, e.clientY);
      start = {
        id: e.pointerId,
        x: p.x,
        y: p.y,
        left: parseFloat(el.style.left||'0'),
        top: parseFloat(el.style.top||'0')
      };
    }, {passive:false});

    el.addEventListener('pointermove', (e) => {
      if(!start || e.pointerId !== start.id) return;
      e.preventDefault();
      const p = toLocal(e.clientX, e.clientY);
      const dx = p.x - start.x;
      const dy = p.y - start.y;
      el.style.left = (start.left + dx) + 'px';
      el.style.top  = (start.top + dy) + 'px';
    }, {passive:false});

    el.addEventListener('pointerup', (e) => { if(start && e.pointerId===start.id) start=null; });
    el.addEventListener('pointercancel', (e) => { if(start && e.pointerId===start.id) start=null; });
  }

  // ---------- PINCH ZOOM + PAN (stage) ----------
  let scale = 1, tx = 0, ty = 0;
  const pointers = new Map();
  let pinchStart = null;

  function applyTransform(){
    viewport.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
  }

  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

  function toLocal(cx, cy){
    // coordinate nel sistema viewport (considerando tx/ty/scale)
    const r = stage.getBoundingClientRect();
    const x = (cx - r.left - tx) / scale;
    const y = (cy - r.top  - ty) / scale;
    return {x,y};
  }

  stage.addEventListener('pointerdown', (e) => {
    // non bloccare se tocchi un elemento (lo gestisce il drag)
    if(e.target.closest('.el')) return;

    stage.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    if(pointers.size === 1){
      // pan start
      pinchStart = { mode:'pan', x:e.clientX, y:e.clientY, tx, ty };
    }
    if(pointers.size === 2){
      const pts = [...pointers.values()];
      pinchStart = { mode:'pinch', d: dist(pts[0], pts[1]), scale, tx, ty, mid: {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2} };
    }
  }, {passive:false});

  stage.addEventListener('pointermove', (e) => {
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

    if(!pinchStart) return;

    if(pointers.size === 1 && pinchStart.mode === 'pan'){
      e.preventDefault();
      const dx = e.clientX - pinchStart.x;
      const dy = e.clientY - pinchStart.y;
      tx = pinchStart.tx + dx;
      ty = pinchStart.ty + dy;
      applyTransform();
    }

    if(pointers.size === 2){
      e.preventDefault();
      const pts = [...pointers.values()];
      const d = dist(pts[0], pts[1]);
      const mid = {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2};

      let newScale = (pinchStart.scale * d / pinchStart.d);
      newScale = Math.max(0.6, Math.min(3.0, newScale));

      // zoom verso il centro pinch
      const r = stage.getBoundingClientRect();
      const mx = mid.x - r.left;
      const my = mid.y - r.top;

      const k = newScale / scale;
      tx = (tx - mx) * k + mx;
      ty = (ty - my) * k + my;
      scale = newScale;

      applyTransform();
    }
  }, {passive:false});

  function endPointer(e){
    pointers.delete(e.pointerId);
    if(pointers.size === 0) pinchStart = null;
    if(pointers.size === 1){
      const p = [...pointers.values()][0];
      pinchStart = { mode:'pan', x:p.x, y:p.y, tx, ty };
    }
  }
  stage.addEventListener('pointerup', endPointer, {passive:false});
  stage.addEventListener('pointercancel', endPointer, {passive:false});

  // doppio tap reset zoom
  let lastTap=0;
  stage.addEventListener('click', () => {
    const now = Date.now();
    if(now-lastTap < 320){
      scale=1; tx=0; ty=0; applyTransform();
    }
    lastTap = now;
  });

  applyTransform();
})();
</script>
</body>
</html>
