<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Personalizza Acchiappasogni</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --accent:#5b4bff;
      --shadow: 0 10px 30px rgba(2,6,23,.14);
      --r:18px;
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--text);background:var(--bg)}
    .top{
      position:sticky;top:0;z-index:20;
      background:rgba(255,255,255,.95);
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
      padding:14px 14px;
      display:flex;align-items:flex-start;gap:12px;justify-content:space-between
    }
    .top h1{margin:0;font-size:20px;line-height:1.1}
    .top p{margin:6px 0 0;font-size:13px;color:var(--muted)}
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      box-shadow: 0 6px 14px rgba(2,6,23,.08);
    }
    .btn:active{transform:scale(.98)}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:12px;
      align-items:start;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--r);
      box-shadow: var(--shadow);
    }
    .stageCard{padding:12px}
    .panel{padding:12px}
    .secTitle{margin:0 0 10px;font-size:12px;color:var(--muted);font-weight:900;text-transform:uppercase;letter-spacing:.06em}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .chip.primary{background:rgba(91,75,255,.10);border-color:rgba(91,75,255,.35)}
    .chip.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35)}
    .chip:active{transform:scale(.98)}
    .small{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);font-weight:800}
    input[type="text"], input[type="number"]{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-weight:700;
      outline:none;
      background:#fff;
    }
    input[type="range"]{width:100%}
    .hr{height:1px;background:var(--border);margin:12px 0}

    /* STAGE */
    #stageWrap{
      width:100%;
      aspect-ratio: 9/16;
      max-height: 80vh;
      margin:0 auto;
      background:#ffffff;              /* richiesto: sfondo bianco */
      border-radius: calc(var(--r) - 6px);
      overflow:hidden;
      position:relative;
      border:1px solid var(--border);
      touch-action:none;
    }
    #stageSvg{width:100%;height:100%;display:block}
    .hintLine{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{font-size:12px;color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    /* Mobile: pannello sotto tipo app */
    @media (pointer:coarse), (max-width:900px){
      .grid{grid-template-columns:1fr;}
      .panel{
        position:fixed;left:0;right:0;bottom:0;z-index:30;
        border-top-left-radius:22px;border-top-right-radius:22px;
        max-height:52vh;overflow:auto;
      }
      .stageCard{padding-bottom:calc(52vh + 12px);}
    }
  </style>
</head>
<body>
  <div class="top">
    <div>
      <h1>Personalizza il tuo Acchiappasogni</h1>
      <p>Trascina gli accessori nell‚Äôanteprima. Pinch per zoom, 1 dito per spostare.</p>
    </div>
    <button class="btn" id="btnClose">‚úï Chiudi</button>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="card stageCard">
        <div id="stageWrap" aria-label="Anteprima">
          <!-- Tutto in SVG cos√¨ possiamo esportare un PNG senza librerie -->
          <svg id="stageSvg" viewBox="0 0 1000 1600" xmlns="http://www.w3.org/2000/svg">
            <rect id="bgRect" x="0" y="0" width="1000" height="1600" fill="#ffffff"/>
            <g id="world" transform="translate(0 0) scale(1)">
              <!-- Rings + ragnatele -->
              <g id="ringsLayer"></g>
              <!-- Accessori -->
              <g id="accLayer"></g>
            </g>
          </svg>
        </div>

        <div class="hintLine">
          <div class="pill">Suggerimento: doppio tap per resettare lo zoom.</div>
          <div class="pill mono" id="selInfo">Nessun elemento selezionato</div>
        </div>
      </div>

      <div class="card panel">
        <div class="secTitle">Impostazioni base</div>
        <div class="grid2">
          <div class="field">
            <label>Sfondo</label>
            <input type="color" id="bgColor" value="#ffffff"/>
          </div>
          <div class="field">
            <label>Colore cerchio</label>
            <input type="color" id="ringColor" value="#000000"/>
          </div>
        </div>

        <div class="hr"></div>

        <div class="secTitle">Cerchi (illimitati)</div>
        <div class="row">
          <div class="chip primary" id="btnAddRing">+ Aggiungi cerchio</div>
          <div class="chip" id="btnRemoveRing">- Rimuovi ultimo</div>
        </div>
        <div class="small">Ogni cerchio pu√≤ avere diametro e tessitura diversi.</div>

        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label>Diametro cerchio selezionato</label>
            <input type="range" id="ringSize" min="150" max="900" value="620"/>
          </div>
          <div class="field">
            <label>Tessitura cerchio selezionato</label>
            <select id="ringWeave" style="border:1px solid var(--border); border-radius:12px; padding:10px; font-weight:800;">
              <option value="classic">Classica</option>
              <option value="spiral">Spirale</option>
              <option value="chakra">Chakra</option>
              <option value="star">Stella</option>
              <option value="dense">Fitta</option>
            </select>
          </div>
        </div>

        <div class="hr"></div>

        <div class="secTitle">Accessori realistici</div>
        <div class="row" id="palette">
          <div class="chip primary" data-add="feather">Piuma</div>
          <div class="chip primary" data-add="bead">Perlina</div>
          <div class="chip primary" data-add="chain">Catenella</div>
          <div class="chip primary" data-add="moon">Luna</div>
          <div class="chip primary" data-add="star">Stella</div>
          <div class="chip primary" data-add="eye">Occhio</div>
          <div class="chip primary" data-add="bow">Fiocco</div>
        </div>

        <div class="hr"></div>

        <div class="secTitle">Elemento selezionato</div>
        <div class="grid2">
          <div class="field">
            <label>Colore accessorio</label>
            <input type="color" id="accColor" value="#0ea5e9"/>
          </div>
          <div class="field">
            <label>Dimensione</label>
            <input type="range" id="accScale" min="30" max="220" value="90"/>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div class="field">
            <label>Rotazione (¬∞)</label>
            <input type="range" id="accRot" min="-180" max="180" value="0"/>
          </div>
          <div class="field">
            <label>Tipo (selez.)</label>
            <input type="text" id="accType" readonly value="‚Äî"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="chip" id="btnReset">‚Ü∫ Reset</div>
          <div class="chip danger" id="btnDelete">üóë Elimina selezionato</div>
          <div class="chip primary" id="btnSend">üì≤ Invia su WhatsApp</div>
        </div>

        <div class="small">
          ‚úÖ Tocca un accessorio per selezionarlo (contorno viola).<br/>
          ‚úÖ Trascina per spostare. Pinch zoom su tutta l‚Äôanteprima.<br/>
          ‚ö†Ô∏è Per i limiti del browser, WhatsApp non permette allegare automaticamente l‚Äôimmagine: al click ‚ÄúInvia‚Äù scarichiamo l‚Äôanteprima e apriamo WhatsApp con il testo pronto.
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== CONFIG ======
  const WHATSAPP_NUMBER = '+393440260906';

  // ====== DOM ======
  const btnClose = document.getElementById('btnClose');
  const stageWrap = document.getElementById('stageWrap');
  const svg = document.getElementById('stageSvg');
  const bgRect = document.getElementById('bgRect');
  const world = document.getElementById('world');
  const ringsLayer = document.getElementById('ringsLayer');
  const accLayer = document.getElementById('accLayer');

  const bgColor = document.getElementById('bgColor');
  const ringColor = document.getElementById('ringColor');

  const btnAddRing = document.getElementById('btnAddRing');
  const btnRemoveRing = document.getElementById('btnRemoveRing');
  const ringSize = document.getElementById('ringSize');
  const ringWeave = document.getElementById('ringWeave');

  const palette = document.getElementById('palette');
  const accColor = document.getElementById('accColor');
  const accScale = document.getElementById('accScale');
  const accRot = document.getElementById('accRot');
  const accType = document.getElementById('accType');

  const btnReset = document.getElementById('btnReset');
  const btnDelete = document.getElementById('btnDelete');
  const btnSend = document.getElementById('btnSend');
  const selInfo = document.getElementById('selInfo');

  // ====== CLOSE ======
  btnClose.addEventListener('click', () => {
    try { parent.postMessage({ type:'DC_CLOSE' }, '*'); } catch(e) {}
    if(history.length > 1) history.back();
  });

  // ====== STATE ======
  const CENTER = { x: 500, y: 700 }; // posizione cerchi (stile foto)
  let rings = [
    { id: 'ring1', d: 620, color: '#000000', weave: 'classic' }
  ];
  let selectedRingIndex = 0;

  let acc = [];
  let selectedAccId = null;
  let accIdC = 1;

  // zoom/pan world transform
  let scale = 1, tx = 0, ty = 0;
  const pointers = new Map();
  let gesture = null;
  let lastTap = 0;

  // ====== UTIL ======
  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
  function q(s){ return document.querySelector(s); }

  function setSelectedAcc(id){
    selectedAccId = id;
    // update UI highlight
    [...accLayer.querySelectorAll('[data-acc-id]')].forEach(n => {
      n.setAttribute('data-selected', n.getAttribute('data-acc-id') === String(id) ? '1' : '0');
    });
    const obj = acc.find(x => x.id === id);
    if(!obj){
      accColor.value = '#0ea5e9';
      accScale.value = 90;
      accRot.value = 0;
      accType.value = '‚Äî';
      selInfo.textContent = 'Nessun elemento selezionato';
      return;
    }
    accColor.value = obj.color;
    accScale.value = obj.size;
    accRot.value = obj.rot;
    accType.value = niceType(obj.type);
    selInfo.textContent = `Selezionato: ${niceType(obj.type)} ‚Ä¢ ${colorName(obj.color)} ‚Ä¢ size ${obj.size}`;
  }

  function niceType(t){
    return ({
      feather:'Piuma', bead:'Perlina', chain:'Catenella', moon:'Luna', star:'Stella', eye:'Occhio', bow:'Fiocco'
    }[t]) || t;
  }

  // Mappa colore base (nomi semplici, non codici)
  function colorName(hex){
    const h = String(hex||'').toLowerCase();
    const map = [
      ['#000000','nero'],['#ffffff','bianco'],['#ff0000','rosso'],['#00ff00','verde'],['#0000ff','blu'],
      ['#ffff00','giallo'],['#ff00ff','fucsia'],['#00ffff','azzurro'],['#ffa500','arancione'],
      ['#a52a2a','marrone'],['#808080','grigio'],['#ffd700','oro'],['#c0c0c0','argento']
    ];
    // nearest by RGB
    function hexToRgb(x){
      const m = /^#?([0-9a-f]{6})$/.exec(x);
      if(!m) return [0,0,0];
      const n = parseInt(m[1],16);
      return [(n>>16)&255, (n>>8)&255, n&255];
    }
    const [r,g,b] = hexToRgb(h);
    let best = {d:1e18, name:h};
    for(const [k,name] of map){
      const [R,G,B] = hexToRgb(k);
      const d = (r-R)*(r-R)+(g-G)*(g-G)+(b-B)*(b-B);
      if(d < best.d) best = {d,name};
    }
    return best.name;
  }

  function applyWorldTransform(){
    world.setAttribute('transform', `translate(${tx} ${ty}) scale(${scale})`);
  }

  function svgPointFromClient(cx, cy){
    const pt = svg.createSVGPoint();
    pt.x = cx; pt.y = cy;
    const ctm = svg.getScreenCTM();
    if(!ctm) return {x:0,y:0};
    const inv = ctm.inverse();
    const p = pt.matrixTransform(inv);
    // convert to world coords (reverse world transform)
    return {
      x: (p.x - tx) / scale,
      y: (p.y - ty) / scale
    };
  }

  // ====== DRAW RINGS / WEAVES ======
  function weavePaths(type, r){
    // returns array of SVG elements strings for a ring of radius r centered at 0,0
    // stroke defined outside
    const out = [];
    const circle = (rad, cls) => `<circle class="${cls}" cx="0" cy="0" r="${rad}" fill="none"/>`;
    const line = (x1,y1,x2,y2, cls) => `<line class="${cls}" x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"/>`;

    if(type === 'spiral'){
      // simple spiral approximation with path
      out.push(`<path class="w1" d="M 0 ${-r} 
        a ${r} ${r} 0 1 1 -1 0
        a ${r-8} ${r-8} 0 1 0 1 0
        a ${r-40} ${r-40} 0 1 1 -1 0" fill="none"/>`);
    } else if(type === 'chakra'){
      out.push(circle(r*0.92,'w2'));
      out.push(circle(r*0.72,'w2'));
      out.push(circle(r*0.52,'w2'));
      out.push(circle(r*0.32,'w2'));
      out.push(line(0,-r*0.92,0,r*0.92,'w1'));
      out.push(line(-r*0.92,0,r*0.92,0,'w1'));
      out.push(line(-r*0.65,-r*0.65,r*0.65,r*0.65,'w1'));
      out.push(line(r*0.65,-r*0.65,-r*0.65,r*0.65,'w1'));
    } else if(type === 'star'){
      out.push(circle(r*0.86,'w2'));
      out.push(circle(r*0.60,'w2'));
      // 5-point star spokes
      const pts = [];
      for(let i=0;i<5;i++){
        const a = (-90 + i*72) * Math.PI/180;
        pts.push({x: Math.cos(a)*r*0.86, y: Math.sin(a)*r*0.86});
      }
      // connect every second point
      for(let i=0;i<5;i++){
        const a = pts[i];
        const b = pts[(i+2)%5];
        out.push(`<line class="w1" x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}"/>`);
      }
    } else if(type === 'dense'){
      // more circles + more spokes
      for(const k of [0.90,0.78,0.66,0.54,0.42,0.30,0.18]){
        out.push(circle(r*k,'w2'));
      }
      for(let i=0;i<12;i++){
        const a = i*(Math.PI*2/12);
        out.push(line(Math.cos(a)*r*0.90, Math.sin(a)*r*0.90, 0, 0, 'w1'));
      }
    } else {
      // classic
      out.push(circle(r*0.88,'w2'));
      out.push(circle(r*0.62,'w2'));
      out.push(circle(r*0.36,'w2'));
      // hex-ish web
      const A = [];
      for(let i=0;i<6;i++){
        const a = (-90 + i*60) * Math.PI/180;
        A.push({x:Math.cos(a)*r*0.88, y:Math.sin(a)*r*0.88});
      }
      for(let i=0;i<6;i++){
        const p1=A[i], p2=A[(i+1)%6];
        out.push(line(p1.x,p1.y,p2.x,p2.y,'w1'));
      }
      // diagonals
      out.push(line(A[0].x,A[0].y,A[3].x,A[3].y,'w2'));
      out.push(line(A[1].x,A[1].y,A[4].x,A[4].y,'w2'));
      out.push(line(A[2].x,A[2].y,A[5].x,A[5].y,'w2'));
    }
    return out;
  }

  function drawRings(){
    ringsLayer.innerHTML = '';
    rings.forEach((rg, idx) => {
      const r = rg.d/2;
      const sel = idx === selectedRingIndex;
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('data-ring-id', rg.id);
      g.setAttribute('transform', `translate(${CENTER.x} ${CENTER.y})`);
      g.style.cursor = 'default';

      // ring outline (nero / colore scelto)
      const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
      circle.setAttribute('cx','0'); circle.setAttribute('cy','0'); circle.setAttribute('r', String(r));
      circle.setAttribute('fill','none');
      circle.setAttribute('stroke', rg.color);
      circle.setAttribute('stroke-width', String(clamp(r*0.035, 8, 18)));
      circle.setAttribute('opacity','1');
      g.appendChild(circle);

      // web group
      const webG = document.createElementNS('http://www.w3.org/2000/svg','g');
      webG.innerHTML = weavePaths(rg.weave, r*0.92).join('');
      // style web lines
      webG.querySelectorAll('.w1,.w2').forEach(n=>{
        n.setAttribute('stroke', 'rgba(0,0,0,.35)');
        n.setAttribute('stroke-width', String(clamp(r*0.006, 2, 3)));
      });
      webG.querySelectorAll('.w2').forEach(n=>{
        n.setAttribute('stroke', 'rgba(0,0,0,.20)');
      });
      g.appendChild(webG);

      // selection halo
      if(sel){
        const halo = document.createElementNS('http://www.w3.org/2000/svg','circle');
        halo.setAttribute('cx','0'); halo.setAttribute('cy','0'); halo.setAttribute('r', String(r + 10));
        halo.setAttribute('fill','none');
        halo.setAttribute('stroke', 'rgba(91,75,255,.7)');
        halo.setAttribute('stroke-width','4');
        halo.setAttribute('stroke-dasharray','10 10');
        g.appendChild(halo);
      }

      // click to select ring
      g.addEventListener('pointerdown', (e)=>{
        // ignore if dragging accessory
        if(e.target && e.target.closest && e.target.closest('[data-acc-id]')) return;
        selectedRingIndex = idx;
        ringSize.value = String(rg.d);
        ringWeave.value = rg.weave;
        drawRings();
      });

      ringsLayer.appendChild(g);
    });
  }

  // ====== ACCESSORY SHAPES (SVG) ======
  function accSvg(type, color){
    const c = color;
    if(type === 'bead'){
      return `
        <g>
          <circle cx="0" cy="0" r="40" fill="${c}" opacity="0.95"/>
          <circle cx="-12" cy="-14" r="10" fill="rgba(255,255,255,.55)"/>
          <circle cx="0" cy="0" r="40" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="3"/>
        </g>`;
    }
    if(type === 'chain'){
      // 3 anelli
      return `
        <g fill="none" stroke="${c}" stroke-width="10" stroke-linecap="round" opacity="0.95">
          <ellipse cx="0" cy="-55" rx="36" ry="22"/>
          <ellipse cx="0" cy="0" rx="36" ry="22"/>
          <ellipse cx="0" cy="55" rx="36" ry="22"/>
        </g>`;
    }
    if(type === 'feather'){
      return `
        <g>
          <path d="M-10,-80 C-55,-35 -55,35 -5,80 C35,35 40,-25 -10,-80Z" fill="${c}" opacity="0.95"/>
          <path d="M-10,-80 C-2,-30 -2,20 -5,80" stroke="rgba(0,0,0,.25)" stroke-width="6" stroke-linecap="round"/>
          <path d="M-18,-50 L-50,-35" stroke="rgba(255,255,255,.35)" stroke-width="5" stroke-linecap="round"/>
          <path d="M-12,-15 L-52,0" stroke="rgba(255,255,255,.35)" stroke-width="5" stroke-linecap="round"/>
          <path d="M-8,18 L-45,35" stroke="rgba(255,255,255,.35)" stroke-width="5" stroke-linecap="round"/>
        </g>`;
    }
    if(type === 'moon'){
      return `
        <g>
          <path d="M20,-55 A55,55 0 1 0 20,55 A35,35 0 1 1 20,-55Z" fill="${c}" opacity="0.95"/>
          <path d="M20,-55 A55,55 0 1 0 20,55" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="4"/>
        </g>`;
    }
    if(type === 'star'){
      return `
        <g>
          <path d="M0,-70 L18,-22 L68,-22 L28,8 L44,55 L0,28 L-44,55 L-28,8 L-68,-22 L-18,-22 Z"
                fill="${c}" opacity="0.95" stroke="rgba(0,0,0,.18)" stroke-width="4" stroke-linejoin="round"/>
        </g>`;
    }
    if(type === 'eye'){
      return `
        <g>
          <path d="M-85,0 C-50,-45 50,-45 85,0 C50,45 -50,45 -85,0Z" fill="${c}" opacity="0.9"/>
          <circle cx="0" cy="0" r="28" fill="rgba(255,255,255,.9)"/>
          <circle cx="0" cy="0" r="14" fill="rgba(0,0,0,.75)"/>
          <circle cx="-6" cy="-8" r="6" fill="rgba(255,255,255,.7)"/>
          <path d="M-85,0 C-50,-45 50,-45 85,0" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="5"/>
          <path d="M-85,0 C-50,45 50,45 85,0" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="5"/>
        </g>`;
    }
    if(type === 'bow'){
      return `
        <g>
          <path d="M0,0 C-30,-35 -80,-40 -95,0 C-80,40 -30,35 0,0Z" fill="${c}" opacity="0.95"/>
          <path d="M0,0 C30,-35 80,-40 95,0 C80,40 30,35 0,0Z" fill="${c}" opacity="0.95"/>
          <circle cx="0" cy="0" r="22" fill="rgba(255,255,255,.25)"/>
          <circle cx="0" cy="0" r="18" fill="${c}" opacity="0.95"/>
          <path d="M-95,0 C-80,40 -30,35 0,0" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="4"/>
          <path d="M95,0 C80,40 30,35 0,0" fill="none" stroke="rgba(0,0,0,.18)" stroke-width="4"/>
        </g>`;
    }
    return `<circle cx="0" cy="0" r="40" fill="${c}"/>`;
  }

  function drawAccessories(){
    accLayer.innerHTML = '';
    acc.forEach(obj => {
      const g = document.createElementNS('http://www.w3.org/2000/svg','g');
      g.setAttribute('data-acc-id', String(obj.id));
      g.setAttribute('transform', `translate(${obj.x} ${obj.y}) rotate(${obj.rot})`);
      g.style.cursor = 'grab';

      // background selection
      const isSel = obj.id === selectedAccId;
      if(isSel){
        const halo = document.createElementNS('http://www.w3.org/2000/svg','rect');
        halo.setAttribute('x', String(-obj.size/2 - 18));
        halo.setAttribute('y', String(-obj.size/2 - 18));
        halo.setAttribute('width', String(obj.size + 36));
        halo.setAttribute('height', String(obj.size + 36));
        halo.setAttribute('rx', '18');
        halo.setAttribute('fill', 'rgba(91,75,255,.10)');
        halo.setAttribute('stroke', 'rgba(91,75,255,.90)');
        halo.setAttribute('stroke-width', '5');
        accLayer.appendChild(halo);
        // put halo behind: we re-append g after halo
      }

      // scale wrapper
      const inner = document.createElementNS('http://www.w3.org/2000/svg','g');
      const s = obj.size/100;
      inner.setAttribute('transform', `scale(${s})`);
      inner.innerHTML = accSvg(obj.type, obj.color);
      g.appendChild(inner);

      // pointer handlers for drag/select
      bindAccEvents(g, obj.id);

      // ensure selection order: selected on top
      if(isSel){
        accLayer.appendChild(g);
      } else {
        accLayer.appendChild(g);
      }
    });
  }

  // ====== DRAG ACCESSORIES ======
  const dragState = { id:null, dx:0, dy:0 };

  function bindAccEvents(node, id){
    node.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      setSelectedAcc(id);
      node.style.cursor = 'grabbing';
      node.setPointerCapture(e.pointerId);

      const obj = acc.find(x=>x.id===id);
      if(!obj) return;
      const p = svgPointFromClient(e.clientX, e.clientY);
      dragState.id = id;
      dragState.dx = obj.x - p.x;
      dragState.dy = obj.y - p.y;
    }, {passive:false});

    node.addEventListener('pointermove', (e)=>{
      if(dragState.id !== id) return;
      e.preventDefault();
      const obj = acc.find(x=>x.id===id);
      if(!obj) return;
      const p = svgPointFromClient(e.clientX, e.clientY);
      obj.x = p.x + dragState.dx;
      obj.y = p.y + dragState.dy;
      drawAccessories();
    }, {passive:false});

    const end = ()=>{
      if(dragState.id === id){
        dragState.id = null;
        node.style.cursor = 'grab';
      }
    };
    node.addEventListener('pointerup', end);
    node.addEventListener('pointercancel', end);
  }

  // ====== PAN/ZOOM (WORLD) ======
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }

  stageWrap.addEventListener('pointerdown', (e)=>{
    // ignore if hit accessory (handled there)
    if(e.target && e.target.closest && e.target.closest('[data-acc-id]')) return;

    stageWrap.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

    if(pointers.size === 1){
      gesture = { mode:'pan', x:e.clientX, y:e.clientY, tx, ty };
    }
    if(pointers.size === 2){
      const pts = [...pointers.values()];
      gesture = {
        mode:'pinch',
        d: dist(pts[0], pts[1]),
        scale,
        tx, ty,
        mid: {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2}
      };
    }
  }, {passive:false});

  stageWrap.addEventListener('pointermove', (e)=>{
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    if(!gesture) return;

    if(pointers.size === 2){
      e.preventDefault();
      const pts = [...pointers.values()];
      const d = dist(pts[0], pts[1]);
      const mid = {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2};
      let newScale = gesture.scale * d / gesture.d;
      newScale = clamp(newScale, 0.6, 3.2);

      // zoom towards pinch center
      const p0 = svgPointFromClient(mid.x, mid.y); // world coords before update
      // update scale
      const oldScale = scale;
      scale = newScale;
      // adjust translate so p0 stays under finger
      // recompute translate: tx' = tx + (p_screen - p_world*scale) but easier with screen->svg: approximate
      const k = scale / oldScale;
      tx = (tx - 0) * k;
      ty = (ty - 0) * k;

      // fine adjust using screen center
      // Keep mid stable in screen coordinates:
      // Convert mid to SVG coords:
      const pt = svg.createSVGPoint(); pt.x = mid.x; pt.y = mid.y;
      const inv = svg.getScreenCTM().inverse();
      const midSvg = pt.matrixTransform(inv);
      // We want: midSvg = (p0*scale) + translate
      tx = midSvg.x - p0.x * scale;
      ty = midSvg.y - p0.y * scale;

      applyWorldTransform();
    }
  }, {passive:false});

  function endPointer(e){
    pointers.delete(e.pointerId);
    if(pointers.size === 0) gesture = null;
      }
  stageWrap.addEventListener('pointerup', endPointer, {passive:false});
  stageWrap.addEventListener('pointercancel', endPointer, {passive:false});

  stageWrap.addEventListener('click', ()=>{
    const now = Date.now();
    if(now-lastTap < 320){
      scale=1; tx=0; ty=0; applyWorldTransform();
    }
    lastTap = now;
  });

  // tap background deselect accessory
  stageWrap.addEventListener('pointerdown', (e)=>{
    if(e.target && e.target.closest && e.target.closest('[data-acc-id]')) return;
    setSelectedAcc(null);
  }, {passive:true});

  // ====== UI EVENTS ======
  bgColor.addEventListener('input', ()=>{ bgRect.setAttribute('fill', bgColor.value); });
  ringColor.addEventListener('input', ()=>{
    rings.forEach(r => r.color = ringColor.value);
    drawRings();
  });

  btnAddRing.addEventListener('click', ()=>{
    const last = rings[rings.length-1];
    const d = clamp((last?.d || 620) - 120, 180, 900);
    rings.push({ id:'ring'+(rings.length+1), d, color: ringColor.value, weave: ringWeave.value || 'classic' });
    selectedRingIndex = rings.length-1;
    ringSize.value = String(rings[selectedRingIndex].d);
    drawRings();
  });

  btnRemoveRing.addEventListener('click', ()=>{
    if(rings.length <= 1) return;
    rings.pop();
    selectedRingIndex = Math.min(selectedRingIndex, rings.length-1);
    ringSize.value = String(rings[selectedRingIndex].d);
    ringWeave.value = rings[selectedRingIndex].weave;
    drawRings();
  });

  ringSize.addEventListener('input', ()=>{
    const rg = rings[selectedRingIndex];
    if(!rg) return;
    rg.d = Number(ringSize.value);
    drawRings();
  });

  ringWeave.addEventListener('change', ()=>{
    const rg = rings[selectedRingIndex];
    if(!rg) return;
    rg.weave = ringWeave.value;
    drawRings();
  });

  palette.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-add]');
    if(!b) return;
    const type = b.dataset.add;
    const obj = {
      id: String(accIdC++),
      type,
      color: accColor.value,
      size: Number(accScale.value),
      rot: Number(accRot.value),
      x: CENTER.x,
      y: CENTER.y + 360
    };
    acc.push(obj);
    setSelectedAcc(obj.id);
    drawAccessories();
  });

  accColor.addEventListener('input', ()=>{
    const obj = acc.find(x=>x.id===selectedAccId);
    if(!obj) return;
    obj.color = accColor.value;
    selInfo.textContent = `Selezionato: ${niceType(obj.type)} ‚Ä¢ ${colorName(obj.color)} ‚Ä¢ size ${obj.size}`;
    drawAccessories();
  });

  accScale.addEventListener('input', ()=>{
    const obj = acc.find(x=>x.id===selectedAccId);
    if(!obj) return;
    obj.size = Number(accScale.value);
    selInfo.textContent = `Selezionato: ${niceType(obj.type)} ‚Ä¢ ${colorName(obj.color)} ‚Ä¢ size ${obj.size}`;
    drawAccessories();
  });

  accRot.addEventListener('input', ()=>{
    const obj = acc.find(x=>x.id===selectedAccId);
    if(!obj) return;
    obj.rot = Number(accRot.value);
    drawAccessories();
  });

  btnDelete.addEventListener('click', ()=>{
    if(!selectedAccId) return;
    acc = acc.filter(x=>x.id !== selectedAccId);
    setSelectedAcc(null);
    drawAccessories();
  });

  btnReset.addEventListener('click', ()=>{
    rings = [{ id:'ring1', d: 620, color: '#000000', weave: 'classic' }];
    selectedRingIndex = 0;
    acc = [];
    accIdC = 1;
    selectedAccId = null;

    bgColor.value = '#ffffff';
    ringColor.value = '#000000';
    ringSize.value = '620';
    ringWeave.value = 'classic';
    bgRect.setAttribute('fill', '#ffffff');
    scale=1; tx=0; ty=0; applyWorldTransform();

    drawRings();
    drawAccessories();
    setSelectedAcc(null);
  });

  // ====== EXPORT + WHATSAPP ======
  function buildSummary(){
    const ringLines = rings.map((r,i)=>`- Cerchio ${i+1}: diametro ${Math.round(r.d)} ‚Ä¢ colore ${colorName(r.color)} ‚Ä¢ tessitura ${niceWeave(r.weave)}`);
    const accLines = acc.map((a,i)=>`- ${niceType(a.type)} ‚Ä¢ colore ${colorName(a.color)} ‚Ä¢ dimensione ${Math.round(a.size)}`);
    const msg = [
      'üßø *Richiesta Acchiappasogni Personalizzato*',
      '',
      '*Cerchi:*',
      ...(ringLines.length? ringLines : ['- nessuno']),
      '',
      '*Accessori:*',
      ...(accLines.length? accLines : ['- nessuno']),
      '',
      `Sfondo: ${colorName(bgColor.value)}`,
      '',
      'üìå Ho allegato l‚Äôanteprima (immagine scaricata automaticamente).'
    ].join('\n');
    return msg;
  }
  function niceWeave(w){
    return ({classic:'Classica', spiral:'Spirale', chakra:'Chakra', star:'Stella', dense:'Fitta'}[w]) || w;
  }

  function downloadPreviewPng(){
    // Serialize SVG and render to canvas
    const xml = new XMLSerializer().serializeToString(svg);
    const svgBlob = new Blob([xml], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      canvas.width = 1000;
      canvas.height = 1600;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0);
      URL.revokeObjectURL(url);
      const pngUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = pngUrl;
      a.download = 'anteprima-acchiappasogni.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      alert('Impossibile generare l‚Äôanteprima immagine.');
    };
    img.src = url;
  }

  btnSend.addEventListener('click', ()=>{
    try{
      downloadPreviewPng();
      const text = buildSummary();
      const encoded = encodeURIComponent(text);
      const number = WHATSAPP_NUMBER.replace('+','');
      const wa = `https://wa.me/${number}?text=${encoded}`;
      window.open(wa, '_blank', 'noopener,noreferrer');
    }catch(e){
      console.error(e);
      alert('Errore invio WhatsApp');
    }
  });

  // ====== INIT ======
  bgRect.setAttribute('fill', bgColor.value);
  rings[0].color = ringColor.value;
  rings[0].weave = ringWeave.value;
  ringSize.value = String(rings[0].d);
  drawRings();
  drawAccessories();
  setSelectedAcc(null);
  applyWorldTransform();
})();
</script>
</body>
</html>
