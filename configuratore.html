<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Personalizzato ‚Äî Acchiappasogni di Erika</title>
  <style>
    :root{
      --bg:#0b1027;
      --card:#111a3f;
      --card2:#0f1636;
      --line:rgba(255,255,255,.10);
      --text:#eef2ff;
      --muted:#b9c3ff;
      --accent:#7c5cff;
      --accent2:#2dd4bf;
      --danger:#ff4d6d;
      --ok:#00e5a8;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --r2:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
        radial-gradient(1200px 900px at 110% 10%, rgba(45,212,191,.22), transparent 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
      touch-action: manipulation;
    }
    header{
      position:sticky; top:0; z-index:20;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(11,16,39,.92), rgba(11,16,39,.60));
      backdrop-filter: blur(12px);
    }
    .hrow{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    h1{margin:0; font-size:14px; font-weight:1000}
    .btn{
      border:none; cursor:pointer;
      padding:10px 12px; border-radius:12px;
      font-weight:1000; font-size:13px; color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      user-select:none;
      transition: transform .06s ease, background .15s ease;
      display:inline-flex; align-items:center; gap:8px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(45,212,191,.55));
      border-color: rgba(255,255,255,.16);
    }
    .btn.ok{ background: rgba(0,229,168,.12); border-color: rgba(0,229,168,.35); color:#c9fff2;}
    .btn.danger{ background: rgba(255,77,109,.12); border-color: rgba(255,77,109,.35); color:#ffd6de;}

    main{
      padding:12px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ main{grid-template-columns:1fr;} }
    .card{
      border:1px solid var(--line);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(17,26,63,.55), rgba(15,22,54,.55));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .head{padding:12px 12px 10px; border-bottom:1px solid var(--line); display:grid; gap:8px;}
    .head h2{margin:0; font-size:16px; font-weight:1000}
    .hint{margin:0; color:var(--muted); font-size:12px; line-height:1.35;}
    .body{padding:12px}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap;}
    .toolGroup{display:flex; gap:8px; flex-wrap:wrap; padding:8px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03);}
    .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center; font-size:12px; color:var(--muted);}

    .stage{
      width:100%;
      aspect-ratio: 1 / 1;
      position:relative;
      border-radius:22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(600px 600px at 50% 30%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(1000px 800px at 30% 90%, rgba(45,212,191,.10), transparent 55%),
        rgba(255,255,255,.03);
    }
    .stage svg{width:100%; height:100%; display:block; touch-action:none;}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; padding:10px 10px 0;}
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(124,92,255,.38), rgba(45,212,191,.18));
      color:var(--text);
      border-color: rgba(255,255,255,.18);
    }
    .section{display:none; gap:12px;}
    .section.active{display:grid;}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width: 520px){ .grid2{grid-template-columns:1fr;} }
    label{font-size:12px; color:var(--muted); font-weight:1000; display:flex; flex-direction:column; gap:6px;}
    input[type="number"], input[type="text"], select, input[type="color"]{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-weight:900;
      font-size:13px;
    }
    input[type="color"]{height:44px; padding:0;}
    .note{
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      color:var(--muted);
      background: rgba(255,255,255,.03);
      font-size:12px;
      line-height:1.35;
    }
    .selOutline{
      fill:none; stroke: rgba(124,92,255,.95);
      stroke-width:2.2; stroke-dasharray:5 4;
      pointer-events:none;
    }
  </style>
</head>

<body>
<header>
  <div class="hrow">
    <div>
      <h1>‚ú® Personalizzato ‚Äî Acchiappasogni di Erika</h1>
      <div style="font-size:12px;color:var(--muted);font-weight:900;margin-top:4px">
        Torna al catalogo ‚Ä¢ Salva progetto ‚Ä¢ Invia su WhatsApp
      </div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn" id="backToCatalog">‚¨ÖÔ∏è Catalogo</button>
      <button class="btn ok" id="btnSaveProject">üíæ Salva progetto</button>
      <button class="btn primary" id="btnInvia">üí¨ Invia WhatsApp</button>
    </div>
  </div>
</header>

<main>
  <section class="card">
    <div class="head">
      <h2>Anteprima</h2>
      <p class="hint">Tocca per selezionare ‚Ä¢ Trascina per spostare ‚Ä¢ (Fix mobile attivo)</p>

      <div class="toolbar">
        <div class="toolGroup">
          <button class="btn" id="btnCenter">üéØ Centro</button>
          <button class="btn danger" id="btnDelete">üóëÔ∏è Elimina</button>
        </div>
      </div>

      <div class="status">
        <span>Selezione: <b id="selName">nessuna</b></span>
      </div>
    </div>

    <div class="body">
      <div class="stage">
        <svg id="svg" viewBox="0 0 1000 1000" role="img" aria-label="Configuratore">
          <g id="scene">
            <g id="base"></g>
            <g id="acc"></g>
            <g id="ui"></g>
          </g>
        </svg>
      </div>
    </div>
  </section>

  <aside class="card">
    <div class="head">
      <h2>Controlli</h2>
      <p class="hint">Modello base (triplo) + colori.</p>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="modello">1) Modello</div>
      <div class="tab" data-tab="scritta">2) Scritta</div>
      <div class="tab" data-tab="salva">3) Salva</div>
    </div>

    <div class="body">
      <div class="section active" id="sec-modello">
        <div class="note">Scegli colori e applica.</div>
        <div class="grid2">
          <label>Colore cerchio <input type="color" id="ringColor" value="#b6936a"/></label>
          <label>Colore rete <input type="color" id="webColor" value="#f2f2f2"/></label>
        </div>
        <div class="grid2">
          <label>Perla centrale <input type="color" id="beadColor" value="#d7d7d7"/></label>
          <label>Numero piume <input type="number" id="feathers" min="0" max="12" step="1" value="6"/></label>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn ok" id="btnApply">‚ú® Applica</button>
          <button class="btn" id="btnReset">üîÑ Reset</button>
        </div>
      </div>

      <div class="section" id="sec-scritta">
        <div class="note">Aggiungi una scritta (nome/dedica).</div>
        <label>Testo <input type="text" id="txt" placeholder="Es: Merry Christmas / Nome..."/></label>
        <div class="grid2">
          <label>Colore <input type="color" id="txtColor" value="#ffd34d"/></label>
          <label>Dimensione <input type="number" id="txtSize" min="18" max="120" step="2" value="56"/></label>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn ok" id="btnAddText">‚úçÔ∏è Aggiungi</button>
          <button class="btn danger" id="btnRemoveText">üóëÔ∏è Rimuovi</button>
        </div>
      </div>

      <div class="section" id="sec-salva">
        <div class="note">Qui scegli titolo e descrizione del progetto.</div>
        <label>Titolo progetto <input type="text" id="pTitle" placeholder="Es: Natale Rosso"/></label>
        <label>Descrizione <input type="text" id="pDesc" placeholder="Es: Triplo, oro, piume bianche..."/></label>
      </div>
    </div>
  </aside>
</main>

<script>
/* ====== KEYS compatibili con HOME ====== */
const K = {
  projects: "ae_builder_projects_v1",
  wa: "ae_wa_number_v1"
};

const $ = (q)=>document.querySelector(q);

$("#backToCatalog").onclick = ()=> window.location.href = "index.html";

$("#tabs").addEventListener("click",(e)=>{
  const t = e.target.closest(".tab");
  if(!t) return;
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  t.classList.add("active");
  const key = t.dataset.tab;
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-"+key).classList.add("active");
});

function uid(prefix="x"){ return prefix+"_"+Math.random().toString(16).slice(2)+"_"+Date.now().toString(16); }

function svgEl(name, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", name);
  Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k,v));
  return el;
}
function clearNode(n){ while(n.firstChild) n.removeChild(n.firstChild); }

const svg = $("#svg");
const base = $("#base");
const acc = $("#acc");
const ui = $("#ui");

const state = {
  ringColor: $("#ringColor").value,
  webColor: $("#webColor").value,
  beadColor: $("#beadColor").value,
  feathers: parseInt($("#feathers").value,10),
  text: { on:false, value:"", color:"#ffd34d", size:56, x:500, y:130 },
  selected: null,
  acc: []
};

function build(){
  clearNode(base);
  clearNode(acc);
  clearNode(ui);

  const cX=500, cY=420;
  const bigR=260, smallR=110;

  // big ring
  base.appendChild(svgEl("circle",{cx:cX, cy:cY, r:bigR, fill:"none", stroke:state.ringColor, "stroke-width":"18", "data-type":"ring", "data-id":"big"}));
  // web simple
  for(let i=0;i<12;i++){
    const a = (Math.PI*2/12)*i - Math.PI/2;
    base.appendChild(svgEl("line",{x1:cX,y1:cY,x2:cX+Math.cos(a)*bigR,y2:cY+Math.sin(a)*bigR, stroke:state.webColor, "stroke-width":"2"}));
  }
  base.appendChild(svgEl("circle",{cx:cX, cy:cY, r:10, fill:state.beadColor}));

  // 2 small rings
  const sY = cY + bigR + 120;
  const s1X = cX - smallR - 45;
  const s2X = cX + smallR + 45;

  ["s1","s2"].forEach((id,idx)=>{
    const x = idx===0 ? s1X : s2X;
    base.appendChild(svgEl("circle",{cx:x, cy:sY, r:smallR, fill:"none", stroke:state.ringColor, "stroke-width":"18", "data-type":"ring", "data-id":id}));
    for(let i=0;i<10;i++){
      const a = (Math.PI*2/10)*i - Math.PI/2;
      base.appendChild(svgEl("line",{x1:x,y1:sY,x2:x+Math.cos(a)*smallR,y2:sY+Math.sin(a)*smallR, stroke:state.webColor, "stroke-width":"2"}));
    }
    base.appendChild(svgEl("circle",{cx:x, cy:sY, r:8, fill:state.beadColor}));
  });

  // feathers
  state.acc = [];
  const startX = 500 - 180;
  const y = sY + smallR + 60;
  for(let i=0;i<state.feathers;i++){
    const id = uid("f");
    state.acc.push({id, x:startX + i*65, y:y + Math.sin(i)*10});
  }
  state.acc.forEach(f=>{
    const g = svgEl("g", {"data-type":"acc","data-id":f.id, cursor:"grab"});
    g.setAttribute("transform", `translate(${f.x} ${f.y})`);
    g.appendChild(svgEl("path",{d:"M 0 0 C 40 -20 70 -5 90 10 C 70 25 40 35 0 18 Z", fill:"#ffffff", opacity:"0.92"}));
    acc.appendChild(g);
  });

  // text
  if(state.text.on && state.text.value){
    const t = svgEl("text", {
      x: state.text.x, y: state.text.y,
      "text-anchor":"middle", "dominant-baseline":"middle",
      fill: state.text.color, "font-size": state.text.size,
      "font-weight":"1000",
      "data-type":"text", "data-id":"mainText"
    });
    t.textContent = state.text.value;
    acc.appendChild(t);
  }

  renderSelection();
}

function renderSelection(){
  clearNode(ui);
  $("#selName").textContent = state.selected ? state.selected : "nessuna";
  if(!state.selected) return;

  if(state.selected==="text"){
    ui.appendChild(svgEl("rect",{x:260,y:80,width:480,height:120,rx:16,class:"selOutline"}));
    return;
  }
  const el = state.acc.find(x=>x.id===state.selected);
  if(el){
    ui.appendChild(svgEl("rect",{x:el.x-10,y:el.y-10,width:110,height:70,rx:16,class:"selOutline"}));
  }
}

/* ===== FIX TOUCH + DRAG ===== */
let drag=null;

function getPoint(evt){
  const pt = svg.createSVGPoint();
  pt.x = evt.clientX; pt.y = evt.clientY;
  const m = svg.getScreenCTM().inverse();
  return pt.matrixTransform(m);
}

svg.addEventListener("pointerdown",(e)=>{
  e.preventDefault(); // FIX MOBILE
  const t = e.target.closest("[data-type]");
  if(!t){ state.selected=null; renderSelection(); return; }

  const type = t.getAttribute("data-type");
  const id = t.getAttribute("data-id");

  if(type==="text"){ state.selected="text"; renderSelection(); drag={kind:"text", dx:0, dy:0}; return; }
  if(type==="acc"){
    state.selected=id;
    renderSelection();
    const p = getPoint(e);
    const el = state.acc.find(x=>x.id===id);
    if(el) drag={kind:"acc", id, ox: el.x - p.x, oy: el.y - p.y};
    return;
  }
  // ring selection only
  state.selected="ring:"+id;
  renderSelection();
});

svg.addEventListener("pointermove",(e)=>{
  if(!drag) return;
  const p = getPoint(e);
  if(drag.kind==="acc"){
    const el = state.acc.find(x=>x.id===drag.id);
    if(!el) return;
    el.x = p.x + drag.ox;
    el.y = p.y + drag.oy;
    build();
    state.selected = drag.id;
    renderSelection();
  }
  if(drag.kind==="text"){
    state.text.x = p.x;
    state.text.y = p.y;
    build();
    state.selected = "text";
    renderSelection();
  }
});

window.addEventListener("pointerup",()=> drag=null);

/* ===== BUTTONS ===== */
$("#btnApply").onclick = ()=>{
  state.ringColor = $("#ringColor").value;
  state.webColor = $("#webColor").value;
  state.beadColor = $("#beadColor").value;
  state.feathers = parseInt($("#feathers").value,10) || 0;
  build();
};
$("#btnReset").onclick = ()=>{
  $("#ringColor").value="#b6936a";
  $("#webColor").value="#f2f2f2";
  $("#beadColor").value="#d7d7d7";
  $("#feathers").value="6";
  state.text.on=false; state.text.value="";
  $("#txt").value="";
  build();
};

$("#btnAddText").onclick = ()=>{
  const v = ($("#txt").value||"").trim();
  state.text.on = true;
  state.text.value = v;
  state.text.color = $("#txtColor").value;
  state.text.size = parseInt($("#txtSize").value,10) || 56;
  build();
  state.selected="text";
  renderSelection();
};
$("#btnRemoveText").onclick = ()=>{
  state.text.on=false; state.text.value="";
  build();
  state.selected=null;
  renderSelection();
};

$("#btnCenter").onclick = ()=>{
  if(state.selected && state.selected.startsWith("f_")){
    const el = state.acc.find(x=>x.id===state.selected);
    if(el){ el.x=500; build(); state.selected=el.id; renderSelection(); }
  }
  if(state.selected==="text"){
    state.text.x=500; build(); state.selected="text"; renderSelection();
  }
};

$("#btnDelete").onclick = ()=>{
  if(!state.selected) return;
  if(state.selected==="text"){
    state.text.on=false; state.text.value=""; build(); state.selected=null; renderSelection(); return;
  }
  const idx = state.acc.findIndex(x=>x.id===state.selected);
  if(idx>=0){ state.acc.splice(idx,1); build(); state.selected=null; renderSelection(); }
};

/* ===== SAVE PROJECT (to HOME) ===== */
function loadProjects(){
  try{ return JSON.parse(localStorage.getItem(K.projects) || "[]"); }catch{ return []; }
}
function saveProjects(arr){
  localStorage.setItem(K.projects, JSON.stringify(arr));
}

function svgToPngDataURL(){
  const clone = svg.cloneNode(true);
  const xml = new XMLSerializer().serializeToString(clone);
  const svg64 = btoa(unescape(encodeURIComponent(xml)));
  const image64 = "data:image/svg+xml;base64," + svg64;

  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = ()=>{
      const c = document.createElement("canvas");
      c.width = 1200; c.height = 1200;
      const ctx = c.getContext("2d");
      ctx.drawImage(img,0,0,c.width,c.height);
      // jpeg pi√π leggero
      resolve(c.toDataURL("image/jpeg", 0.8));
    };
    img.src = image64;
  });
}

$("#btnSaveProject").onclick = async ()=>{
  const title = ($("#pTitle").value||"").trim() || "Progetto";
  const desc = ($("#pDesc").value||"").trim();

  const img = await svgToPngDataURL();
  const pr = { id: uid("pr"), title, desc, img, ts: Date.now() };

  const arr = loadProjects();
  arr.push(pr);
  saveProjects(arr);

  alert("Progetto salvato ‚úÖ Ora lo vedi in Home.");
};

$("#btnInvia").onclick = async ()=>{
  const num = (localStorage.getItem(K.wa)||"").replace(/\D/g,"");
  if(!num){ alert("Imposta il numero WhatsApp in Impostazioni (Home)."); return; }
  const title = ($("#pTitle").value||"").trim() || "Progetto";
  const desc = ($("#pDesc").value||"").trim();
  const msg = encodeURIComponent(`Ciao! üòä\nVorrei questo progetto personalizzato:\n- ${title}\n- ${desc}\nGrazie!`);
  window.open(`https://wa.me/${num}?text=${msg}`,"_blank");
};

/* INIT */
build();
</script>
</body>
</html>
