<!doctype html>
<html lang="it">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Configuratore Acchiappasogni</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#121826;
      --muted:#667085;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent2:#7c3aed;
      --shadow: 0 12px 40px rgba(17,24,39,.10);
      --radius:18px;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    html,body{height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg);}

    .app{max-width:1100px; margin:0 auto; padding:12px 12px calc(env(safe-area-inset-bottom) + 12px);}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 12px; background:linear-gradient(180deg,#ffffff, #f1f5ff); border:1px solid var(--border); border-radius:22px; box-shadow: 0 8px 24px rgba(17,24,39,.08); position:sticky; top:10px; z-index:20;}
    .title{font-weight:800; letter-spacing:-.02em; font-size:18px;}
    .sub{font-size:12px; color:var(--muted); margin-top:2px;}
    .titlewrap{display:flex; flex-direction:column;}
    .pill{border:1px solid var(--border); background:#fff; border-radius:999px; padding:10px 14px; font-weight:700; color:var(--muted);}

    .grid{display:grid; gap:12px; grid-template-columns: 1fr; margin-top:12px;}
    @media (min-width: 920px){
      .grid{grid-template-columns: 1.3fr .7fr;}
    }

    .card{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow: var(--shadow); overflow:hidden;}
    .cardhd{padding:12px 14px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .cardhd b{font-size:14px;}
    .cardhd span{font-size:12px; color:var(--muted);}

    .stageWrap{position:relative; width:100%; height: min(62vh, 640px); background:#fff;}
    .stageWrap:before{content:""; position:absolute; inset:0; background: radial-gradient(circle at 20% 10%, rgba(37,99,235,.06), transparent 40%), radial-gradient(circle at 80% 20%, rgba(124,58,237,.06), transparent 40%); pointer-events:none;}

    .stage{
      position:absolute; inset:0;
      touch-action:none; /* we handle pan/pinch */
    }

    .hud{
      position:absolute; left:12px; top:12px; z-index:5;
      display:flex; flex-direction:column; gap:10px;
    }
    .hudBtn{width:44px; height:44px; border-radius:14px; border:1px solid var(--border); background:#fff; display:grid; place-items:center; box-shadow: 0 8px 22px rgba(17,24,39,.12);}
    .hudBtn:active{transform:scale(.98)}

    .hudRight{position:absolute; right:12px; top:12px; z-index:5; display:flex; flex-direction:column; gap:10px; align-items:flex-end;}
    .miniPreview{width:78px; height:78px; border-radius:18px; border:1px solid var(--border); background:#fff; box-shadow: 0 10px 28px rgba(17,24,39,.12); overflow:hidden;}

    .status{position:absolute; left:50%; top:14px; transform:translateX(-50%); z-index:6; display:flex; gap:6px; align-items:center;}
    .dot{width:10px; height:10px; border-radius:999px; border:1px solid var(--border); background:#fff;}
    .dot.on{background:linear-gradient(180deg, var(--accent), var(--accent2)); border-color:transparent;}

    /* Bottom panel */
    .panel{position:sticky; bottom:0; z-index:30; margin-top:12px;}
    .panelInner{background:rgba(255,255,255,.92); backdrop-filter: blur(14px); border:1px solid var(--border); border-radius:22px; box-shadow: 0 18px 60px rgba(17,24,39,.18); overflow:hidden;}
    .tabbar{display:flex; gap:6px; padding:10px; border-bottom:1px solid var(--border);}
    .tab{flex:1; padding:10px 10px; border-radius:14px; border:1px solid var(--border); background:#fff; font-weight:800; font-size:13px; color:var(--muted);}
    .tab.active{background:linear-gradient(180deg, #eaf2ff, #ffffff); color:var(--text); border-color: rgba(37,99,235,.25);}
    .tab:active{transform:scale(.99)}

    .tabContent{padding:12px; max-height: 36vh; overflow:auto;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .field{display:flex; flex-direction:column; gap:6px; min-width: 160px; flex:1;}
    label{font-size:12px; color:var(--muted); font-weight:700;}
    input[type="text"], input[type="number"], select{height:42px; border-radius:14px; border:1px solid var(--border); padding:0 12px; font-weight:700; background:#fff;}
    input[type="range"]{width:100%;}

    .btn{height:42px; padding:0 14px; border-radius:14px; border:1px solid var(--border); background:#fff; font-weight:900;}
    .btn.primary{border-color:rgba(37,99,235,.35); background:linear-gradient(180deg,#eaf2ff,#fff);}
    .btn.danger{border-color:rgba(239,68,68,.35); background:linear-gradient(180deg,#ffecec,#fff);}

    .help{font-size:12px; color:var(--muted); line-height:1.4;}

    .palette{display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px;}
    @media (min-width: 560px){ .palette{grid-template-columns: repeat(6, minmax(0, 1fr));} }

    .item{border:1px solid var(--border); border-radius:16px; background:#fff; padding:10px; display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center; box-shadow: 0 10px 24px rgba(17,24,39,.08); user-select:none; touch-action:none;}
    .item:active{transform:scale(.98)}
    .item small{font-size:11px; color:var(--muted); font-weight:800; text-align:center;}
    .swatches{display:flex; gap:8px; flex-wrap:wrap;}
    .sw{width:26px; height:18px; border-radius:999px; border:1px solid var(--border); box-shadow: inset 0 0 0 2px rgba(255,255,255,.55);}
    .sw:active{transform:scale(.97)}

    .divider{height:1px; background:var(--border); margin:12px 0;}

    .kpi{display:flex; gap:10px; flex-wrap:wrap;}
    .chip{padding:10px 12px; border-radius:999px; border:1px solid var(--border); background:#fff; font-weight:800; color:var(--muted);}

    .ghost{opacity:.55}
  </style>
 </head>
 <body>
  <div class="app">
   <div class="topbar">
    <div class="titlewrap">
     <div class="title">Personalizza il tuo Acchiappasogni</div>
     <div class="sub">Trascina gli accessori nell‚Äôanteprima. Pinch per zoom, 1 dito per spostare.</div>
    </div>
    <button class="pill" id="btnClose" type="button">‚úï Chiudi</button>
   </div>
   <div class="grid">
    <!-- Stage -->
    <div class="card">
     <div class="cardhd">
      <div>
       <b>Anteprima</b> <span> (tocca per selezionare ‚Ä¢ trascina per spostare)</span>
      </div>
      <div class="row">
       <button class="btn" id="btnCenter" type="button">Centra</button>
       <button class="btn danger" id="btnReset" type="button">Reset</button>
      </div>
     </div>
     <div class="stageWrap" id="stageWrap">
      <div class="hud">
       <button class="hudBtn" id="btnZoomIn" title="Zoom +" type="button">Ôºã</button>
       <button class="hudBtn" id="btnZoomOut" title="Zoom -" type="button">Ôºç</button>
       <button class="hudBtn" id="btnDelete" title="Rimuovi selezionato" type="button">üóë</button>
      </div>
      <div class="hudRight">
       <div class="miniPreview" id="miniPreview"></div>
       <div class="kpi">
        <span class="chip" id="kpiRings">Cerchi: 1</span> <span class="chip" id="kpiItems">Accessori: 0</span>
       </div>
      </div>
      <div class="status" id="statusDots">
       <div class="dot on"></div>
       <div class="dot"></div>
       <div class="dot"></div>
       <div class="dot"></div>
      </div>
      <svg class="stage" id="svg" viewBox="0 0 1000 1000" aria-label="Stage">
       <defs>
        <filter id="selGlow" x="-50%" y="-50%" width="200%" height="200%">
         <feDropShadow dx="0" dy="0" stdDeviation="6" flood-color="#7c3aed" flood-opacity="0.65" />
        </filter>
       </defs>
       <!-- viewport group: all transforms go here so EVERYTHING zooms together -->
       <g id="viewport">
        <rect x="0" y="0" width="1000" height="1000" fill="#ffffff" /> <!-- faint guides -->
        <g opacity="0.10" stroke="#111827" stroke-width="2">
         <circle cx="500" cy="500" r="80" fill="none" /> <circle cx="500" cy="500" r="160" fill="none" /> <circle cx="500" cy="500" r="240" fill="none" /> <circle cx="500" cy="500" r="320" fill="none" /> <line x1="500" y1="120" x2="500" y2="880" /> <line x1="120" y1="500" x2="880" y2="500" />
        </g>
        <g id="rings"></g> <g id="weaves"></g> <g id="items"></g>
       </g>
      </svg>
     </div>
    </div>
    <!-- Quick panel (desktop) -->
    <div class="card" id="rightCard">
     <div class="cardhd">
      <div>
       <b>Scelte rapide</b> <span> (1 tocco)</span>
      </div>
     </div>
     <div class="tabContent">
      <div class="row">
       <button class="btn primary" type="button" data-preset="classic">Viola classico</button>
       <button class="btn" type="button" data-preset="gold">Oro &amp; bianco</button>
       <button class="btn" type="button" data-preset="forest">Verde bosco</button>
       <button class="btn" type="button" data-preset="multi">Arcobaleno</button>
      </div>
      <div class="divider"></div>
      <div class="help">Suggerimento: per aggiungere un accessorio trascinalo dall‚Äôelenco ‚ÄúAccessori‚Äù. Per cambiare colore, selezionalo e usa le palette sotto.</div>
     </div>
    </div>
   </div>
   <!-- Bottom control panel -->
   <div class="panel">
    <div class="panelInner">
     <div class="tabbar" id="tabbar">
      <button class="tab active" data-tab="base" type="button">Base</button>
      <button class="tab" data-tab="accessori" type="button">Accessori</button>
      <button class="tab" data-tab="tessiture" type="button">Tessiture</button>
      <button class="tab" data-tab="testo" type="button">Testo</button>
      <button class="tab" data-tab="invio" type="button">Invio</button>
     </div>
     <div class="tabContent" id="tab_base">
      <div class="row">
       <div class="field">
        <label>Cerchio selezionato</label> <select id="selRing"></select>
       </div>
       <div class="field">
        <label>Diametro (cm) (solo informativo)</label> <input id="diamCm" type="number" min="10" max="120" value="30">
       </div>
      </div>
      <div class="divider"></div>
      <div class="row">
       <div class="field">
        <label>Spessore cerchio</label> <input id="ringStroke" type="range" min="6" max="40" value="18">
       </div>
       <div class="field">
        <label>Raggio cerchio</label> <input id="ringRadius" type="range" min="160" max="420" value="360">
       </div>
      </div>
      <div class="divider"></div>
      <div class="row">
       <button class="btn primary" id="btnAddRing" type="button">Ôºã Aggiungi cerchio</button>
       <button class="btn" id="btnRemoveRing" type="button">Ôºç Rimuovi cerchio</button>
      </div>
      <div class="divider"></div>
      <div>
       <label>Colore cerchio</label>
       <div class="swatches" id="swRing"></div>
      </div>
      <div class="help" style="margin-top:10px;">Nota: lo zoom applica l‚Äôanteprima intera (cerchi + accessori), come un vero configuratore.</div>
     </div>
     <div class="tabContent" id="tab_accessori" style="display:none;">
      <div class="help">Trascina un accessorio nell‚Äôanteprima. Toccane uno nell‚Äôanteprima per selezionarlo (bordo viola). Poi puoi cambiare colore/rotazione/dimensione.</div>
      <div class="divider"></div>
      <div class="palette" id="palette"></div>
      <div class="divider"></div>
      <div class="row">
       <div class="field">
        <label>Dimensione accessorio (selezionato)</label> <input id="itemScale" type="range" min="0.4" max="2.4" step="0.05" value="1">
       </div>
       <div class="field">
        <label>Rotazione (¬∞)</label> <input id="itemRot" type="range" min="-180" max="180" step="1" value="0">
       </div>
      </div>
      <div class="divider"></div>
      <div>
       <label>Colore accessorio (selezionato)</label>
       <div class="swatches" id="swItem"></div>
      </div>
     </div>
     <div class="tabContent" id="tab_tessiture" style="display:none;">
      <div class="row">
       <div class="field">
        <label>Tipo tessitura (sul cerchio selezionato)</label> <select id="selWeave"> <option value="none">Nessuna</option> <option value="web">Ragnatela semplice</option> <option value="star">Stella</option> <option value="double">Doppia stella</option> </select>
       </div>
       <div class="field">
        <label>Intensit√† (linee)</label> <input id="weaveStrength" type="range" min="0" max="100" value="70">
       </div>
      </div>
      <div class="divider"></div>
      <div>
       <label>Colore tessitura</label>
       <div class="swatches" id="swWeave"></div>
      </div>
      <div class="divider"></div>
      <div class="help">Catene: aggiungi ‚Äúpendenti‚Äù trascinando cristalli / lune / stelle e posizionandoli sotto al cerchio. (Prossimo step: agganci automatici in basso ai punti del cerchio).</div>
     </div>
     <div class="tabContent" id="tab_testo" style="display:none;">
      <div class="row">
       <div class="field" style="min-width: 220px;">
        <label>Nome / dedica (opzionale)</label> <input id="txtDedica" type="text" placeholder="Es. Per Erika">
       </div>
       <div class="field">
        <label>Note (opzionale)</label> <input id="txtNote" type="text" placeholder="Es. con cristalli viola e luna">
       </div>
      </div>
      <div class="divider"></div>
      <div class="help">Il testo verr√† inserito nel messaggio WhatsApp nella sezione ‚ÄúInvio‚Äù.</div>
     </div>
     <div class="tabContent" id="tab_invio" style="display:none;">
      <div class="row">
       <div class="field">
        <label>Numero WhatsApp (con +39...)</label> <input id="waNumber" type="text" value="" placeholder="+39XXXXXXXXXX">
       </div>
       <button class="btn primary" id="btnWa" type="button">Apri WhatsApp</button>
      </div>
      <div class="divider"></div>
      <div class="row">
       <button class="btn" id="btnCopy" type="button">Copia riepilogo</button>
       <button class="btn" id="btnExport" type="button">Esporta immagine (PNG)</button>
      </div>
      <div class="divider"></div>
      <div class="help">
       <b>Importante:</b> WhatsApp dal browser non permette allegare automaticamente l‚Äôimmagine. Premi ‚ÄúEsporta immagine‚Äù, salva e poi inviala su WhatsApp. In alternativa fai uno screenshot dell‚Äôanteprima.
      </div>
      <div class="divider"></div>
      <pre id="summary" style="white-space:pre-wrap; font-size:12px; color:#0f172a; background:#f8fafc; border:1px solid var(--border); padding:12px; border-radius:16px; margin:0;"></pre>
     </div>
    </div>
   </div>
  </div>
  <script>
(() => {
  // ---------- State ----------
  const state = {
    view: { x:0, y:0, scale:1 },
    pointers: new Map(),
    pinch: null,
    rings: [],
    selectedRingId: null,
    items: [],
    selectedItemId: null,
    weaveByRing: new Map(),
    colors: {
      ring: '#111827',
      weave: '#111827',
      item: '#111827'
    }
  };

  const COLORS = [
    '#111827','#334155','#94a3b8','#ffffff',
    '#ef4444','#f97316','#eab308','#22c55e',
    '#06b6d4','#3b82f6','#7c3aed','#ec4899',
    '#a855f7','#14b8a6','#0ea5e9','#f59e0b'
  ];

  // ---------- DOM ----------
  const svg = document.getElementById('svg');
  const viewport = document.getElementById('viewport');
  const gRings = document.getElementById('rings');
  const gWeaves = document.getElementById('weaves');
  const gItems = document.getElementById('items');
  const miniPreview = document.getElementById('miniPreview');

  const kpiRings = document.getElementById('kpiRings');
  const kpiItems = document.getElementById('kpiItems');

  const tabbar = document.getElementById('tabbar');
  const tabs = Array.from(tabbar.querySelectorAll('.tab'));
  const tabPanels = {
    base: document.getElementById('tab_base'),
    accessori: document.getElementById('tab_accessori'),
    tessiture: document.getElementById('tab_tessiture'),
    testo: document.getElementById('tab_testo'),
    invio: document.getElementById('tab_invio'),
  };

  const selRing = document.getElementById('selRing');
  const ringStroke = document.getElementById('ringStroke');
  const ringRadius = document.getElementById('ringRadius');
  const diamCm = document.getElementById('diamCm');

  const btnAddRing = document.getElementById('btnAddRing');
  const btnRemoveRing = document.getElementById('btnRemoveRing');

  const swRing = document.getElementById('swRing');
  const swWeave = document.getElementById('swWeave');
  const swItem = document.getElementById('swItem');

  const palette = document.getElementById('palette');
  const itemScale = document.getElementById('itemScale');
  const itemRot = document.getElementById('itemRot');

  const selWeave = document.getElementById('selWeave');
  const weaveStrength = document.getElementById('weaveStrength');

  const txtDedica = document.getElementById('txtDedica');
  const txtNote = document.getElementById('txtNote');
  const waNumber = document.getElementById('waNumber');
  const btnWa = document.getElementById('btnWa');
  const btnCopy = document.getElementById('btnCopy');
  const btnExport = document.getElementById('btnExport');
  const summaryEl = document.getElementById('summary');

  // HUD buttons
  document.getElementById('btnZoomIn').addEventListener('click', () => zoomAt(500,500, 1.15));
  document.getElementById('btnZoomOut').addEventListener('click', () => zoomAt(500,500, 1/1.15));
  document.getElementById('btnCenter').addEventListener('click', centerView);
  document.getElementById('btnReset').addEventListener('click', resetAll);
  document.getElementById('btnDelete').addEventListener('click', deleteSelected);
  document.getElementById('btnClose').addEventListener('click', () => alert('Chiudi: qui puoi tornare al resto dell\'app (se integrata).'));

  // Presets
  document.querySelectorAll('[data-preset]').forEach(b => {
    b.addEventListener('click', () => applyPreset(b.dataset.preset));
  });

  // ---------- Helpers ----------
  const NS = 'http://www.w3.org/2000/svg';
  const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function setViewportTransform(){
    const {x,y,scale} = state.view;
    viewport.setAttribute('transform', `translate(${x} ${y}) scale(${scale})`);
  }

  function svgPointFromClient(clientX, clientY){
    const pt = svg.createSVGPoint();
    pt.x = clientX; pt.y = clientY;
    const ctm = svg.getScreenCTM();
    if(!ctm) return {x:500,y:500};
    const inv = ctm.inverse();
    const p = pt.matrixTransform(inv);
    // Now reverse viewport transform
    const {x,y,scale} = state.view;
    return { x: (p.x - x)/scale, y: (p.y - y)/scale };
  }

  function zoomAt(cx, cy, factor){
    const old = state.view.scale;
    const next = clamp(old * factor, 0.6, 3.0);
    factor = next / old;
    // keep (cx,cy) stable in viewport coords
    state.view.x = cx - factor*(cx - state.view.x);
    state.view.y = cy - factor*(cy - state.view.y);
    state.view.scale = next;
    setViewportTransform();
  }

  function centerView(){
    state.view = {x:0,y:0,scale:1};
    setViewportTransform();
  }

  // ---------- Rings + Weaves ----------
  function addRing({radius=360, stroke=18, color='#111827'} = {}){
    if(state.rings.length >= 3) return;
    const id = uid();
    state.rings.push({id, radius, stroke, color});
    state.selectedRingId = id;
    renderRings();
    syncRingUI();
    renderWeave();
    updateKPIs();
  }

  function removeRing(){
    if(state.rings.length <= 1) return;
    const id = state.selectedRingId;
    state.rings = state.rings.filter(r => r.id !== id);
    state.weaveByRing.delete(id);
    state.selectedRingId = state.rings[0].id;
    renderRings();
    syncRingUI();
    renderWeave();
    updateKPIs();
  }

  function renderRings(){
    gRings.innerHTML = '';
    for(const r of state.rings){
      const c = document.createElementNS(NS,'circle');
      c.setAttribute('cx','500');
      c.setAttribute('cy','500');
      c.setAttribute('r', String(r.radius));
      c.setAttribute('fill','none');
      c.setAttribute('stroke', r.color);
      c.setAttribute('stroke-width', String(r.stroke));
      c.setAttribute('opacity','0.92');
      c.dataset.ringId = r.id;
      c.style.cursor = 'pointer';
      c.addEventListener('pointerdown', (e) => {
        e.stopPropagation();
        selectRing(r.id);
      });
      if(r.id === state.selectedRingId){
        const glow = document.createElementNS(NS,'circle');
        glow.setAttribute('cx','500'); glow.setAttribute('cy','500'); glow.setAttribute('r', String(r.radius));
        glow.setAttribute('fill','none'); glow.setAttribute('stroke', '#7c3aed'); glow.setAttribute('stroke-width', String(r.stroke+6));
        glow.setAttribute('opacity','0.20');
        gRings.appendChild(glow);
      }
      gRings.appendChild(c);
    }
    updateMiniPreview();
  }

  function selectRing(id){
    state.selectedRingId = id;
    renderRings();
    syncRingUI();
    renderWeave();
  }

  function syncRingUI(){
    selRing.innerHTML = '';
    state.rings.forEach((r, idx) => {
      const o = document.createElement('option');
      o.value = r.id;
      o.textContent = `Cerchio ${idx+1}`;
      selRing.appendChild(o);
    });
    selRing.value = state.selectedRingId;
    const r = state.rings.find(x => x.id === state.selectedRingId);
    if(!r) return;
    ringStroke.value = r.stroke;
    ringRadius.value = r.radius;
    // set ring color palette selection
    state.colors.ring = r.color;
  }

  function renderWeave(){
    gWeaves.innerHTML = '';
    const ring = state.rings.find(r => r.id === state.selectedRingId);
    if(!ring) return;

    const weave = state.weaveByRing.get(ring.id) || {type:'none', color:'#111827', strength:70};
    state.weaveByRing.set(ring.id, weave);

    selWeave.value = weave.type;
    weaveStrength.value = weave.strength;
    state.colors.weave = weave.color;

    if(weave.type === 'none') return;

    const opacity = clamp(weave.strength/100, 0.05, 1);
    const stroke = weave.color;

    const lines = [];
    const n = 8;
    const r = ring.radius - ring.stroke*0.7;
    const cx=500, cy=500;

    const pts = [];
    for(let i=0;i<n;i++){
      const a = (Math.PI*2*i)/n - Math.PI/2;
      pts.push({x: cx + r*Math.cos(a), y: cy + r*Math.sin(a)});
    }

    if(weave.type === 'web'){
      // spokes
      for(const p of pts){ lines.push([ {x:cx,y:cy}, p ]); }
      // rings
      for(let k=1;k<=4;k++){
        const rr = (r*k)/4;
        for(let i=0;i<n;i++){
          const a1 = (Math.PI*2*i)/n - Math.PI/2;
          const a2 = (Math.PI*2*(i+1))/n - Math.PI/2;
          lines.push([
            {x: cx + rr*Math.cos(a1), y: cy + rr*Math.sin(a1)},
            {x: cx + rr*Math.cos(a2), y: cy + rr*Math.sin(a2)},
          ]);
        }
      }
    } else if(weave.type === 'star'){
      // connect every 2
      for(let i=0;i<n;i++){
        lines.push([pts[i], pts[(i+2)%n]]);
      }
    } else if(weave.type === 'double'){
      for(let i=0;i<n;i++){
        lines.push([pts[i], pts[(i+2)%n]]);
        lines.push([pts[i], pts[(i+3)%n]]);
      }
    }

    for(const seg of lines){
      const l = document.createElementNS(NS,'line');
      l.setAttribute('x1', seg[0].x); l.setAttribute('y1', seg[0].y);
      l.setAttribute('x2', seg[1].x); l.setAttribute('y2', seg[1].y);
      l.setAttribute('stroke', stroke);
      l.setAttribute('stroke-width', '2.5');
      l.setAttribute('opacity', String(0.28*opacity));
      l.setAttribute('stroke-linecap','round');
      gWeaves.appendChild(l);
    }
  }

  // ---------- Accessories ----------
  const ACCESSORIES = [
    { key:'feather', name:'Piuma', kind:'path', viewBox:'0 0 64 64', path:'M50 10c-8 2-18 10-26 18C13 39 12 53 12 53s14-1 25-12c8-8 16-18 18-26-2 0-3 0-5 1zM21 43c8-3 18-13 25-21' },
    { key:'moon', name:'Luna', kind:'path', viewBox:'0 0 64 64', path:'M41 12c-9 1-16 9-16 19s7 18 16 19c-12 3-25-6-25-19S29 9 41 12z' },
    { key:'star', name:'Stella', kind:'path', viewBox:'0 0 64 64', path:'M32 6l7 18 19 1-15 12 5 19-16-10-16 10 5-19-15-12 19-1z' },
    { key:'heart', name:'Cuore', kind:'path', viewBox:'0 0 64 64', path:'M32 54C14 40 8 31 8 22c0-7 5-12 12-12 5 0 9 3 12 7 3-4 7-7 12-7 7 0 12 5 12 12 0 9-6 18-24 32z' },
    { key:'crystal', name:'Cristallo', kind:'path', viewBox:'0 0 64 64', path:'M32 6l14 12-6 38H24L18 18 32 6zm0 0L24 56m8-50L40 56' },
    { key:'butterfly', name:'Farfalla', kind:'path', viewBox:'0 0 64 64', path:'M32 30c-4-8-14-16-18-10-4 6 2 18 12 16-8 6-18 6-18-2 0-10 14-16 24-4zm0 0c4-8 14-16 18-10 4 6-2 18-12 16 8 6 18 6 18-2 0-10-14-16-24-4zm0 0c0 10-2 16-4 22m4-22c0 10 2 16 4 22' },
    { key:'rose', name:'Rosa', kind:'path', viewBox:'0 0 64 64', path:'M32 54c10-6 16-14 16-22 0-10-8-18-16-18s-16 8-16 18c0 8 6 16 16 22zm0-28c4 0 6 2 6 6s-2 6-6 6-6-2-6-6 2-6 6-6z' },
    { key:'sun', name:'Sole', kind:'path', viewBox:'0 0 64 64', path:'M32 18a14 14 0 100 28 14 14 0 000-28zm0-12v8m0 44v-8M6 32h8m36 0h8M12 12l6 6m34 34l-6-6M52 12l-6 6M18 46l-6 6' },
    { key:'ring', name:'Anello', kind:'path', viewBox:'0 0 64 64', path:'M32 10a22 22 0 100 44 22 22 0 000-44zm0 10a12 12 0 100 24 12 12 0 000-24z' },
    { key:'drop', name:'Goccia', kind:'path', viewBox:'0 0 64 64', path:'M32 6c10 14 18 24 18 34a18 18 0 11-36 0c0-10 8-20 18-34z' },
  ];

  function makeAccessoryIcon(acc, size=34, color='#111827'){
    const svgEl = document.createElementNS(NS,'svg');
    svgEl.setAttribute('viewBox', acc.viewBox);
    svgEl.setAttribute('width', String(size));
    svgEl.setAttribute('height', String(size));
    svgEl.style.display = 'block';
    const p = document.createElementNS(NS,'path');
    p.setAttribute('d', acc.path);
    p.setAttribute('fill','none');
    p.setAttribute('stroke', color);
    p.setAttribute('stroke-width','3');
    p.setAttribute('stroke-linecap','round');
    p.setAttribute('stroke-linejoin','round');
    // some icons should be filled
    if(['heart','drop'].includes(acc.key)){
      p.setAttribute('fill', color);
      p.setAttribute('stroke','none');
    }
    svgEl.appendChild(p);
    return svgEl;
  }

  function buildPalette(){
    palette.innerHTML='';
    for(const acc of ACCESSORIES){
      const div = document.createElement('div');
      div.className='item';
      div.dataset.acc = acc.key;
      div.appendChild(makeAccessoryIcon(acc, 38, '#111827'));
      const s = document.createElement('small');
      s.textContent = acc.name;
      div.appendChild(s);
      // drag-create
      div.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        div.setPointerCapture(e.pointerId);
        const start = {x:e.clientX,y:e.clientY};
        let createdId = null;
        const move = (ev) => {
          if(!createdId){
            // create when user moves a bit
            const dx = ev.clientX-start.x, dy = ev.clientY-start.y;
            if(Math.hypot(dx,dy) > 8){
              const p = svgPointFromClient(ev.clientX, ev.clientY);
              createdId = addItem(acc.key, p.x, p.y);
              selectItem(createdId);
            }
          } else {
            const p = svgPointFromClient(ev.clientX, ev.clientY);
            moveItem(createdId, p.x, p.y);
          }
        };
        const up = (ev) => {
          div.removeEventListener('pointermove', move);
          div.removeEventListener('pointerup', up);
          div.removeEventListener('pointercancel', up);
        };
        div.addEventListener('pointermove', move);
        div.addEventListener('pointerup', up);
        div.addEventListener('pointercancel', up);
      }, {passive:false});

      // tap to add center
      div.addEventListener('click', () => {
        const id = addItem(acc.key, 500, 500);
        selectItem(id);
      });

      palette.appendChild(div);
    }
  }

  function addItem(key, x, y){
    const id = uid();
    const acc = ACCESSORIES.find(a=>a.key===key);
    const item = {id, key, x, y, scale:1, rot:0, color:'#111827'};
    state.items.push(item);
    const g = document.createElementNS(NS,'g');
    g.dataset.itemId = id;
    g.setAttribute('transform', `translate(${x} ${y}) rotate(0) scale(1)`);
    g.style.cursor='grab';

    const icon = makeAccessoryIcon(acc, 70, item.color);
    // center it
    icon.setAttribute('x', '-35');
    icon.setAttribute('y', '-35');
    icon.style.overflow='visible';

    // wrapper rect for easier touch
    const hit = document.createElementNS(NS,'rect');
    hit.setAttribute('x','-46');
    hit.setAttribute('y','-46');
    hit.setAttribute('width','92');
    hit.setAttribute('height','92');
    hit.setAttribute('rx','18');
    hit.setAttribute('fill','rgba(0,0,0,0)');

    g.appendChild(hit);
    g.appendChild(icon);

    // interactions
    g.addEventListener('pointerdown', (e) => {
      e.stopPropagation();
      selectItem(id);
      g.setPointerCapture(e.pointerId);
      const start = svgPointFromClient(e.clientX, e.clientY);
      const it = state.items.find(i=>i.id===id);
      const ox = it.x, oy = it.y;
      const move = (ev) => {
        const p = svgPointFromClient(ev.clientX, ev.clientY);
        moveItem(id, ox + (p.x-start.x), oy + (p.y-start.y));
      };
      const up = () => {
        g.removeEventListener('pointermove', move);
        g.removeEventListener('pointerup', up);
        g.removeEventListener('pointercancel', up);
      };
      g.addEventListener('pointermove', move);
      g.addEventListener('pointerup', up);
      g.addEventListener('pointercancel', up);
    });

    gItems.appendChild(g);
    updateKPIs();
    updateMiniPreview();
    updateSummary();
    return id;
  }

  function moveItem(id, x, y){
    const it = state.items.find(i=>i.id===id);
    if(!it) return;
    it.x=x; it.y=y;
    const g = gItems.querySelector(`[data-item-id="${id}"]`);
    if(g) g.setAttribute('transform', `translate(${it.x} ${it.y}) rotate(${it.rot}) scale(${it.scale})`);
    updateMiniPreview();
    updateSummary();
  }

  function selectItem(id){
    state.selectedItemId = id;
    for(const g of gItems.querySelectorAll('g[data-item-id]')){
      const isSel = g.dataset.itemId === id;
      g.style.filter = isSel ? 'url(#selGlow)' : 'none';
      g.style.opacity = isSel ? '1' : '0.95';
    }
    const it = state.items.find(i=>i.id===id);
    if(it){
      itemScale.value = it.scale;
      itemRot.value = it.rot;
      state.colors.item = it.color;
    }
    updateSummary();
  }

  function deleteSelected(){
    if(state.selectedItemId){
      const id = state.selectedItemId;
      state.items = state.items.filter(i=>i.id!==id);
      const g = gItems.querySelector(`[data-item-id="${id}"]`);
      if(g) g.remove();
      state.selectedItemId = null;
      updateKPIs();
      updateMiniPreview();
      updateSummary();
      return;
    }
    // if no item selected: delete ring? no.
  }

  // ---------- Mini preview ----------
  function updateMiniPreview(){
    // clone svg and scale down
    const clone = svg.cloneNode(true);
    clone.removeAttribute('class');
    clone.setAttribute('width','78');
    clone.setAttribute('height','78');
    clone.style.width='78px'; clone.style.height='78px';
    // tighten viewBox
    clone.setAttribute('viewBox','250 250 500 500');
    miniPreview.innerHTML='';
    miniPreview.appendChild(clone);
  }

  // ---------- Bottom palettes ----------
  function buildSwatches(container, onPick){
    container.innerHTML='';
    for(const c of COLORS){
      const b = document.createElement('button');
      b.type='button';
      b.className='sw';
      b.style.background = c;
      b.addEventListener('click', () => onPick(c));
      container.appendChild(b);
    }
  }

  // ---------- Tabs ----------
  function setTab(name){
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab===name));
    Object.entries(tabPanels).forEach(([k,el]) => el.style.display = (k===name) ? 'block' : 'none');
  }
  tabbar.addEventListener('click', (e) => {
    const b = e.target.closest('.tab');
    if(!b) return;
    setTab(b.dataset.tab);
  });

  // ---------- Stage pan/pinch ----------
  svg.addEventListener('pointerdown', (e) => {
    // deselect if tap empty
    if(e.target === svg){ state.selectedItemId = null; selectItem(''); }
    svg.setPointerCapture(e.pointerId);
    state.pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

    if(state.pointers.size === 1){
      const p = state.pointers.values().next().value;
      state.pinch = { mode:'pan', startX:p.x, startY:p.y, ox: state.view.x, oy: state.view.y };
    } else if(state.pointers.size === 2){
      const pts = Array.from(state.pointers.values());
      const d0 = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      const mid = {x:(pts[0].x+pts[1].x)/2, y:(pts[0].y+pts[1].y)/2};
      const svgMid = svgPointFromClient(mid.x, mid.y);
      state.pinch = { mode:'pinch', d0, s0: state.view.scale, x0: state.view.x, y0: state.view.y, midClient:mid, midSvg: svgMid };
    }
  }, {passive:false});

  svg.addEventListener('pointermove', (e) => {
    if(!state.pointers.has(e.pointerId)) return;
    state.pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});
    if(!state.pinch) return;

    if(state.pointers.size === 1 && state.pinch.mode==='pan'){
      const p = state.pointers.values().next().value;
      const dx = p.x - state.pinch.startX;
      const dy = p.y - state.pinch.startY;
      state.view.x = state.pinch.ox + dx;
      state.view.y = state.pinch.oy + dy;
      setViewportTransform();
    }

    if(state.pointers.size === 2){
      const pts = Array.from(state.pointers.values());
      const d = Math.hypot(pts[0].x-pts[1].x, pts[0].y-pts[1].y);
      const factor = d / state.pinch.d0;
      const next = clamp(state.pinch.s0 * factor, 0.6, 3.0);

      // zoom around mid svg point
      const midSvg = state.pinch.midSvg;
      const old = state.view.scale;
      const rel = next / old;
      state.view.x = midSvg.x - rel*(midSvg.x - state.view.x);
      state.view.y = midSvg.y - rel*(midSvg.y - state.view.y);
      state.view.scale = next;
      setViewportTransform();
    }
  }, {passive:false});

  function endPointer(e){
    state.pointers.delete(e.pointerId);
    if(state.pointers.size === 0) state.pinch = null;
    if(state.pointers.size === 1){
      const p = state.pointers.values().next().value;
      state.pinch = { mode:'pan', startX:p.x, startY:p.y, ox: state.view.x, oy: state.view.y };
    }
  }
  svg.addEventListener('pointerup', endPointer);
  svg.addEventListener('pointercancel', endPointer);

  // ---------- UI bindings ----------
  selRing.addEventListener('change', () => selectRing(selRing.value));
  ringStroke.addEventListener('input', () => {
    const r = state.rings.find(x=>x.id===state.selectedRingId); if(!r) return;
    r.stroke = Number(ringStroke.value);
    renderRings();
  });
  ringRadius.addEventListener('input', () => {
    const r = state.rings.find(x=>x.id===state.selectedRingId); if(!r) return;
    r.radius = Number(ringRadius.value);
    renderRings();
    renderWeave();
  });

  btnAddRing.addEventListener('click', () => addRing({radius: clamp(Number(ringRadius.value)-90, 180, 340), stroke:Number(ringStroke.value), color: state.colors.ring }));
  btnRemoveRing.addEventListener('click', removeRing);

  itemScale.addEventListener('input', () => {
    const it = state.items.find(i=>i.id===state.selectedItemId); if(!it) return;
    it.scale = Number(itemScale.value);
    const g = gItems.querySelector(`[data-item-id="${it.id}"]`);
    if(g) g.setAttribute('transform', `translate(${it.x} ${it.y}) rotate(${it.rot}) scale(${it.scale})`);
    updateMiniPreview();
  });
  itemRot.addEventListener('input', () => {
    const it = state.items.find(i=>i.id===state.selectedItemId); if(!it) return;
    it.rot = Number(itemRot.value);
    const g = gItems.querySelector(`[data-item-id="${it.id}"]`);
    if(g) g.setAttribute('transform', `translate(${it.x} ${it.y}) rotate(${it.rot}) scale(${it.scale})`);
    updateMiniPreview();
  });

  selWeave.addEventListener('change', () => {
    const ring = state.rings.find(r=>r.id===state.selectedRingId); if(!ring) return;
    const weave = state.weaveByRing.get(ring.id) || {type:'none', color: state.colors.weave, strength: Number(weaveStrength.value)};
    weave.type = selWeave.value;
    state.weaveByRing.set(ring.id, weave);
    renderWeave();
    updateMiniPreview();
    updateSummary();
  });

  weaveStrength.addEventListener('input', () => {
    const ring = state.rings.find(r=>r.id===state.selectedRingId); if(!ring) return;
    const weave = state.weaveByRing.get(ring.id) || {type: selWeave.value, color: state.colors.weave, strength:70};
    weave.strength = Number(weaveStrength.value);
    state.weaveByRing.set(ring.id, weave);
    renderWeave();
  });

  txtDedica.addEventListener('input', updateSummary);
  txtNote.addEventListener('input', updateSummary);

  btnWa.addEventListener('click', () => {
    const num = (waNumber.value || '').replace(/\s+/g,'');
    if(!num.startsWith('+')){
      alert('Inserisci un numero WhatsApp valido con +39...');
      return;
    }
    const msg = encodeURIComponent(summaryEl.textContent.trim() || 'Ciao! Vorrei questo acchiappasogni personalizzato.');
    const url = `https://wa.me/${num.replace('+','')}?text=${msg}`;
    window.open(url, '_blank');
  });

  btnCopy.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(summaryEl.textContent.trim());
      alert('Riepilogo copiato!');
    }catch{
      alert('Non riesco a copiare automaticamente: seleziona e copia il testo manualmente.');
    }
  });

  btnExport.addEventListener('click', () => {
    exportPNG();
  });

  // Color pickers
  buildSwatches(swRing, (c) => {
    state.colors.ring = c;
    const r = state.rings.find(x=>x.id===state.selectedRingId); if(!r) return;
    r.color = c;
    renderRings();
    updateSummary();
  });

  buildSwatches(swWeave, (c) => {
    state.colors.weave = c;
    const ring = state.rings.find(r=>r.id===state.selectedRingId); if(!ring) return;
    const weave = state.weaveByRing.get(ring.id) || {type: selWeave.value, color: c, strength: Number(weaveStrength.value)};
    weave.color = c;
    state.weaveByRing.set(ring.id, weave);
    renderWeave();
    updateMiniPreview();
    updateSummary();
  });

  buildSwatches(swItem, (c) => {
    state.colors.item = c;
    const it = state.items.find(i=>i.id===state.selectedItemId); if(!it) return;
    it.color = c;
    const g = gItems.querySelector(`[data-item-id="${it.id}"]`);
    if(g){
      const p = g.querySelector('svg path');
      if(p){
        if(['heart','drop'].includes(it.key)){
          p.setAttribute('fill', c);
          p.setAttribute('stroke','none');
        } else {
          p.setAttribute('stroke', c);
          p.setAttribute('fill','none');
        }
      }
    }
    updateMiniPreview();
    updateSummary();
  });

  // ---------- Summary + Export ----------
  function updateKPIs(){
    kpiRings.textContent = `Cerchi: ${state.rings.length}`;
    kpiItems.textContent = `Accessori: ${state.items.length}`;
  }

  function updateSummary(){
    const ringLines = state.rings.map((r, idx) => {
      const weave = state.weaveByRing.get(r.id);
      const w = weave && weave.type !== 'none' ? ` ‚Ä¢ Tessitura: ${labelWeave(weave.type)} (${weave.color})` : '';
      return `- Cerchio ${idx+1}: raggio ${Math.round(r.radius)} ‚Ä¢ spessore ${r.stroke} ‚Ä¢ colore ${r.color}${w}`;
    }).join('\n');

    const itemLines = state.items.map((it, idx) => {
      const name = (ACCESSORIES.find(a=>a.key===it.key)?.name) || it.key;
      return `- ${idx+1}) ${name} ‚Ä¢ colore ${it.color} ‚Ä¢ scala ${it.scale.toFixed(2)} ‚Ä¢ rot ${Math.round(it.rot)}¬∞`;
    }).join('\n') || '- (nessun accessorio)';

    const dedica = (txtDedica.value || '').trim();
    const note = (txtNote.value || '').trim();

    summaryEl.textContent =
`üßµ CONFIGURAZIONE ACCHIAPPASOGNI\n\nDiametro scelto: ${Number(diamCm.value)||30} cm\n\nCerchi:\n${ringLines}\n\nAccessori:\n${itemLines}\n\nTesto/Dedica: ${dedica || '(nessuno)'}\nNote: ${note || '(nessuna)'}\n\nüìå Allego immagine/screenshot dell\'anteprima.`;
  }

  function labelWeave(t){
    if(t==='web') return 'Ragnatela semplice';
    if(t==='star') return 'Stella';
    if(t==='double') return 'Doppia stella';
    return 'Nessuna';
  }

  function exportPNG(){
    const clone = svg.cloneNode(true);
    clone.setAttribute('xmlns','http://www.w3.org/2000/svg');
    // export cropped to ring area
    clone.setAttribute('viewBox','120 120 760 760');
    const data = new XMLSerializer().serializeToString(clone);
    const svgBlob = new Blob([data], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(svgBlob);
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const size = 1400;
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,size,size);
      ctx.drawImage(img,0,0,size,size);
      URL.revokeObjectURL(url);
      canvas.toBlob((blob) => {
        if(!blob){ alert('Export non riuscito'); return; }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `acchiappasogni_${Date.now()}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 3000);
      }, 'image/png');
    };
    img.onerror = () => {
      URL.revokeObjectURL(url);
      alert('Export non riuscito (immagine)');
    };
    img.src = url;
  }

  // ---------- Presets ----------
  function applyPreset(name){
    if(name==='classic'){
      setRingColor('#111827');
      setWeave({type:'web', color:'#111827', strength:70});
      // add a few items
      if(state.items.length===0){
        addItem('moon', 500, 640);
        addItem('crystal', 430, 720);
        addItem('crystal', 570, 720);
      }
    }
    if(name==='gold'){
      setRingColor('#a16207');
      setWeave({type:'star', color:'#a16207', strength:55});
    }
    if(name==='forest'){
      setRingColor('#166534');
      setWeave({type:'web', color:'#166534', strength:65});
    }
    if(name==='multi'){
      setRingColor('#111827');
      setWeave({type:'double', color:'#3b82f6', strength:65});
      if(state.items.length===0){
        addItem('star', 500, 340);
        addItem('heart', 500, 720);
      }
    }
    renderRings();
    renderWeave();
    updateMiniPreview();
    updateSummary();
  }

  function setRingColor(c){
    state.colors.ring = c;
    const r = state.rings.find(x=>x.id===state.selectedRingId);
    if(r){ r.color = c; }
  }
  function setWeave(w){
    const ring = state.rings.find(r=>r.id===state.selectedRingId); if(!ring) return;
    state.weaveByRing.set(ring.id, {...w});
    selWeave.value = w.type;
    weaveStrength.value = w.strength;
  }

  // ---------- Reset ----------
  function resetAll(){
    state.items = [];
    state.selectedItemId = null;
    gItems.innerHTML='';

    state.rings = [];
    state.weaveByRing = new Map();
    addRing({radius:360, stroke:18, color:'#111827'});

    centerView();
    updateKPIs();
    updateMiniPreview();
    updateSummary();
  }

  // ---------- Init ----------
  buildPalette();
  resetAll();
  buildRingSelector();
  setViewportTransform();

  function buildRingSelector(){
    syncRingUI();
  }

  // Ensure selection clear works
  svg.addEventListener('click', (e) => {
    // if click on background (not item)
    if(e.target === svg || e.target === viewport || e.target.tagName==='rect'){
      state.selectedItemId = null;
      for(const g of gItems.querySelectorAll('g[data-item-id]')) g.style.filter='none';
    }
  });

  function updateStatus(){
    // not used, placeholder
  }

  updateSummary();
})();
</script>
 </body>
</html>
