<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Acchiappasogni Ery ‚Äî Configuratore</title>

  <!-- Google Fonts (leggere e "belle") -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;600;700&family=Pacifico&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#070a18;
      --panel:#0d1230;
      --panel2:#0b1027;
      --card:#101848;
      --text:#eef2ff;
      --muted:#b8c1ff;
      --line:rgba(255,255,255,.10);
      --accent:#7c5cff;
      --accent2:#2dd4bf;
      --danger:#ff4d6d;
      --ok:#00e5a8;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:16px;
      --r2:22px;
      --ringShadow: drop-shadow(0 3px 5px rgba(0,0,0,.35));
      --softShadow: drop-shadow(0 2px 6px rgba(0,0,0,.25));
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(124,92,255,.35), transparent 60%),
                  radial-gradient(1200px 900px at 110% 10%, rgba(45,212,191,.20), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: Montserrat, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    header{
      position: sticky;
      top:0;
      z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,10,24,.90), rgba(7,10,24,.55));
      border-bottom:1px solid var(--line);
      padding: 14px 14px 12px;
    }
    .hrow{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .brand h1{
      margin:0;
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      font-size:12px;
      color:var(--muted);
    }
    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-weight:700;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      border:1px solid rgba(255,255,255,.10);
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(124,92,255,.95), rgba(45,212,191,.50));
      border-color: rgba(255,255,255,.14);
    }
    .btn.danger{
      background: rgba(255,77,109,.12);
      border-color: rgba(255,77,109,.35);
      color:#ffd7df;
    }
    .btn.ok{
      background: rgba(0,229,168,.12);
      border-color: rgba(0,229,168,.35);
      color:#c8fff1;
    }
    .btn.ghost{
      background: transparent;
      border-color: rgba(255,255,255,.12);
    }
    .btn.small{padding:8px 10px; font-size:12px; border-radius: 10px;}

    main{
      padding: 14px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,24,72,.55), rgba(11,16,39,.55));
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .head{
      padding: 14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .card .head h2{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    .card .head .hint{
      margin:0;
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .card .body{padding: 12px 14px 14px;}

    /* Preview area */
    .previewWrap{
      display:grid;
      gap:12px;
    }
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .toolGroup{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:8px;
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
    }
    .status{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      font-size:12px;
      color: var(--muted);
    }

    .stage{
      width:100%;
      aspect-ratio: 1/1;
      background:
        radial-gradient(600px 600px at 50% 30%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(1000px 800px at 30% 90%, rgba(45,212,191,.10), transparent 55%),
        rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      overflow:hidden;
      position:relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.2);
    }
    .stage .bgPhoto{
      position:absolute; inset:0;
      background-size: cover;
      background-position:center;
      opacity: .25;
      filter: saturate(1.05) contrast(1.05);
      pointer-events:none;
    }
    .stage svg{
      width:100%;
      height:100%;
      display:block;
      touch-action: none; /* drag on mobile */
    }

    /* Right panel tabs */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      padding:10px 10px 0;
    }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(124,92,255,.38), rgba(45,212,191,.18));
      color: var(--text);
      border-color: rgba(255,255,255,.18);
    }

    .section{
      display:none;
      gap:12px;
    }
    .section.active{display:grid;}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    @media (max-width: 520px){
      .grid2{grid-template-columns:1fr;}
    }

    label{
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    input[type="text"], input[type="number"], select{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--text);
      outline:none;
      font-weight:700;
      font-size:13px;
    }
    input[type="color"]{
      width:100%;
      height:42px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      padding:0;
    }
    .note{
      padding:10px 12px;
      border-radius: 16px;
      border:1px dashed rgba(255,255,255,.18);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      font-size:12px;
      line-height:1.35;
    }

    .chipRow{display:flex; flex-wrap:wrap; gap:8px;}
    .chip{
      padding:9px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:800;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.on{
      background: rgba(124,92,255,.22);
      border-color: rgba(124,92,255,.45);
    }

    .list{
      display:grid;
      gap:8px;
      margin:0;
      padding:0;
      list-style:none;
    }
    .item{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding:10px 10px;
    }
    .item .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }
    .badge{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.15);
      display:grid;
      place-items:center;
      font-weight:900;
      color: var(--muted);
      flex:0 0 auto;
    }
    .item .title{
      font-weight:900;
      font-size:13px;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item .meta{
      font-size:11px;
      color: var(--muted);
      margin:2px 0 0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Gallery */
    .gallery{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:10px;
    }
    .gimg{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(255,255,255,.03);
      aspect-ratio: 3/4;
      position:relative;
    }
    .gimg img{width:100%; height:100%; object-fit:cover; display:block; opacity:.95}
    .gimg .x{
      position:absolute; top:8px; right:8px;
      border-radius: 12px;
      padding:8px 10px;
      background: rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.15);
      color: #fff;
      font-weight:900;
      cursor:pointer;
    }

    /* tiny footer help */
    .footHelp{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }

    /* SVG selection */
    .selOutline{
      fill:none;
      stroke: rgba(124,92,255,.95);
      stroke-width: 2.2;
      stroke-dasharray: 5 4;
      filter: drop-shadow(0 2px 6px rgba(124,92,255,.20));
      pointer-events:none;
    }

    /* LED animation */
    @keyframes blink { 0%, 55%{opacity:1} 56%, 75%{opacity:.25} 76%, 100%{opacity:1} }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      place-items:center;
      padding:16px;
      z-index:80;
    }
    .modalBack.on{display:grid;}
    .modal{
      width:min(560px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(16,24,72,.92), rgba(11,16,39,.92));
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modal .mhead{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal .mhead h3{margin:0; font-size:16px}
    .modal .mbody{padding:14px}
    .modal .mfoot{
      padding:12px 14px 14px;
      border-top:1px solid rgba(255,255,255,.12);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
<header>
  <div class="hrow">
    <div class="brand">
      <h1>Acchiappasogni Ery ‚Äî Configuratore</h1>
      <div class="sub">
        <span>Personalizza e invia la richiesta su WhatsApp</span>
        <span class="pill" id="modePill">üü¢ Modalit√†: <b style="color:var(--text)">Facile</b></span>
      </div>
    </div>
    <div class="row">
      <button class="btn ghost" id="btnCreaDaFoto">üì∑ Crea da foto</button>
      <button class="btn ghost" id="btnSalva">üìå Salva progetto</button>
      <button class="btn primary" id="btnInvia">üí¨ Invia su WhatsApp</button>
    </div>
  </div>
</header>

<main>
  <!-- LEFT: PREVIEW -->
  <section class="card">
    <div class="head">
      <h2>Anteprima</h2>
      <p class="hint">
        ‚úÖ Tocca un elemento per selezionarlo ‚Ä¢ Trascina per spostare ‚Ä¢ I bottoni qui sotto ti aiutano ad allineare e rendere tutto pi√π bello.
      </p>

      <div class="toolbar">
        <div class="toolGroup">
          <button class="btn small" id="btnUndo">‚Ü©Ô∏è Annulla</button>
          <button class="btn small" id="btnRedo">‚Ü™Ô∏è Ripeti</button>
          <button class="btn small" id="btnCenter">üéØ Allinea al centro</button>
          <button class="btn small" id="btnDistribute">üìè Distribuisci</button>
          <button class="btn small" id="btnMirror">ü™û Specchia S/D</button>
          <button class="btn small" id="btnLock">üîí Blocca posizione</button>
        </div>
        <div class="toolGroup">
          <button class="btn small" id="btnBack">‚¨áÔ∏è Indietro</button>
          <button class="btn small" id="btnFront">‚¨ÜÔ∏è Avanti</button>
          <button class="btn small danger" id="btnDelete">üóëÔ∏è Elimina</button>
        </div>
      </div>

      <div class="status" id="statusLine">
        <span>Selezione: <b id="selName">nessuna</b></span>
        <span>‚Ä¢</span>
        <span>Totale stimato: <b id="totalPrice">0,00‚Ç¨</b></span>
      </div>
    </div>

    <div class="body previewWrap">
      <div class="stage" id="stage">
        <div class="bgPhoto" id="bgPhoto" aria-hidden="true"></div>

        <svg id="svg" viewBox="0 0 1000 1000" role="img" aria-label="Anteprima configuratore">
          <defs>
            <!-- rete pi√π realistica -->
            <filter id="softShadow">
              <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="#000" flood-opacity=".35"/>
            </filter>
            <filter id="ringShadow">
              <feDropShadow dx="0" dy="3" stdDeviation="4" flood-color="#000" flood-opacity=".35"/>
            </filter>

            <!-- effetto corda del cerchio -->
            <filter id="rope">
              <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" seed="2" result="noise"/>
              <feDisplacementMap in="SourceGraphic" in2="noise" scale="1.2" xChannelSelector="R" yChannelSelector="G"/>
            </filter>

            <!-- glow luci -->
            <filter id="glow">
              <feGaussianBlur stdDeviation="3.2" result="b"/>
              <feMerge>
                <feMergeNode in="b"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <!-- background helper grid (hidden) -->
          <g id="grid" opacity="0.0">
            <rect x="0" y="0" width="1000" height="1000" fill="none" stroke="rgba(255,255,255,.06)"/>
          </g>

          <!-- work area -->
          <g id="scene">
            <!-- base model group (rings + web) -->
            <g id="baseModel"></g>

            <!-- lights -->
            <g id="lightsLayer"></g>

            <!-- accessories layer -->
            <g id="accessoriesLayer"></g>

            <!-- text layer -->
            <g id="textLayer"></g>

            <!-- selection outline layer -->
            <g id="uiLayer"></g>
          </g>
        </svg>
      </div>

      <div class="footHelp">
        Suggerimento: se una piuma esce ‚Äústorta‚Äù, usa <b>Allinea</b> e <b>Distribuisci</b>. Se vuoi evitare tocchi accidentali, usa <b>Blocca posizione</b>.
      </div>
    </div>
  </section>

  <!-- RIGHT: CONTROLS -->
  <aside class="card">
    <div class="head">
      <h2>Controlli (semplici)</h2>
      <p class="hint">Scegli un modello gi√† bello e poi personalizza. Non devi partire da zero.</p>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="modello">1) Modello</div>
      <div class="tab" data-tab="cerchi">2) Cerchi</div>
      <div class="tab" data-tab="tessitura">3) Tessitura</div>
      <div class="tab" data-tab="accessori">4) Accessori</div>
      <div class="tab" data-tab="scritta">5) Scritta</div>
      <div class="tab" data-tab="luci">6) Luci LED</div>
      <div class="tab" data-tab="salva">7) Salva/Scarica</div>
      <div class="tab" data-tab="prezzi">8) Prezzi</div>
      <div class="tab" data-tab="vetrina">9) I miei lavori</div>
    </div>

    <div class="body">
      <!-- SEZIONE MODELLO -->
      <div class="section active" id="sec-modello">
        <div class="note">
          ‚úÖ <b>Consiglio top:</b> scegli un modello pronto (classico, luna, albero, multi-cerchi) e poi lo personalizzi.
        </div>

        <div class="grid2">
          <label>
            Modello
            <select id="modelSelect">
              <option value="classic">Classico (1 cerchio + piume)</option>
              <option value="triple">Triplo (1 grande + 2 piccoli)</option>
              <option value="moon">Luna</option>
              <option value="tree">Albero luminoso (multi cerchi)</option>
              <option value="mini">Mini (piccolo semplice)</option>
            </select>
          </label>

          <label>
            Colore cerchio (corda)
            <input type="color" id="ringColor" value="#b6936a" />
          </label>
        </div>

        <div class="grid2">
          <label>
            Colore rete
            <input type="color" id="webColor" value="#f2f2f2" />
          </label>
          <label>
            Perla centrale (colore)
            <input type="color" id="centerBeadColor" value="#d7d7d7" />
          </label>
        </div>

        <div class="row">
          <button class="btn ok" id="btnApplyModel">‚ú® Applica modello</button>
          <button class="btn ghost" id="btnReset">üîÑ Riparti pulito</button>
        </div>

        <div class="note">
          üìå <b>Tip ‚ÄúCrea da foto‚Äù</b>: puoi caricare una foto e usarla come riferimento sotto l‚Äôanteprima (utile per imitare un lavoro reale).
        </div>
      </div>

      <!-- SEZIONE CERCHI -->
      <div class="section" id="sec-cerchi">
        <div class="note">Qui scegli quanti cerchi e le dimensioni. Ogni cerchio avr√† anche la sua tessitura (sezione 3).</div>

        <div class="grid2">
          <label>
            Cerchio grande (diametro)
            <input type="number" id="bigRing" min="200" max="780" step="10" value="520"/>
          </label>
          <label>
            Spessore corda
            <input type="number" id="ringStroke" min="6" max="26" step="1" value="16"/>
          </label>
        </div>

        <div class="grid2">
          <label>
            Cerchi piccoli (quantit√†)
            <select id="smallCount">
              <option value="0">0</option>
              <option value="1">1</option>
              <option value="2" selected>2</option>
              <option value="3">3</option>
              <option value="4">4</option>
            </select>
          </label>
          <label>
            Cerchio piccolo (diametro)
            <input type="number" id="smallRing" min="120" max="420" step="10" value="220"/>
          </label>
        </div>

        <div class="row">
          <button class="btn ok" id="btnApplyRings">‚úÖ Aggiorna cerchi</button>
          <button class="btn ghost" id="btnAutoLayout">üìê Auto allineamento</button>
        </div>

        <div class="note">
          ‚úÖ <b>Auto allineamento</b> sistema in automatico posizioni e simmetria (cos√¨ anche un utente alle prime armi fa qualcosa di bello).
        </div>
      </div>

      <!-- SEZIONE TESSITURA -->
      <div class="section" id="sec-tessitura">
        <div class="note">Scegli la tessitura (rete) per ogni cerchio. Puoi cambiarla quando vuoi.</div>

        <label>
          Cerchio da modificare
          <select id="weaveRingSelect"></select>
        </label>

        <div class="grid2">
          <label>
            Tipo tessitura
            <select id="weaveType">
              <option value="spider">Ragnatela classica</option>
              <option value="star">Stella (effetto ‚Äúraggio‚Äù)</option>
              <option value="flower">Fiore (petali)</option>
              <option value="spiral">Spirale</option>
              <option value="simple">Semplice (pochi raggi)</option>
            </select>
          </label>

          <label>
            Densit√† (pi√π o meno fili)
            <input type="number" id="weaveDensity" min="3" max="14" step="1" value="9"/>
          </label>
        </div>

        <div class="row">
          <button class="btn ok" id="btnApplyWeave">üßµ Applica tessitura</button>
          <button class="btn ghost" id="btnWeaveAll">‚ú® Applica a tutti i cerchi</button>
        </div>

        <div class="note">
          Consiglio: per lavori ‚Äúnatalizi‚Äù, una tessitura <b>Stella</b> o <b>Fiore</b> fa molto effetto.
        </div>
      </div>

      <!-- SEZIONE ACCESSORI -->
      <div class="section" id="sec-accessori">
        <div class="note">
          Seleziona prima un tema, cos√¨ vedi solo accessori coerenti (Natale, Matrimonio, Nascita‚Ä¶). Poi premi per aggiungerli.
        </div>

        <div class="chipRow" id="themeChips"></div>

        <div class="grid2">
          <label>
            Colore accessorio (quando possibile)
            <input type="color" id="accColor" value="#ffffff"/>
          </label>
          <label>
            Dimensione
            <select id="accSize">
              <option value="0.8">Piccola</option>
              <option value="1" selected>Normale</option>
              <option value="1.25">Grande</option>
            </select>
          </label>
        </div>

        <ul class="list" id="accList"></ul>

        <div class="note">
          ‚úÖ Dopo aver aggiunto un accessorio: toccalo nell‚Äôanteprima ‚Üí trascina ‚Üí se serve usa <b>Allinea</b> e <b>Indietro/Avanti</b>.
        </div>
      </div>

      <!-- SEZIONE SCRITTA -->
      <div class="section" id="sec-scritta">
        <div class="note">Aggiungi una scritta personalizzata: testo, colore, posizione e stile font (effetto ‚Äúprodotto di lusso‚Äù).</div>

        <label>
          Testo scritta
          <input type="text" id="textValue" placeholder="Es: Buone Feste / Merry Christmas / Nome..." />
        </label>

        <div class="grid2">
          <label>
            Colore scritta
            <input type="color" id="textColor" value="#ffd34d"/>
          </label>
          <label>
            Font
            <select id="textFont">
              <option value="Great Vibes">Corsivo elegante</option>
              <option value="Pacifico">Natale / allegro</option>
              <option value="Playfair Display">Elegante moderno</option>
              <option value="Montserrat" selected>Moderno pulito</option>
            </select>
          </label>
        </div>

        <div class="grid2">
          <label>
            Dimensione
            <input type="number" id="textSize" min="18" max="120" step="2" value="56"/>
          </label>
          <label>
            Ombra leggera
            <select id="textShadow">
              <option value="on" selected>On</option>
              <option value="off">Off</option>
            </select>
          </label>
        </div>

        <div class="row">
          <button class="btn ok" id="btnAddText">‚úçÔ∏è Aggiungi/aggiorna scritta</button>
          <button class="btn danger" id="btnRemoveText">üóëÔ∏è Rimuovi scritta</button>
        </div>

        <div class="note">Dopo averla aggiunta puoi spostarla trascinando il testo nell‚Äôanteprima.</div>
      </div>

      <!-- SEZIONE LUCI -->
      <div class="section" id="sec-luci">
        <div class="note">
          Funzione luci LED (come nelle tue foto): √® grafica, ma fa scena. Puoi scegliere colore, intensit√† e modalit√† fissa/lampeggio.
        </div>

        <div class="grid2">
          <label>
            Luci
            <select id="lightsOn">
              <option value="off" selected>Off</option>
              <option value="on">On</option>
            </select>
          </label>
          <label>
            Colore luci
            <select id="lightsColor">
              <option value="multicolor" selected>Multicolor</option>
              <option value="#ffffff">Bianco</option>
              <option value="#6aa9ff">Blu</option>
              <option value="#ff3b7b">Rosa</option>
              <option value="#7cffb7">Verde</option>
              <option value="#ffd34d">Oro</option>
            </select>
          </label>
        </div>

        <div class="grid2">
          <label>
            Intensit√† (luminosit√†)
            <input type="number" id="lightsIntensity" min="20" max="100" step="5" value="75"/>
          </label>
          <label>
            Modalit√†
            <select id="lightsMode">
              <option value="steady" selected>Fissa</option>
              <option value="blink">Lampeggio</option>
            </select>
          </label>
        </div>

        <div class="row">
          <button class="btn ok" id="btnApplyLights">üí° Applica luci</button>
          <button class="btn ghost" id="btnLightsAuto">‚ú® Luci ‚Äúbelle‚Äù automatiche</button>
        </div>
      </div>

      <!-- SEZIONE SALVA/SCARICA -->
      <div class="section" id="sec-salva">
        <div class="note">
          Quando finisci puoi: <b>Salva progetto</b> (per rivederlo), <b>Scarica immagine</b> e <b>Invia su WhatsApp</b> con descrizione completa + costo stimato.
        </div>

        <div class="grid2">
          <label>
            Nome progetto
            <input type="text" id="projectName" placeholder="Es: Luna Verde / Natale Rosso / ..." />
          </label>
          <label>
            Numero WhatsApp (tuo)
            <input type="text" id="waNumber" placeholder="Es: 39333..." />
          </label>
        </div>

        <div class="row">
          <button class="btn ok" id="btnDownloadPNG">üì• Scarica immagine (PNG)</button>
          <button class="btn ghost" id="btnDownloadJSON">üìå Scarica progetto (.json)</button>
          <label style="margin:0">
            <span style="font-size:12px; color:var(--muted); font-weight:800; margin-bottom:6px; display:block">üìÇ Carica progetto (.json)</span>
            <input type="file" id="fileLoadJSON" accept="application/json" />
          </label>
        </div>

        <div class="row">
          <button class="btn primary" id="btnInvia2">üí¨ Invia su WhatsApp</button>
        </div>

        <div class="note">
          Nota: l‚Äôinvio WhatsApp apre la chat con un testo gi√† pronto in italiano (descrizione dettagliata + totale stimato). Ti arriva sul numero che imposti qui.
        </div>
      </div>

      <!-- SEZIONE PREZZI -->
      <div class="section" id="sec-prezzi">
        <div class="note">
          Prezzi ‚Äúmodesti‚Äù ma modificabili. L‚Äôutente vede il totale stimato, ma tu puoi cambiare tutti i prezzi nella tua area privata.
        </div>

        <div class="row">
          <button class="btn ghost" id="btnAreaPrivata">üîê Area privata (modifica prezzi)</button>
          <button class="btn ghost" id="btnResetPrices">‚Ü©Ô∏è Ripristina prezzi base</button>
        </div>

        <div class="note" id="priceSummary"></div>

        <div class="note">
          Sconto quantit√† (automatico):
          <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted);">
            <li>se accessori totali ‚â• 10 ‚Üí -5%</li>
            <li>se accessori totali ‚â• 20 ‚Üí -10%</li>
            <li>se accessori totali ‚â• 30 ‚Üí -15%</li>
          </ul>
        </div>
      </div>

      <!-- SEZIONE VETRINA -->
      <div class="section" id="sec-vetrina">
        <div class="note">
          ‚ÄúI nostri lavori reali‚Äù fa fidare l‚Äôutente e compra pi√π facilmente. Qui puoi caricare alcune foto (restano salvate sul tuo dispositivo).
        </div>

        <div class="row">
          <label style="margin:0">
            <span style="font-size:12px; color:var(--muted); font-weight:800; margin-bottom:6px; display:block">‚ûï Aggiungi foto</span>
            <input type="file" id="galleryAdd" accept="image/*" multiple />
          </label>
          <button class="btn danger" id="btnClearGallery">üóëÔ∏è Svuota vetrina</button>
        </div>

        <div class="gallery" id="gallery"></div>
      </div>
    </div>
  </aside>
</main>

<!-- MODAL: CREA DA FOTO -->
<div class="modalBack" id="photoModal">
  <div class="modal">
    <div class="mhead">
      <h3>üì∑ Crea da foto (riferimento)</h3>
      <button class="btn small ghost" id="closePhoto">‚úñ</button>
    </div>
    <div class="mbody">
      <div class="note">
        Carica una foto: verr√† messa sotto l‚Äôanteprima come <b>sfondo semitrasparente</b>.
        Puoi anche far scegliere al configuratore un colore base ‚Äúsimile‚Äù.
      </div>
      <label>
        Seleziona foto
        <input type="file" id="photoFile" accept="image/*"/>
      </label>
      <div class="grid2">
        <label>
          Opacit√† sfondo (%)
          <input type="number" id="photoOpacity" min="5" max="60" step="5" value="25"/>
        </label>
        <label>
          Colore base automatico
          <select id="autoColor">
            <option value="off" selected>Off</option>
            <option value="ring">Imposta colore cerchio</option>
            <option value="web">Imposta colore rete</option>
          </select>
        </label>
      </div>
    </div>
    <div class="mfoot">
      <button class="btn ghost" id="btnRemovePhoto">Rimuovi sfondo</button>
      <button class="btn ok" id="btnApplyPhoto">Applica</button>
    </div>
  </div>
</div>

<!-- MODAL: AREA PRIVATA -->
<div class="modalBack" id="privateModal">
  <div class="modal">
    <div class="mhead">
      <h3>üîê Area privata</h3>
      <button class="btn small ghost" id="closePrivate">‚úñ</button>
    </div>
    <div class="mbody" id="privateBody"></div>
    <div class="mfoot">
      <button class="btn ghost" id="btnPrivateCancel">Chiudi</button>
      <button class="btn ok" id="btnPrivateSave">Salva</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   CONFIG / DATA
=========================== */

const STORAGE_KEY = "ery_configurator_v1";
const STORAGE_GALLERY = "ery_gallery_v1";
const STORAGE_PRICES = "ery_prices_v1";
const STORAGE_PIN = "ery_pin_v1";

const DEFAULT_PIN = "1234";

/** Prezzi base (modesti) - modificabili da area privata */
const DEFAULT_PRICES = {
  ring_big: 4.00,
  ring_small: 2.00,
  weave: 0.00, // tessitura inclusa (puoi cambiare se vuoi)
  feather: 0.50,
  bead: 0.20,
  charm: 1.50,    // charm generico (stella/cuore/fiocco ecc)
  flower: 1.50,
  bow: 2.00,
  gnome: 2.50,
  text: 3.00,
  lights: 4.00
};

/** Accessori: (semplici ma efficaci). "tipoPrezzo" serve per stimare il totale */
const ACCESSORIES = [
  { id:"feather", label:"Piuma", icon:"ü™∂", themes:["Classico","Nascita","Matrimonio"], priceKey:"feather", colorable:true, kind:"feather" },
  { id:"bead", label:"Perlina", icon:"ü´ß", themes:["Classico","Nascita","Matrimonio","Natale"], priceKey:"bead", colorable:true, kind:"bead" },
  { id:"star", label:"Stellina", icon:"‚≠ê", themes:["Natale","Nascita"], priceKey:"charm", colorable:true, kind:"charm" },
  { id:"heart", label:"Cuore", icon:"‚ù§Ô∏è", themes:["Matrimonio","Nascita"], priceKey:"charm", colorable:true, kind:"charm" },
  { id:"snow", label:"Fiocco di neve", icon:"‚ùÑÔ∏è", themes:["Natale"], priceKey:"charm", colorable:true, kind:"charm" },
  { id:"holly", label:"Agrifoglio", icon:"üçÉ", themes:["Natale"], priceKey:"charm", colorable:true, kind:"charm" },
  { id:"flower", label:"Fiore", icon:"üå∏", themes:["Matrimonio","Nascita","Classico"], priceKey:"flower", colorable:true, kind:"flower" },
  { id:"bow", label:"Fiocco", icon:"üéÄ", themes:["Natale","Matrimonio","Nascita"], priceKey:"bow", colorable:true, kind:"bow" },
  { id:"gnome", label:"Gnomo", icon:"üßë‚ÄçüéÑ", themes:["Natale"], priceKey:"gnome", colorable:false, kind:"gnome" },
  { id:"initials", label:"Iniziali (testo)", icon:"üî§", themes:["Matrimonio","Nascita"], priceKey:"text", colorable:true, kind:"miniText" }
];

const THEMES = ["Tutti","Classico","Natale","Matrimonio","Nascita"];

/* ===========================
   STATE
=========================== */
const state = {
  mode: "facile",
  model: "classic",
  ringColor: "#b6936a",
  webColor: "#f2f2f2",
  centerBeadColor: "#d7d7d7",
  rings: {
    bigDiameter: 520,
    smallDiameter: 220,
    smallCount: 2,
    ringStroke: 16
  },
  weaves: {
    // per ringId: {type, density}
  },
  lights: { on:false, color:"multicolor", intensity:75, mode:"steady" },
  text: { on:false, value:"", color:"#ffd34d", font:"Montserrat", size:56, shadow:true },
  selectedId: null,
  elements: [], // canvas elements (accessories + text is handled separately but tracked here too)
  history: [],
  future: [],
  photoBg: { dataUrl:null, opacity:0.25 },
  waNumber: "",
  projectName: ""
};

let prices = loadPrices();

/* ===========================
   UTIL
=========================== */
function euro(n){
  const s = (Math.round(n*100)/100).toFixed(2).replace(".", ",");
  return s + "‚Ç¨";
}
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
function uid(prefix="el"){
  return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16).slice(2);
}
function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

function saveToHistory(){
  state.history.push(snapshot());
  if(state.history.length>60) state.history.shift();
  state.future = [];
}
function snapshot(){
  return {
    model: state.model,
    ringColor: state.ringColor,
    webColor: state.webColor,
    centerBeadColor: state.centerBeadColor,
    rings: deepClone(state.rings),
    weaves: deepClone(state.weaves),
    lights: deepClone(state.lights),
    text: deepClone(state.text),
    elements: deepClone(state.elements),
    photoBg: deepClone(state.photoBg),
    waNumber: state.waNumber,
    projectName: state.projectName
  };
}
function restore(snap){
  state.model = snap.model;
  state.ringColor = snap.ringColor;
  state.webColor = snap.webColor;
  state.centerBeadColor = snap.centerBeadColor;
  state.rings = deepClone(snap.rings);
  state.weaves = deepClone(snap.weaves);
  state.lights = deepClone(snap.lights);
  state.text = deepClone(snap.text);
  state.elements = deepClone(snap.elements);
  state.photoBg = deepClone(snap.photoBg);
  state.waNumber = snap.waNumber || "";
  state.projectName = snap.projectName || "";
  state.selectedId = null;
  syncInputs();
  rebuildAll();
}

/* ===========================
   DOM
=========================== */
const $ = (q)=>document.querySelector(q);
const svg = $("#svg");
const baseModel = $("#baseModel");
const lightsLayer = $("#lightsLayer");
const accessoriesLayer = $("#accessoriesLayer");
const textLayer = $("#textLayer");
const uiLayer = $("#uiLayer");
const bgPhoto = $("#bgPhoto");

const selName = $("#selName");
const totalPriceEl = $("#totalPrice");
const modePill = $("#modePill");

/* tabs */
$("#tabs").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab");
  if(!tab) return;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  tab.classList.add("active");
  const key = tab.dataset.tab;
  document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
  $("#sec-"+key).classList.add("active");
});

/* ===========================
   BUILD BASE MODELS
=========================== */

function clearNode(node){
  while(node.firstChild) node.removeChild(node.firstChild);
}

function buildBase(){
  clearNode(baseModel);

  const cX = 500, cY = 420;
  const bigR = state.rings.bigDiameter/2;
  const ringStroke = state.rings.ringStroke;

  // helper to create ring group
  const rings = [];

  if(state.model === "tree"){
    // for "tree" model ignore standard rings values, create tree-like layout
    const sizes = [220, 260, 300, 340, 380, 420, 460];
    const positions = [
      [500, 190],[380, 310],[620, 310],[300, 450],[500, 450],[700, 450],[220, 610],[380, 610],[540, 610],[700, 610],[860, 610]
    ];
    // create a subset of rings based on smallCount? We'll use fixed "tree" count 11
    positions.forEach((p, i)=>{
      const d = sizes[Math.min(sizes.length-1, Math.floor(i/2)+1)];
      rings.push({ id:"r"+(i+1), x:p[0], y:p[1], r:d/2, kind:"small" });
    });
  } else if(state.model === "moon"){
    // moon: crescent as ring-like path
    rings.push({ id:"moon", x:cX, y:cY, r: bigR, kind:"moon" });
  } else {
    // normal: 1 big + optional smalls
    rings.push({ id:"big", x:cX, y:cY, r: bigR, kind:"big" });
    const sc = state.rings.smallCount;
    const sr = state.rings.smallDiameter/2;
    if(sc>0){
      // auto layout symmetric below
      const startY = cY + bigR + 110;
      if(sc===1){
        rings.push({ id:"s1", x:cX, y:startY, r: sr, kind:"small" });
      } else if(sc===2){
        rings.push({ id:"s1", x:cX - sr - 40, y:startY, r: sr, kind:"small" });
        rings.push({ id:"s2", x:cX + sr + 40, y:startY, r: sr, kind:"small" });
      } else {
        // distribute across width
        const spacing = (sr*2 + 36);
        const startX = cX - ((sc-1)/2)*spacing;
        for(let i=0;i<sc;i++){
          rings.push({ id:"s"+(i+1), x:startX + i*spacing, y:startY, r: sr, kind:"small" });
        }
      }
    }
  }

  // build ring visuals + weaves
  rings.forEach(r=>{
    if(r.kind==="moon"){
      const g = svgEl("g", { "data-id":"moon", "data-type":"ring", "filter":"url(#ringShadow)" });
      const crescent = buildCrescentPath(r.x, r.y, r.r, r.r*0.68);
      const path = svgEl("path", {
        d: crescent,
        fill:"none",
        stroke: state.ringColor,
        "stroke-width": ringStroke,
        "stroke-linecap":"round",
        "stroke-linejoin":"round",
        filter:"url(#rope)"
      });
      g.appendChild(path);

      // inner web for moon (a web clipped in crescent)
      const clipId = "clipMoon";
      const defs = svg.querySelector("defs");
      let clip = $("#"+clipId);
      if(clip) clip.remove();
      clip = svgEl("clipPath", { id: clipId });
      clip.appendChild(svgEl("path", { d: crescent }));
      defs.appendChild(clip);

      const wg = svgEl("g", { "clip-path":`url(#${clipId})`, "data-id":"moonWeb" });
      const web = weavePath(r.x, r.y, r.r*0.85, "spider", 9);
      web.setAttribute("stroke", state.webColor);
      web.setAttribute("stroke-width", "2.2");
      web.setAttribute("opacity", "0.95");
      web.setAttribute("filter", "url(#softShadow)");
      wg.appendChild(web);
      g.appendChild(wg);

      // center beads as dots
      const bead = svgEl("circle", { cx:r.x, cy:r.y, r:10, fill: state.centerBeadColor, filter:"url(#softShadow)" });
      g.appendChild(bead);

      baseModel.appendChild(g);
      // register for tessitura selection
      registerRingOption("moon", "Luna (tessitura interna)", "spider", 9);
      return;
    }

    // ring group
    const g = svgEl("g", { "data-id": r.id, "data-type":"ring", "filter":"url(#ringShadow)" });
    const circle = svgEl("circle", {
      cx:r.x, cy:r.y, r:r.r,
      fill:"none",
      stroke: state.ringColor,
      "stroke-width": ringStroke,
      filter:"url(#rope)"
    });
    g.appendChild(circle);

    // weave
    const weaveConf = state.weaves[r.id] || { type:"spider", density:9 };
    const web = weavePath(r.x, r.y, r.r- ringStroke*0.9, weaveConf.type, weaveConf.density);
    web.setAttribute("stroke", state.webColor);
    web.setAttribute("stroke-width", "2.2");
    web.setAttribute("opacity", "0.95");
    web.setAttribute("filter", "url(#softShadow)");
    g.appendChild(web);

    // center bead (only big and small; in tree put bead for each)
    const bead = svgEl("circle", {
      cx:r.x, cy:r.y, r: r.kind==="big" ? 10 : 8,
      fill: state.centerBeadColor,
      filter:"url(#softShadow)"
    });
    g.appendChild(bead);

    baseModel.appendChild(g);

    // ring option for tessitura
    registerRingOption(r.id, (r.id==="big"?"Cerchio grande": (r.id.startsWith("s")?("Cerchio "+r.id.toUpperCase()):("Cerchio "+r.id))), weaveConf.type, weaveConf.density);
  });

  // For classic/triple/mini: ensure default feathers if none
  if(["classic","triple","mini"].includes(state.model)){
    ensureDefaultFeathers();
  }
}

function buildCrescentPath(cx, cy, rOuter, rInner){
  // crescent = outer circle minus inner circle shifted right
  const shift = rOuter*0.35;
  const x1 = cx, y1 = cy;
  const x2 = cx + shift, y2 = cy;

  // SVG arc helpers
  const p1 = [x1, y1 - rOuter];
  const p2 = [x1, y1 + rOuter];
  const p3 = [x2, y2 + rInner];
  const p4 = [x2, y2 - rInner];

  return [
    `M ${p1[0]} ${p1[1]}`,
    `A ${rOuter} ${rOuter} 0 1 1 ${p2[0]} ${p2[1]}`,
    `A ${rOuter} ${rOuter} 0 1 1 ${p1[0]} ${p1[1]}`,
    `Z`,
    `M ${p3[0]} ${p3[1]}`,
    `A ${rInner} ${rInner} 0 1 0 ${p4[0]} ${p4[1]}`,
    `A ${rInner} ${rInner} 0 1 0 ${p3[0]} ${p3[1]}`,
    `Z`
  ].join(" ");
}

function svgEl(name, attrs={}){
  const el = document.createElementNS("http://www.w3.org/2000/svg", name);
  Object.entries(attrs).forEach(([k,v])=>el.setAttribute(k, v));
  return el;
}

function weavePath(cx, cy, radius, type="spider", density=9){
  // returns a <path> for the weave (simple but nice)
  density = clamp(density, 3, 14);

  if(type === "simple"){
    const spokes = Math.max(6, density);
    let d = "";
    for(let i=0;i<spokes;i++){
      const a = (Math.PI*2/spokes)*i - Math.PI/2;
      const x = cx + Math.cos(a)*radius;
      const y = cy + Math.sin(a)*radius;
      d += `M ${cx} ${cy} L ${x} ${y} `;
    }
    return svgEl("path", { d });
  }

  if(type === "star"){
    const points = Math.max(5, Math.min(10, density));
    let d = "";
    for(let i=0;i<points;i++){
      const a = (Math.PI*2/points)*i - Math.PI/2;
      const x = cx + Math.cos(a)*radius;
      const y = cy + Math.sin(a)*radius;
      d += `M ${cx} ${cy} L ${x} ${y} `;
    }
    // add a couple of inner star polygons
    for(let k=1;k<=3;k++){
      const rr = radius*(0.25 + k*0.17);
      let poly = [];
      for(let i=0;i<points;i++){
        const a = (Math.PI*2/points)*i - Math.PI/2;
        poly.push([cx + Math.cos(a)*rr, cy + Math.sin(a)*rr]);
      }
      d += `M ${poly[0][0]} ${poly[0][1]} `;
      for(let i=1;i<poly.length;i++) d += `L ${poly[i][0]} ${poly[i][1]} `;
      d += "Z ";
    }
    return svgEl("path", { d });
  }

  if(type === "flower"){
    const petals = Math.max(6, Math.min(14, density+2));
    let d = "";
    for(let i=0;i<petals;i++){
      const a = (Math.PI*2/petals)*i - Math.PI/2;
      const x1 = cx + Math.cos(a)*radius;
      const y1 = cy + Math.sin(a)*radius;
      const a2 = a + (Math.PI*2/petals)*0.45;
      const x2 = cx + Math.cos(a2)*(radius*0.55);
      const y2 = cy + Math.sin(a2)*(radius*0.55);
      d += `M ${cx} ${cy} Q ${x2} ${y2} ${x1} ${y1} `;
    }
    // inner circle net
    const rr = radius*0.45;
    d += `M ${cx+rr} ${cy} A ${rr} ${rr} 0 1 0 ${cx-rr} ${cy} A ${rr} ${rr} 0 1 0 ${cx+rr} ${cy} `;
    return svgEl("path", { d });
  }

  if(type === "spiral"){
    const turns = density;
    const steps = turns*22;
    let d = "";
    for(let i=0;i<=steps;i++){
      const t = i/steps;
      const a = t*turns*Math.PI*2 - Math.PI/2;
      const rr = t*radius;
      const x = cx + Math.cos(a)*rr;
      const y = cy + Math.sin(a)*rr;
      d += (i===0?`M ${x} ${y} `:`L ${x} ${y} `);
    }
    // a few spokes
    for(let i=0;i<8;i++){
      const a = (Math.PI*2/8)*i - Math.PI/2;
      const x = cx + Math.cos(a)*radius;
      const y = cy + Math.sin(a)*radius;
      d += `M ${cx} ${cy} L ${x} ${y} `;
    }
    return svgEl("path", { d });
  }

  // default "spider"
  const rings = Math.max(4, density);
  const spokes = 12;
  let d = "";

  // spokes
  for(let i=0;i<spokes;i++){
    const a = (Math.PI*2/spokes)*i - Math.PI/2;
    const x = cx + Math.cos(a)*radius;
    const y = cy + Math.sin(a)*radius;
    d += `M ${cx} ${cy} L ${x} ${y} `;
  }

  // web rings (irregular for realism)
  for(let r=1;r<=rings;r++){
    const rr = radius*(r/(rings+0.5));
    let pts = [];
    for(let i=0;i<spokes;i++){
      const a = (Math.PI*2/spokes)*i - Math.PI/2;
      const wobble = (Math.sin(i*1.7 + r*0.8) * 0.03 + 0.02) * radius;
      pts.push([cx + Math.cos(a)*(rr+wobble), cy + Math.sin(a)*(rr+wobble)]);
    }
    d += `M ${pts[0][0]} ${pts[0][1]} `;
    for(let i=1;i<pts.length;i++) d += `L ${pts[i][0]} ${pts[i][1]} `;
    d += "Z ";
  }

  return svgEl("path", { d });
}

/* ===========================
   RING OPTIONS (tessitura UI)
=========================== */
function registerRingOption(ringId, label, type, density){
  // populate select once, then update value
  const sel = $("#weaveRingSelect");
  const exists = [...sel.options].some(o=>o.value===ringId);
  if(!exists){
    const opt = document.createElement("option");
    opt.value = ringId;
    opt.textContent = label;
    sel.appendChild(opt);
  }
  // ensure state defaults
  if(!state.weaves[ringId]){
    state.weaves[ringId] = { type, density };
  }
}

/* ===========================
   ELEMENTS (accessories)
=========================== */
function ensureDefaultFeathers(){
  const hasFeather = state.elements.some(e=>e.kind==="feather");
  if(hasFeather) return;

  // add 6 feathers under big ring
  const big = getRingById("big");
  if(!big) return;
  const startX = big.x - 170;
  const y = big.y + big.r + 190;
  for(let i=0;i<6;i++){
    addAccessory("feather", {
      x: startX + i*70,
      y: y + Math.sin(i)*10,
      rot: (-15 + i*6),
      scale: 1.05,
      color: "#ffffff"
    }, false);
  }
  autoDistributeFeathers();
}

function getRingById(id){
  // read from built base model (circle centers)
  // fallback: compute from current model
  if(state.model === "moon"){
    return { id:"moon", x:500, y:420, r: state.rings.bigDiameter/2 };
  }
  if(state.model === "tree"){
    return null; // tree has many rings
  }
  if(id==="big"){
    return { id:"big", x:500, y:420, r: state.rings.bigDiameter/2 };
  }
  if(id && id.startsWith("s")){
    // derive using current layout logic from buildBase
    const sc = state.rings.smallCount;
    const sr = state.rings.smallDiameter/2;
    const cX = 500, cY=420;
    const bigR = state.rings.bigDiameter/2;
    const startY = cY + bigR + 110;
    const idx = parseInt(id.slice(1),10);
    if(sc===1) return { id, x:cX, y:startY, r:sr };
    if(sc===2){
      if(idx===1) return { id, x:cX - sr - 40, y:startY, r:sr };
      if(idx===2) return { id, x:cX + sr + 40, y:startY, r:sr };
    }
    const spacing = (sr*2 + 36);
    const startX = cX - ((sc-1)/2)*spacing;
    return { id, x:startX + (idx-1)*spacing, y:startY, r:sr };
  }
  return null;
}

function addAccessory(accId, overrides={}, pushHistory=true){
  const def = ACCESSORIES.find(a=>a.id===accId);
  if(!def) return;
  if(pushHistory) saveToHistory();

  const el = {
    id: uid("a"),
    accId,
    kind: def.kind,
    label: def.label,
    x: overrides.x ?? 500,
    y: overrides.y ?? 650,
    rot: overrides.rot ?? 0,
    scale: overrides.scale ?? 1,
    color: overrides.color ?? ($("#accColor")?.value || "#ffffff"),
    size: parseFloat($("#accSize")?.value || "1"),
    locked: false,
    z: Date.now()
  };

  // special: initials/text accessory
  if(def.kind === "miniText"){
    el.text = overrides.text ?? (prompt("Scrivi le iniziali / testo breve:", "E&L") || "E&L");
    el.font = "Playfair Display";
  }

  // place near selected ring if exists
  if(state.selectedId && state.selectedId.startsWith("ring:")){
    const rid = state.selectedId.split(":")[1];
    const r = getRingById(rid);
    if(r){
      el.x = r.x + (Math.random()*80-40);
      el.y = r.y + r.r + 60 + (Math.random()*60);
    }
  }

  state.elements.push(el);
  rebuildAccessories();
  selectElement(el.id);
  updatePrice();
}

/* ... (IL RESTO DEL FILE CONTINUA ESATTAMENTE COME NELL'ORIGINALE) ... */

</script>
</body>
</html>
