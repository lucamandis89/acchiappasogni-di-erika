<!doctype html>
<html lang="it">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Acchiappasogni di Erika</title>
  <link rel="manifest" href="/acchiappasogni-di-erika/manifest.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <meta name="description" content="Catalogo online per Acchiappasogni di Erika con ordini diretti su WhatsApp.">
  <link rel="apple-touch-icon" href="/acchiappasogni-di-erika/icons/icon-192.png">
  <style>
    :root{
      --bg1:#070a12;
      --bg2:#0b1430;
      --text:#e9efff;
      --muted:#b9c6ffcc;
      --accent:#7c5cff;
      --danger:#ff4d6d;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(124,92,255,.18), transparent 55%),
        radial-gradient(1000px 600px at 90% 30%, rgba(110,231,255,.12), transparent 55%),
        linear-gradient(180deg, var(--bg2), var(--bg1));
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 12px 80px}
    .topbar{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(7,10,18,.92), rgba(7,10,18,.65));
      border-bottom:1px solid rgba(35,54,95,.45);
    }
    .topbar-inner{max-width:1200px;margin:0 auto;padding:10px 12px; display:flex; gap:10px; align-items:center;}
    .brand{display:flex; gap:10px; align-items:center; min-width: 210px;}
    .logo{
      width:28px;height:28px;border-radius:10px;
      background: radial-gradient(circle at 30% 30%, rgba(110,231,255,.9), rgba(124,92,255,.7));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;
    }
    .brand h1{font-size:14px;margin:0;line-height:1.05}
    .brand small{display:block;color:var(--muted);font-size:11px;margin-top:2px}
    .btn{
      border:1px solid rgba(35,54,95,.65);
      background: rgba(15,27,51,.55);
      color:var(--text);
      padding:8px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
      box-shadow: 0 10px 24px rgba(0,0,0,.18);
      user-select:none;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(15,27,51,.85); border-color: rgba(124,92,255,.5)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(124,92,255,.75);
      background: linear-gradient(180deg, rgba(124,92,255,.9), rgba(124,92,255,.55));
    }
    .btn.danger{
      border-color: rgba(255,77,109,.65);
      background: rgba(255,77,109,.12);
    }
    .spacer{flex:1}
    .pill{
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(15,27,51,.55);
      border:1px solid rgba(35,54,95,.55);
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
    }

    .search-row{padding:12px 0 10px}
    .search{
      width:100%;
      border-radius: 14px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(15,27,51,.55);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      box-shadow: var(--shadow);
    }
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(15,27,51,.45);
      color: var(--muted);
      cursor:pointer;
      font-weight:800;
      font-size:12px;
      user-select:none;
    }
    .chip.active{
      background: rgba(124,92,255,.22);
      border-color: rgba(124,92,255,.65);
      color: var(--text);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, minmax(0, 1fr));} .brand{min-width: 0;} }
    @media (max-width: 560px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(15,27,51,.88), rgba(15,27,51,.55));
      border: 1px solid rgba(35,54,95,.6);
      overflow:hidden;
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      min-height: 250px;
    }
    .img{
      position:relative;
      width:100%;
      aspect-ratio: 4 / 3;
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .img img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
      filter: saturate(1.02) contrast(1.02);
    }
    .img .badge{
      position:absolute; top:10px; left:10px;
      padding:6px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      font-size:12px;
      font-weight:900;
    }
    .content{padding:12px 12px 10px; display:flex; flex-direction:column; gap:8px; flex:1}
    .title{font-weight:900; font-size:14px; line-height:1.2}
    .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; color:var(--muted); font-size:12px}
    .price{font-weight:900; color: #ffffff; font-size:14px}
    .row{display:flex; align-items:center; gap:8px; margin-top:auto}
    .qty{
      display:flex; align-items:center; gap:8px;
      border:1px solid rgba(35,54,95,.6);
      border-radius: 999px;
      padding:6px 8px;
      background: rgba(7,10,18,.35);
      color:var(--text);
      font-weight:900;
      min-width: 110px;
      justify-content:space-between;
    }
    .qbtn{
      width:26px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(35,54,95,.6);
      background: rgba(15,27,51,.7);
      cursor:pointer;
      user-select:none;
    }
    .qbtn:active{transform: translateY(1px)}
    .add{flex:1; justify-content:center}
    .footerbar{
      position:fixed; left:0; right:0; bottom:0; z-index:80;
      background: rgba(7,10,18,.9);
      border-top:1px solid rgba(35,54,95,.45);
      backdrop-filter: blur(10px);
    }
    .footerbar-inner{
      max-width:1200px;margin:0 auto;padding:10px 12px;
      display:flex; gap:10px; align-items:center;
    }

    /* Modal */
    .modal-back{
      position:fixed; inset:0; z-index:200;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 14px;
    }
    .modal{
      width:min(920px, 100%);
      background: linear-gradient(180deg, rgba(15,27,51,.98), rgba(15,27,51,.86));
      border:1px solid rgba(35,54,95,.7);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      overflow:hidden;
    }
    .modal-head{
      display:flex; align-items:center; gap:10px;
      padding:12px 12px;
      border-bottom:1px solid rgba(35,54,95,.55);
    }
    .modal-head h2{margin:0;font-size:14px}
    .modal-body{padding:12px}
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){ .form{grid-template-columns:1fr;} }
    label{font-size:12px;color:var(--muted);font-weight:800}
    input, select, textarea{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(35,54,95,.6);
      background: rgba(7,10,18,.35);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .hr{height:1px;background: rgba(35,54,95,.5); margin:12px 0}
    .admin-list{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
      max-height: 320px;
      overflow:auto;
      padding-right:6px;
    }
    .admin-item{
      display:flex; gap:10px; align-items:center;
      padding:10px;
      border:1px solid rgba(35,54,95,.6);
      border-radius: 14px;
      background: rgba(7,10,18,.28);
    }
    .thumb{width:54px;height:54px;border-radius:12px;overflow:hidden;background: rgba(255,255,255,.06); flex:0 0 auto}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .admin-item .info{flex:1; min-width:0}
    .admin-item .info b{display:block;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .admin-item .info small{display:block;color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .admin-item .actions{display:flex; gap:8px; align-items:center}
    .mini{padding:8px 10px; font-size:12px}
  
    /* ====== CONFIGURATORE (UTENTE) ====== */
    .builder-grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
    }
    @media (max-width: 860px){ .builder-grid{grid-template-columns:1fr;} }

    .box{
      border:1px solid rgba(35,54,95,.6);
      background: rgba(7,10,18,.28);
      border-radius: 14px;
      padding:12px;
    }
    .box h3{margin:0 0 10px 0;font-size:13px}
    .small{font-size:12px;color:rgba(185,198,255,.85)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 520px){ .row2{grid-template-columns:1fr;} }

    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(35,54,95,.55);
      background: rgba(15,27,51,.55);
      border-radius: 14px;
      padding:10px;
    }
    .item-head{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin-bottom:8px;
    }
    .item-head b{font-size:12px}
    .item-actions{margin-left:auto;display:flex;gap:8px}

    .preview{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    .preview-inner{padding:12px}
    .preview-img{
      width:100%;
      max-height:220px;
      object-fit:contain;
      display:none;
      border-radius:12px;
      border:1px solid rgba(35,54,95,.5);
      background: rgba(0,0,0,.15);
    }
    .hr2{height:1px;background: rgba(35,54,95,.5); margin:10px 0}
    .badge2{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(15,27,51,.45);
      color: rgba(185,198,255,.95);
      font-size:12px;font-weight:800;
    }

  
    /* ====== CONFIGURATORE SEMPLICE (CLIENTI) ====== */
    .lite-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 860px){ .lite-grid{grid-template-columns:1fr;} }
    .stage{
      position:relative;
      width:100%;
      height:420px;
      border-radius:14px;
      border:1px solid rgba(35,54,95,.55);
      background:
        radial-gradient(600px 320px at 30% 20%, rgba(124,92,255,.16), transparent 60%),
        radial-gradient(520px 280px at 80% 60%, rgba(110,231,255,.12), transparent 60%),
        rgba(0,0,0,.10);
      overflow:hidden;
      touch-action: none;
      user-select:none;
    }
    .stage .base-ring{
      position:absolute;
      left:50%; top:34%;
      width:260px; height:260px;
      transform: translate(-50%,-50%);
      border-radius:50%;
      border:6px solid rgba(233,239,255,.92);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      opacity:.95;
      pointer-events:none;
      display:none;
    }

    .stage .base-shape{
      position:absolute;
      left:50%; top:34%;
      width:270px; height:270px;
      transform: translate(-50%,-50%);
      pointer-events:none;
      filter: drop-shadow(0 18px 40px rgba(0,0,0,.35));
      opacity:.98;
      color: rgba(233,239,255,.92);
    }
    .stage .web{
      position:absolute;
      left:50%; top:34%;
      width:230px; height:230px;
      transform: translate(-50%,-50%);
      opacity:.55;
      pointer-events:none;
    }
    .dl-el{
      position:absolute;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:grab;
      transform: translate(-50%,-50%);
      padding:6px;
      border-radius:12px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(7,10,18,.25);
      backdrop-filter: blur(6px);
      box-shadow: 0 12px 26px rgba(0,0,0,.22);
      touch-action:none;
    }
    .dl-el:active{cursor:grabbing}
    .dl-el.selected{
      border-color: rgba(124,92,255,.85);
      box-shadow: 0 0 0 2px rgba(124,92,255,.25), 0 16px 34px rgba(0,0,0,.28);
    }
    .dl-el .emoji{font-size:22px; line-height:1}
    .dl-ring{
      width:110px;height:110px;border-radius:50%;
      border:4px solid rgba(233,239,255,.9);
      background: rgba(255,255,255,.03);
    }
    .dl-ring.small{width:78px;height:78px;border-width:3px}
    .palette{
      display:flex; gap:8px; flex-wrap:wrap;
      margin-top:10px;
    }
    .palette .chip{
      display:flex; align-items:center; gap:8px;
    }
    .helpbox{
      color: rgba(185,198,255,.85);
      font-size:12px;
      line-height:1.35;
    }
    .minirow{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

  
    /* ====== CONFIGURATORE SEMPLICE (CLIENTI) ====== */
    .lite-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 860px){ .lite-grid{grid-template-columns:1fr;} }
    .stage{
      position:relative;
      width:100%;
      height:380px;
      border-radius:14px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(0,0,0,.15);
      overflow:hidden;
      touch-action:none;
    }
    .base-ring{
      position:absolute; left:50%; top:52%;
      width: 260px; height:260px;
      transform: translate(-50%,-50%);
      border-radius: 999px;
      border: 10px solid rgba(233,239,255,.92);
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      pointer-events:none;
    }
    .web{position:absolute; left:50%; top:52%; width:260px; height:260px; transform: translate(-50%,-50%); pointer-events:none; opacity:.95}
    .dl-el{position:absolute; transform: translate(-50%,-50%); cursor:grab; user-select:none}
    .dl-el.selected{outline:2px solid rgba(124,92,255,.95); outline-offset: 4px; border-radius: 12px}
    .dl-ring{width:70px;height:70px;border-radius:999px;border:6px solid rgba(233,239,255,.88); background: rgba(255,255,255,.02)}
    .dl-ring.small{width:48px;height:48px;border-width:5px}
    .emoji{font-size:34px; filter: drop-shadow(0 10px 18px rgba(0,0,0,.35))}
    .minirow{display:flex;gap:8px;flex-wrap:wrap}
    .helpbox{font-size:12px;color:rgba(185,198,255,.9);line-height:1.35}
    .palette{display:flex;gap:8px;flex-wrap:wrap}
    .preset-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    @media (max-width:520px){ .preset-grid{grid-template-columns:1fr;} }
    .preset{
      text-align:left;
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(35,54,95,.55);
      background: rgba(15,27,51,.45);
      color: var(--text);
      cursor:pointer;
      user-select:none;
    }
    .preset b{display:block;font-size:12px}
    .preset small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .preset:active{transform: translateY(1px)}

    /* ===== Mobile layout tuning (no page zoom needed) ===== */
    html, body{
      width:100%;
      height:100%;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      overscroll-behavior-y: none;
    }

    /* Prefer vertical scrolling; keep drag interactions inside stage */
    body{ touch-action: pan-y; }
    body.builder-open{ touch-action: none; }


    /* Make tap targets comfortable on phone */
    @media (max-width: 560px){
      .wrap{padding:12px 10px 110px}
      .topbar-inner{flex-wrap:wrap}
      .brand{min-width:auto}

      .btn{
        padding:10px 14px;
        font-size:14px;
      }
      .chip{
        padding:9px 12px;
        font-size:14px;
      }
      .pill{
        padding:10px 12px;
        font-size:14px;
      }

      /* Catalog grid: single column on small screens */
      .grid{ grid-template-columns: 1fr !important; }

      /* Builder lite: one column, bigger preview and controls */
      .lite-grid{ grid-template-columns: 1fr !important; }
      .stage{
        height: min(68vh, 560px) !important;
        border-radius: 16px;
      }

      /* Bigger base preview so it fits and is usable without page zoom */
      .base-ring{
        width: min(82vw, 360px) !important;
        height: min(82vw, 360px) !important;
        border-width: 7px !important;
        top: 34% !important;
      }
      .base-shape{
        width: min(86vw, 380px) !important;
        height: min(86vw, 380px) !important;
        top: 34% !important;
      }
      .web{
        width: min(78vw, 340px) !important;
        height: min(78vw, 340px) !important;
        top: 34% !important;
      }

      /* Bigger draggable accessories (the little icons you move) */
      .dl-el{ transform: translate(-50%,-50%) scale(1.12) !important; }
      .dl-el .emoji{ font-size: 24px !important; }

      /* Modal body spacing */
      .modal-body{padding:12px}
      .box{padding:12px}
    }

  
/* Fullscreen fallback for builder */
.modal-back.fs-fallback{
  position: fixed !important;
  inset: 0 !important;
  z-index: 9999 !important;
  background: rgba(0,0,0,.85) !important;
}
.modal-back.fs-fallback .modal{
  width: 100% !important;
  max-width: 100% !important;
  height: 100% !important;
  max-height: 100% !important;
  border-radius: 0 !important;
}
.modal-back.fs-fallback .modal-body{
  height: calc(100% - 64px) !important;
  overflow: auto !important;
}
.modal-back.fs-fallback #dlStage{
  height: 70vh !important;
}


/* --- STUDIO MODE: configuratore "da app" su mobile --- */
body.studio-mode{
  overscroll-behavior: none;
}
#builderLiteBack.studio-mode{
  align-items: stretch !important;
  justify-content: stretch !important;
}
#builderLiteBack.studio-mode .modal{
  width: 100vw !important;
  height: 100vh !important;
  max-width: none !important;
  border-radius: 0 !important;
}
#builderLiteBack.studio-mode .modal-body{
  height: calc(100vh - 64px) !important; /* header */
  overflow: auto !important; /* abilita scroll per vedere tutti i controlli */
}
#builderLiteBack.studio-mode .lite-grid{
  height: 100%;
  display: grid;
  grid-template-columns: 1.2fr .8fr;
  gap: 14px;
}
/* Colonna destra scrollabile */
#builderLiteBack.studio-mode .lite-grid > .box:last-child{
  overflow: auto;
  max-height: 100%;
  -webkit-overflow-scrolling: touch;
}
/* Stage pi√π grande e centrato */
#builderLiteBack.studio-mode #dlStage{
  height: min(72vh, 620px) !important;
  max-height: 72vh !important;
  touch-action: none;
}
/* Su schermi stretti: layout a colonna */
@media (max-width: 820px){
  /* Modal in colonna: anteprima sopra, controlli sotto */
  #builderLiteBack.studio-mode .lite-grid{
    grid-template-columns: 1fr;
    height: auto;
  }

  /* Anteprima sempre visibile, ma non deve ‚Äúmangiare‚Äù tutta la pagina */
  #builderLiteBack.studio-mode .lite-grid > .box:first-child{
    position: sticky;
    top: 0;
    z-index: 5;
    background: linear-gradient(180deg, rgba(7,10,18,.96), rgba(7,10,18,.70));
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(35,54,95,.45);
  }

  #builderLiteBack.studio-mode #dlStage{
    height: 44vh !important;
    max-height: 44vh !important;
  }

  /* Controlli: pannello chiaro e scroll naturale */
  #builderLiteBack.studio-mode .lite-grid > .box:last-child{
    overflow: visible;
    max-height: none;
    margin-top: 12px;
  }

  /* ‚Äúmaniglia‚Äù visiva per far capire che si pu√≤ scorrere */
  #builderLiteBack.studio-mode .lite-grid > .box:last-child::before{
    content: '';
    display: block;
    width: 56px;
    height: 6px;
    border-radius: 999px;
    background: rgba(233,239,255,.22);
    margin: 2px auto 10px;
  }
}
/* Fallback fullscreen (quando API non disponibile) */
#builderLiteBack.fs-fallback{
  position: fixed !important;
  inset: 0 !important;
  display: flex !important;
  background: rgba(0,0,0,.55);
  z-index: 9999 !important;
}
#builderLiteBack.fs-fallback .modal{
  width: 100vw !important;
  height: 100vh !important;
  border-radius: 0 !important;
  max-width: none !important;
}


/* === STUDIO MODE (MOBILE): controlli come "cassetto" (bottom sheet) === */
#builderLiteBack.studio-mode .studio-sheet-handle{
  width: 64px;
  height: 6px;
  border-radius: 999px;
  margin: 6px auto 10px;
  background: rgba(255,255,255,.18);
}

#builderLiteBack.studio-mode .studio-sheet{
  position: fixed !important;
  left: 10px !important;
  right: 10px !important;
  bottom: calc(10px + env(safe-area-inset-bottom)) !important;
  z-index: 99999 !important;
  border-radius: 18px !important;
  background: rgba(6,10,22,.94) !important;
  border: 1px solid rgba(255,255,255,.08) !important;
  box-shadow: 0 16px 50px rgba(0,0,0,.55) !important;
  overflow: hidden !important; /* scroll solo nell'inner */
}

#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll{
  height: 100%;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 12px;
  font-size: 16px !important;
  line-height: 1.35 !important;
}

#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll h2,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll h3,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll .section-title{
  font-size: 18px !important;
}
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll label,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll .muted,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll small{
  font-size: 14px !important;
}
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll input,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll select,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll textarea{
  font-size: 16px !important;
}
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll .btn,
#builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll button{
  font-size: 16px !important;
}

/* Mobile: stage sempre visibile e mai tagliato */
@media (max-width: 820px){
  /* blocca lo scroll della pagina sotto mentre sei in studio */
  #builderLiteBack.studio-mode .modal-body{
    overflow: hidden !important;
  }

  /* niente grid: lo stage resta "pagina", i controlli diventano sheet */
  #builderLiteBack.studio-mode .lite-grid{
    display: block !important;
    height: 100% !important;
  }

  /* box sinistro: NON clippare lo stage (taglio cerchio) */
  #builderLiteBack.studio-mode .lite-grid > .box:first-child{
    height: auto !important;
    overflow: visible !important;
    padding-bottom: calc(var(--studioSheetH, 30vh) + 16px) !important;
  }

  /* IMPORTANT: evita che qualche card/box tagli il cerchio */
  #builderLiteBack.studio-mode .lite-grid > .box:first-child *{
    overflow: visible;
  }

  /* stage wrap: quadrato centrato */
  #builderLiteBack.studio-mode #dlStageWrap{
    display:flex !important;
    align-items:center !important;
    justify-content:center !important;
    overflow: visible !important;
    padding: 8px 10px 10px !important;
    /* riserva spazio esatto per il canvas, cos√¨ non viene mai "clippato" */
    height: var(--studioStageSize, min(88vw, 380px)) !important;
  }

  /* canvas: dimensione calcolata in JS */
  #builderLiteBack.studio-mode #dlStage{
    width: var(--studioStageSize, min(88vw, 380px)) !important;
    height: var(--studioStageSize, min(88vw, 380px)) !important;
    max-width: 100% !important;
    max-height: 100% !important;
    touch-action: none;
  }
}

/* Portrait: pi√π spazio allo stage, cassetto compatto */
@media (max-width: 820px) and (orientation: portrait){
  #builderLiteBack.studio-mode #dlStageWrap{
    padding: 6px 10px 10px !important;
  }
}

/* Landscape: ancora pi√π spazio allo stage + testo leggermente pi√π grande */
@media (max-width: 1024px) and (orientation: landscape){
  #builderLiteBack.studio-mode .studio-sheet .studio-sheet-scroll{
    font-size: 17px !important;
  }
  #builderLiteBack.studio-mode #dlStageWrap{
    padding: 6px 10px 6px !important;
  }
}


/* ===== Simulator UI (stile app) ===== */
#builderLiteBack .modal{ width: min(1120px, 96vw); max-width: 1120px; }
#builderLiteBack .modal-body{ padding-bottom: 14px; }
body.builder-open{ touch-action: none; } /* serve per pinch/zoom affidabile su Android */
#dlStage{ touch-action: none; } /* pinch/drag sullo stage */

@media (max-width: 900px){
  #builderLiteBack .lite-grid{ display: block; }
  #builderLiteBack .lite-grid > .box:first-child{ margin-bottom: 10px; }
  /* stage sopra, sheet sotto */
  #builderLiteBack .sim-sheet{
    position: fixed;
    left: 10px;
    right: 10px;
    bottom: 10px;
    z-index: 9999;
    height: var(--simSheetH, 42vh);
    max-height: 82vh;
    overflow: hidden;
    padding: 0;
    border-radius: 18px;
    background: rgba(6,10,22,.92);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
  }
  #builderLiteBack .sim-sheet-top{
    padding: 10px 12px 8px;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  #builderLiteBack .sim-handle{
    width: 64px; height: 6px; border-radius: 999px;
    margin: 4px auto 10px;
    background: rgba(255,255,255,.18);
    touch-action: none;
  }
  #builderLiteBack .sim-tabs{
    display: flex;
    gap: 8px;
    justify-content: space-between;
  }
  #builderLiteBack .sim-tab{
    flex: 1;
    padding: 10px 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.06);
    color: #e9efff;
    font-weight: 700;
    font-size: 14px;
  }
  #builderLiteBack .sim-tab.active{
    background: rgba(132, 92, 255, .22);
    border-color: rgba(132,92,255,.55);
  }
  #builderLiteBack .sim-panels{
    height: calc(100% - 74px);
    overflow: auto;
    -webkit-overflow-scrolling: touch;
    padding: 12px 12px 16px;
  }
  #builderLiteBack .sim-title{
    font-size: 16px;
    margin: 0 0 10px;
  }
  /* testo pi√π grande nel pannello */
  #builderLiteBack label{ font-size: 14px; }
  #builderLiteBack input, #builderLiteBack select, #builderLiteBack textarea{
    font-size: 16px;
  }
  #builderLiteBack .chip{ font-size: 15px; padding: 10px 12px; }
  #builderLiteBack .preset{ font-size: 14px; }
  /* stage: lascia spazio al cassetto */
  #builderLiteBack .lite-grid > .box:first-child{
    padding-bottom: calc(var(--simSheetH, 42vh) + 22px);
  }
  #builderLiteBack .stage{
    width: var(--studioStageSize, min(84vw, 360px));
    height: var(--studioStageSize, min(84vw, 360px));
    margin: 0 auto;
  }
}
@media (min-width: 901px){
  /* desktop: sheet normale a destra, ma con tab */
  #builderLiteBack .sim-sheet-top{ margin-bottom: 12px; }
  #builderLiteBack .sim-handle{ display:none; }
  #builderLiteBack .sim-tabs{ display:flex; gap:8px; flex-wrap:wrap; }
  #builderLiteBack .sim-tab{ padding:10px 12px; border-radius: 14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); color:#e9efff; font-weight:700; }
  #builderLiteBack .sim-tab.active{ background: rgba(132, 92, 255, .22); border-color: rgba(132,92,255,.55); }
  #builderLiteBack .sim-panels{ }
}
#builderLiteBack .sim-panel{ display:none; }
#builderLiteBack .sim-panel.active{ display:block; }


/* ===== Game-like UI override (ispirato a simulator, senza copiare asset) ===== */
#builderLiteBack.studio-mode .modal{
  background: linear-gradient(180deg, rgba(245,248,255,.98), rgba(236,242,255,.98)) !important;
  color: #101423 !important;
  border: 1px solid rgba(20,30,60,.10) !important;
}
#builderLiteBack.studio-mode .modal-header{
  background: transparent !important;
  border-bottom: 1px solid rgba(20,30,60,.10) !important;
}
#builderLiteBack.studio-mode .modal-header h2,
#builderLiteBack.studio-mode .modal-header h1,
#builderLiteBack.studio-mode .modal-header .title{
  color:#101423 !important;
  text-shadow: none !important;
}
#builderLiteBack.studio-mode .lite-grid > .box{
  background: rgba(255,255,255,.70) !important;
  border: 1px solid rgba(20,30,60,.10) !important;
  box-shadow: 0 10px 28px rgba(10,20,60,.12) !important;
}
#builderLiteBack.studio-mode #dlStageWrap{
  background: rgba(255,255,255,.65) !important;
  border: 1px solid rgba(20,30,60,.10) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.55) !important;
}
#builderLiteBack.studio-mode #dlStage{
  background: transparent !important;
}

/* Bottom sheet: pi√π ‚Äúgioco‚Äù e leggibile */
#builderLiteBack.studio-mode .sim-sheet{
  background: rgba(255,255,255,.92) !important;
  color:#101423 !important;
  border: 1px solid rgba(20,30,60,.12) !important;
  box-shadow: 0 14px 44px rgba(10,20,60,.18) !important;
}
#builderLiteBack.studio-mode .sim-sheet .studio-sheet-handle,
#builderLiteBack.studio-mode .sim-sheet .sim-handle{
  background: rgba(20,30,60,.25) !important;
}
#builderLiteBack.studio-mode .sim-sheet *{
  color:#101423 !important;
}
#builderLiteBack.studio-mode .sim-sheet label,
#builderLiteBack.studio-mode .sim-sheet .muted{
  color: rgba(16,20,35,.70) !important;
}

/* Tabs stile ‚Äúpulsanti gioco‚Äù */
#builderLiteBack .sim-tabs{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}
#builderLiteBack .sim-tab{
  border-radius: 16px !important;
  padding: 10px 14px !important;
  font-size: 16px !important;
  font-weight: 800 !important;
  border: 1px solid rgba(20,30,60,.12) !important;
  background: rgba(245,248,255,.92) !important;
}
#builderLiteBack .sim-tab.active{
  background: linear-gradient(180deg, rgba(120,200,255,.70), rgba(150,180,255,.70)) !important;
  border-color: rgba(70,120,255,.35) !important;
}

/* Chip stile ‚Äútool‚Äù grande */
#builderLiteBack .chip{
  border-radius: 999px !important;
  padding: 10px 14px !important;
  font-size: 16px !important;
  font-weight: 800 !important;
  border: 1px solid rgba(20,30,60,.12) !important;
  background: rgba(245,248,255,.92) !important;
}
#builderLiteBack .chip:hover{ filter: brightness(1.02); }

/* Bottoni pi√π grandi e ‚Äútouch friendly‚Äù */
#builderLiteBack .btn{
  border-radius: 18px !important;
  padding: 12px 16px !important;
  font-size: 16px !important;
  font-weight: 900 !important;
  border: 1px solid rgba(20,30,60,.12) !important;
}
#builderLiteBack .btn.primary{
  background: linear-gradient(180deg, rgba(90,210,140,.85), rgba(60,190,120,.85)) !important;
  border-color: rgba(40,160,90,.35) !important;
}
#builderLiteBack .btn.danger{
  background: linear-gradient(180deg, rgba(255,130,140,.78), rgba(255,110,120,.78)) !important;
  border-color: rgba(220,60,70,.28) !important;
}
#builderLiteBack .btn:not(.primary):not(.danger){
  background: rgba(245,248,255,.92) !important;
}

/* Input pi√π leggibili */
#builderLiteBack input, #builderLiteBack select, #builderLiteBack textarea{
  font-size: 16px !important;
  border-radius: 14px !important;
  border: 1px solid rgba(20,30,60,.12) !important;
  background: rgba(255,255,255,.88) !important;
}

/* Mobile: stage un filo pi√π piccolo per lasciare spazio al sheet */
@media (max-width: 900px){
  #builderLiteBack.studio-mode { --stageSafePad: 110px !important; }
  #builderLiteBack.studio-mode #dlStageWrap{ padding: 10px 12px 12px !important; }
}


/* === SIMULATOR: barra "gioco" con 3 bottoni rotondi + colori rapidi === */
#builderLiteBack .sim-quick-colors{ display:flex; gap:10px; margin-top:8px; }
#builderLiteBack .sim-quick-colors .qdot{
  width:34px; height:34px; border-radius:999px;
  border:1px solid rgba(255,255,255,.20);
  background: rgba(255,255,255,.10);
}
#builderLiteBack .sim-quick-colors .qdot.d-red { background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,90,90,.35) 60%, rgba(255,255,255,.08) 100%); }
#builderLiteBack .sim-quick-colors .qdot.d-blue{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(90,150,255,.35) 60%, rgba(255,255,255,.08) 100%); }
#builderLiteBack .sim-quick-colors .qdot.d-gold{ background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(255,210,90,.35) 60%, rgba(255,255,255,.08) 100%); }

@media (max-width: 900px){
  #builderLiteBack .sim-tabs{ display:none; }
  }

/* --- Color picker overlay --- */
.dl-color-overlay{
  position:fixed; inset:0; z-index:999999;
  background:rgba(0,0,0,.55);
  display:flex; align-items:center; justify-content:center;
  padding:16px;
}
.dl-color-card{
  width:min(520px, 92vw);
  background:rgba(10,18,35,.92);
  border:1px solid rgba(255,255,255,.08);
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.55);
  padding:14px 14px 12px;
  backdrop-filter: blur(10px);
}
.dl-color-title{ font-weight:800; margin-bottom:10px; }
.dl-color-swatches{
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:10px;
  margin-bottom:12px;
}
.dl-swatch{
  width:100%; aspect-ratio:1/1;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.15);
  box-shadow: inset 0 0 0 2px rgba(0,0,0,.15);
}
.dl-swatch:active{ transform: scale(.98); }
.dl-color-actions{ display:flex; justify-content:flex-end; gap:10px; }

/* --- Colorable accessory rendering --- */
.dl-lite-el .dl-token{
  width:64px; height:64px;
  border-radius:999px;
  border:2px solid rgba(255,255,255,.30);
  box-shadow: 0 10px 25px rgba(0,0,0,.35), inset 0 0 0 2px rgba(0,0,0,.10);
}
.dl-lite-el .dl-feather{
  width:72px; height:72px;
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
}


/* --- SIMULATOR ACCESSORI (catalogo) --- */
.accessory-drawer{margin-top:10px}
.acc-cats{display:flex;gap:8px;overflow:auto;padding:6px 2px 10px 2px;-webkit-overflow-scrolling:touch}
.acc-cats button{white-space:nowrap;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#eaf2ff;border-radius:999px;padding:8px 12px;font-weight:700;font-size:13px}
.acc-cats button.active{background:rgba(120,140,255,.25);border-color:rgba(170,180,255,.35)}
.acc-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;max-height:220px;overflow:auto;padding:8px 2px 2px 2px;-webkit-overflow-scrolling:touch}
@media (min-width: 520px){.acc-grid{grid-template-columns:repeat(6,minmax(0,1fr));max-height:260px}}
.acc-tile{border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);border-radius:14px;padding:10px 6px;display:flex;flex-direction:column;align-items:center;gap:6px;user-select:none;touch-action:manipulation}
.acc-tile .ico{width:42px;height:42px;display:grid;place-items:center}
.acc-tile .lbl{font-size:11px;line-height:1.1;color:rgba(255,255,255,.86);text-align:center}
.acc-tile:active{transform:scale(.98)}
.color-pop{position:absolute;left:12px;right:12px;bottom:84px;z-index:50;border:1px solid rgba(255,255,255,.14);background:rgba(12,18,34,.92);backdrop-filter:blur(10px);border-radius:18px;padding:10px 10px 12px 10px;display:none}
.color-pop.show{display:block}
.color-pop .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
.color-pop h4{margin:0;font-size:13px;color:#eaf2ff}
.color-swatch{display:grid;grid-template-columns:repeat(8,1fr);gap:8px;margin-top:10px}
.color-swatch button{height:28px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:transparent}
.color-swatch button.active{outline:2px solid rgba(170,180,255,.7)}
.smallhint{font-size:11px;color:rgba(255,255,255,.6);margin-top:8px}

</style>
 </head>
 <body>
  <div class="topbar">
   <div class="topbar-inner">
    <div class="brand">
     <div class="logo">‚ú¶</div>
     <div>
      <h1>Acchiappasogni di Erika</h1>
      <small>Catalogo ‚Ä¢ Ordina su WhatsApp</small>
     </div>
    </div>
    <button class="btn primary" id="btnCustomizer">ü™Ñ CREA IL TUO ACCHIAPPASOGNI</button>
    <button class="btn" id="btnGifts">üéÅ BOMBONIERE &amp; REGALI</button>
    <div class="spacer"></div>
    <button class="btn" id="btnSettings">‚öôÔ∏è Impostazioni</button>
    <button class="btn" id="btnCart">üõí Carrello <span class="pill" id="cartCount">0</span></button>
   </div>
  </div>
  <div class="wrap">
   <div class="search-row">
    <input class="search" id="search" placeholder="Cerca (nome o categoria)...">
    <div class="filters" id="filters"></div>
   </div>
   <div class="grid" id="grid"></div>
  </div>
  <div class="footerbar">
   <div class="footerbar-inner">
    <div class="pill">
     Totale: <b id="cartTotal">‚Ç¨ 0,00</b>
    </div>
    <div class="spacer"></div>
    <button class="btn primary" id="btnWhatsApp">üì≤ Ordina su WhatsApp</button>
   </div>
  </div>
  <!-- MODAL: CARRELLO -->
  <div class="modal-back" id="cartModalBack">
   <div class="modal">
    <div class="modal-head">
     <h2>üõí Carrello</h2>
     <div class="spacer"></div>
     <button class="btn" id="btnCloseCart">‚úñ Chiudi</button>
    </div>
    <div class="modal-body">
     <div id="cartList" class="admin-list"></div>
     <div class="hr"></div>
     <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <div class="pill">
       Totale: <b id="cartTotal2">‚Ç¨ 0,00</b>
      </div>
      <div class="spacer"></div>
      <button class="btn danger" id="btnClearCart">üóë Svuota</button>
      <button class="btn primary" id="btnWhatsApp2">üì≤ Ordina su WhatsApp</button>
     </div>
    </div>
   </div>
  </div>
  <!-- MODAL: SETTINGS / ADMIN -->
  <div class="modal-back" id="adminModalBack">
   <div class="modal">
    <div class="modal-head">
     <h2>‚öôÔ∏è Impostazioni (Admin)</h2>
     <div class="spacer"></div>
     <button class="btn" id="btnCloseAdmin">‚úñ Chiudi</button>
    </div>
    <div class="modal-body" id="adminBody">
     <!-- login -->
     <div id="adminLogin">
      <div class="hint" style="margin-bottom:10px">
       Inserisci password per accedere alle impostazioni (default: <b>1234</b>)
      </div>
      <div class="form">
       <div>
        <label>Password</label> <input id="adminPass" type="password" placeholder="1234">
        <div class="hint">Suggerimento: puoi cambiarla dopo l‚Äôaccesso.</div>
       </div>
       <div style="display:flex;align-items:flex-end;gap:10px">
        <button class="btn primary" id="btnAdminLogin">üîì Entra</button>
        <button class="btn" id="btnAdminCancel">Annulla</button>
       </div>
      </div>
     </div>
     <!-- panel -->
     <div id="adminPanel" style="display:none">
      <div class="form">
       <div>
        <label>Password Admin (cambia)</label> <input id="newAdminPass" type="password" placeholder="Nuova password">
        <div class="hint">Se lasci vuoto, non cambia.</div>
       </div>
       <div>
        <label>WhatsApp numero (formato +39...)</label> <input id="waNumber" placeholder="+39XXXXXXXXXX">
        <div class="hint">Serve per inviare l‚Äôordine su WhatsApp.</div>
       </div>
       <div>
        <label>Prezzo rapido per TUTTI</label>
        <div style="display:flex; gap:8px">
         <input id="bulkPrice" type="number" step="0.01" placeholder="5">
         <button class="btn primary" id="btnBulkApply">‚úÖ Applica</button>
        </div>
        <div class="hint">Esempio: 5 ‚Üí tutti i prodotti diventano ‚Ç¨ 5.</div>
       </div>
       <div>
        <label>Backup / Import configurazione (per aggiornare tutti via GitHub)</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap">
         <button class="btn primary" id="btnExportConfig">üì§ Esporta JSON</button>
         <label class="btn" style="cursor:pointer"> üì• Importa JSON <input id="importConfigFile" type="file" accept="application/json" style="display:none"> </label>
        </div>
        <div class="hint">
         ‚Ä¢ <b>Esporta JSON</b> ti scarica un file pronto da caricare su GitHub come <code>data/products.json</code>.
         <br>
         ‚Ä¢ <b>Importa JSON</b> carica sul tuo telefono una configurazione (override) senza toccare GitHub.
        </div>
       </div>
       <div>
        <label>Ripristina catalogo originale</label>
        <button class="btn danger" id="btnResetAll">‚ôªÔ∏è Reset completo</button>
        <div class="hint">Cancella le modifiche salvate nel telefono.</div>
       </div>
      </div>
      <div class="hr"></div>
      <h3 style="margin:0 0 10px 0;font-size:13px">üì¶ Prodotti (aggiungi / modifica / elimina)</h3>
      <div class="form">
       <div>
        <label>Seleziona prodotto da modificare</label> <select id="editSelect"></select>
        <div class="hint">Oppure crea un nuovo prodotto qui sotto.</div>
       </div>
       <div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnLoadToForm">‚úçÔ∏è Carica in form</button>
        <button class="btn danger" id="btnDeleteSelected">üóë Elimina prodotto</button>
        <button class="btn danger" id="btnDeleteCategory">üóë Elimina categoria</button>
       </div>
       <div>
        <label>Titolo</label> <input id="fTitle" placeholder="Acchiappasogni - Modello X">
       </div>
       <div>
        <label>Categoria</label>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
         <input id="fCategory" list="catDatalist" placeholder="Acchiappasogni Classici">
         <button class="btn" id="btnCreateCategory" type="button">‚ûï Crea categoria</button>
        </div>
        <datalist id="catDatalist"></datalist>
       </div>
       <div style="grid-column:1 / -1">
        <label>Descrizione (testo sotto al titolo)</label> <textarea id="fDesc" placeholder="Esempio: Fatto a mano, diametro 30 cm, colori personalizzabili..."></textarea>
       </div>
       <div>
        <label>Prezzo (‚Ç¨)</label> <input id="fPrice" type="number" step="0.01" placeholder="5">
       </div>
       <div>
        <label>Pubblicazione</label>
        <div style="display:flex;align-items:center;gap:10px">
         <input id="fPublished" type="checkbox" style="width:auto">
         <div class="hint" style="margin:0">Se attivo, il prodotto si vede nella Home.</div>
        </div>
       </div>
       <div>
        <label>Foto (dal telefono / galleria)</label> <input id="fImageFile" type="file" accept="image/*">
        <div class="hint">
         Se carichi da galleria: viene salvata nel telefono (localStorage).
         <br>
         Se vuoi che si veda su TUTTI i telefoni, carica la foto nel repo e poi metti il percorso nel campo sotto.
        </div>
       </div>
       <div style="grid-column:1 / -1">
        <label>Oppure percorso immagine (GitHub)</label> <input id="fImagePath" placeholder="foto.jpg oppure cartella/foto.jpg">
        <div class="hint">Se scrivi solo il nome file (es: foto.jpg) la cerca nella cartella base configurata.</div>
       </div>
       <div style="display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap">
        <button class="btn primary" id="btnSaveProduct">üíæ Salva (aggiungi/modifica)</button>
        <button class="btn" id="btnNewProduct">‚ûï Nuovo</button>
        <button class="btn primary" id="btnPublishNow">üì£ Pubblica in Home</button>
        <button class="btn" id="btnHideNow">üôà Nascondi dalla Home</button>
       </div>
      </div>
      <div class="hr"></div>
      <div class="hint">
       ‚úÖ Se una foto non carica, il prodotto resta visibile (con placeholder).
       <br>
       ‚úÖ Le foto da galleria vengono ottimizzate (pi√π leggere) prima di salvarle.
      </div>
     </div>
    </div>
   </div>
  </div>
  <!-- MODAL: CONFIGURATORE ACCHIAPPASOGNI (UTENTE) -->
  <div class="modal-back" id="builderModalBack">
   <div class="modal">
    <div class="modal-head">
     <h2>ü™Ñ Crea il tuo Acchiappasogni</h2>
     <div class="spacer"></div>
     <button class="btn" id="btnCloseBuilder">‚úñ Chiudi</button>
    </div>
    <div class="modal-body">
     <div class="builder-grid">
      <!-- SINISTRA: FORM -->
      <div class="box">
       <h3>1) Base</h3>
       <div class="row2">
        <div>
         <label>Modello</label> <select id="bModel"> <option value="Classico (1)">Classico (1)</option> <option value="Cerchio (2)">Cerchio (2)</option> <option value="Luna (3)">Luna (3)</option> <option value="Cuore (4)">Cuore (4)</option> <option value="Stella (5)">Stella (5)</option> <option value="Chakra (6)">Chakra (6)</option> <option value="Yin &amp; Yang (7)">Yin &amp; Yang (7)</option> <option value="Personalizzato (8)">Personalizzato (8)</option> <option value="Tema speciale (es. REAL HASTA LA MUERTE)">Tema speciale</option> </select>
        </div>
        <div>
         <label>Diametro (cm)</label> <select id="bDiameter"> <option>15</option><option>20</option><option>25</option> <option selected>30</option><option>35</option><option>40</option><option>50</option> </select>
        </div>
        <div>
         <label>Colore cerchio</label> <input id="bRingColor" placeholder="Es: bianco / nero / oro / legno...">
        </div>
        <div>
         <label>Colore piume</label> <input id="bFeatherColor" placeholder="Es: bianco / rosso e nero / azzurro...">
        </div>
       </div>
       <div class="hr2"></div>
       <h3>2) Cerchi (aggiungine quanti vuoi)</h3>
       <div class="small">Usa ‚ÄúAggiungi cerchio‚Äù per aggiungere cerchi extra (diametro/colore/intreccio/decorazioni).</div>
       <div class="list" id="bRingsList"></div>
       <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnAddRing">‚ûï Aggiungi cerchio</button>
       </div>
       <div class="hr2"></div>
       <h3>3) Piume (gruppi: sinistra/centro/destra)</h3>
       <div class="list" id="bFeathersList"></div>
       <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnAddFeathers">‚ûï Aggiungi gruppo piume</button>
       </div>
       <div class="hr2"></div>
       <h3>4) Accessori (aggiungine quanti vuoi)</h3>
       <div class="list" id="bAccList"></div>
       <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnAddAcc">‚ûï Aggiungi accessorio</button>
       </div>
       <div class="hr2"></div>
       <h3>5) Foto e Note</h3>
       <div class="row2">
        <div>
         <label>Vuoi inserire una foto?</label> <select id="bHasPhoto"> <option value="no" selected>No</option> <option value="si">S√¨</option> </select>
         <div class="small">Se s√¨, puoi caricarla qui e vedere l‚Äôanteprima.</div>
        </div>
        <div>
         <label>Carica foto (opzionale)</label> <input id="bPhotoFile" type="file" accept="image/*">
        </div>
       </div>
       <div style="margin-top:10px">
        <label>Scritta (opzionale)</label> <input id="bText" placeholder="Es: Nome, frase, data...">
       </div>
       <div style="margin-top:10px">
        <label>Note extra</label> <textarea id="bNotes" placeholder="Es: perle rosse e nere, brillanti, charm, emoji, ecc..."></textarea>
       </div>
       <div class="hr2"></div>
       <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="btnResumeProject">‚Ü©Ô∏è Riprendi ultimo progetto</button>
        <button class="btn" id="btnSaveProject">üíæ Salva progetto</button>
        <button class="btn primary" id="btnSendProject">üì≤ Invia su WhatsApp</button>
        <button class="btn primary" id="btnSaveAndSend">‚úÖ Salva &amp; Invia</button>
       </div>
       <div class="small" style="margin-top:8px">Nota: WhatsApp non permette di allegare automaticamente la foto dal link, ma nel messaggio ti ricorda di inviarla in chat.</div>
      </div>
      <!-- DESTRA: ANTEPRIMA + STIMA -->
      <div class="box">
       <h3>Anteprima &amp; riepilogo</h3>
       <div class="preview">
        <div class="preview-inner">
         <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
          <span class="badge2" id="bEstimate">Totale stimato: ‚Ç¨ 0,00</span> <span class="badge2" id="bCode">Codice: ‚Äî</span>
         </div>
         <img id="bPhotoPreview" class="preview-img" alt="Anteprima foto">
         <div class="hr2"></div>
         <div id="bSummary" class="small"></div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <!-- MODAL: CONFIGURATORE SEMPLICE (CLIENTI) -->
  <div class="modal-back" id="builderLiteBack">
   <div class="modal">
    <div class="modal-head">
     <h2>Personalizza il tuo Acchiappasogni</h2>
     <div class="spacer"></div>
     <button class="btn" id="btnCloseBuilderLite">‚úñ Chiudi</button>
    </div>
    <div class="modal-body">
     <div class="lite-grid">
      <!-- SINISTRA: STAGE -->
      <div class="box">
       <h3>Anteprima (trascina gli accessori)</h3>
       <div class="stage" id="dlStage">
        <div class="base-ring" id="dlBaseRing"></div>
        <svg class="base-shape" id="dlBaseSvg" viewBox="0 0 100 100" aria-hidden="true"></svg>
        <!-- piccola ragnatela (svg leggero) -->
        <svg class="web" id="dlWebSvg" viewBox="0 0 100 100" aria-hidden="true">
         <g fill="none" stroke="rgba(233,239,255,.75)" stroke-width="1.2">
          <circle cx="50" cy="50" r="45" /> <circle cx="50" cy="50" r="35" /> <circle cx="50" cy="50" r="25" /> <circle cx="50" cy="50" r="15" /> <path d="M50 5 L50 95" /> <path d="M5 50 L95 50" /> <path d="M18 18 L82 82" /> <path d="M82 18 L18 82" />
         </g>
        </svg>
       </div>
       <div class="hr2"></div>
       <div class="minirow">
        <button class="btn" id="dlSelectNone">üñêÔ∏è Deseleziona</button>
        <button class="btn danger" id="dlDelete">üóë Rimuovi elemento</button>
        <button class="btn danger" id="dlReset">‚ôªÔ∏è Reset</button>
        <button class="btn" id="dlColorBtn" style="display:none">üé® Colore</button>
        <button class="btn" id="dlFullscreen">‚õ∂ Schermo intero</button>
       </div>
       <div class="helpbox" style="margin-top:10px">
        ‚Ä¢ Premi un accessorio per selezionarlo, poi trascinalo dove vuoi.
        <br>
        ‚Ä¢ Selezionato = bordo viola. ‚ÄúRimuovi‚Äù lo elimina.
       </div>
      </div>
      <!-- DESTRA: SIMULATOR (stile app) -->
      <div class="box sim-sheet" id="simSheet">
       <div class="sim-sheet-top">
        <div class="sim-handle" id="simHandle" aria-label="Trascina per ridimensionare"></div>
        <div class="sim-tabs" role="tablist" aria-label="Strumenti">
         <button class="sim-tab active" data-simtab="base" type="button">Base</button>
         <button class="sim-tab" data-simtab="accessori" type="button">Accessori</button>
         <button class="sim-tab" data-simtab="testo" type="button">Testo</button>
         <button class="sim-tab" data-simtab="azioni" type="button">Invio</button>
        </div>
        <div class="sim-quickbar" aria-label="Scelte rapide">
         <div class="quick-group">
          <div class="quick-label">Colori cerchio</div>
          <button class="qdot c1" type="button" data-quick-target="dlRingColor" data-quick-value="bianco"></button>
          <button class="qdot c2" type="button" data-quick-target="dlRingColor" data-quick-value="verde"></button>
          <button class="qdot c3" type="button" data-quick-target="dlRingColor" data-quick-value="rosso"></button>
         </div>
         <div class="quick-group">
          <div class="quick-label">Colori piume</div>
          <button class="qdot c4" type="button" data-quick-target="dlFeatherColor" data-quick-value="bianco"></button>
          <button class="qdot c5" type="button" data-quick-target="dlFeatherColor" data-quick-value="arcobaleno"></button>
          <button class="qdot c6" type="button" data-quick-target="dlFeatherColor" data-quick-value="nero"></button>
         </div>
        </div>
       </div>
      </div>
      <div class="sim-panels">
       <div class="sim-panel active" data-simpanel="base">
        <h3 class="sim-title">Scelte rapide</h3>
        <div class="row2">
         <div>
          <label>Modello</label> <select id="dlModel"> <option value="1">1 ‚Ä¢ Classico</option> <option value="2">2 ‚Ä¢ Cerchio</option> <option value="3">3 ‚Ä¢ Luna</option> <option value="4">4 ‚Ä¢ Cuore</option> <option value="5">5 ‚Ä¢ Stella</option> <option value="6">6 ‚Ä¢ Chakra</option> <option value="7">7 ‚Ä¢ Yin &amp; Yang</option> <option value="8">8 ‚Ä¢ Personalizzato</option> </select>
         </div>
         <div>
          <label>Diametro (cm)</label> <select id="dlDiameter"> <option>15</option><option>20</option><option>25</option> <option selected>30</option><option>35</option><option>40</option><option>50</option> </select>
         </div>
         <div>
          <label>Colore cerchio</label> <input id="dlRingColor" placeholder="Es: bianco / oro / viola / blu...">
          <div class="sim-quick-colors" aria-label="Colori rapidi">
           <button class="qdot d-red" data-ring="rosso" type="button" aria-label="Rosso"></button>
           <button class="qdot d-blue" data-ring="blu" type="button" aria-label="Blu"></button>
           <button class="qdot d-gold" data-ring="oro" type="button" aria-label="Oro"></button>
          </div>
         </div>
         <div>
          <label>Colore piume</label> <input id="dlFeatherColor" placeholder="Es: viola / bianco / arcobaleno...">
         </div>
        </div>
        <div class="hr2"></div>
        <div class="row2">
         <div>
          <label>Tessitura cerchio</label> <select id="dlWeave"> <option value="classico" selected>Classica</option> <option value="fitta">Ragnatela fitta</option> <option value="pizzo">Centrino / pizzo</option> <option value="chakra">Chakra (raggi)</option> <option value="yinyang">Yin &amp; Yang</option> <option value="stella">Stella</option> </select>
          <div class="hint">Cambia solo l‚Äôanteprima (non tocca il catalogo).</div>
         </div>
         <div>
          <label>Intreccio (testo)</label> <input id="dlWeaveNote" placeholder="Es: intreccio bianco, pizzo, doppio filo...">
          <div class="hint">Viene inviato nell‚Äôordine WhatsApp.</div>
         </div>
        </div>
        <div class="hr2"></div>
        <h3>üî• Esempi pronti (1 tocco)</h3>
        <div class="preset-grid" id="dlPresets">
         <button class="preset" data-preset="viola"><b>Viola Classico</b> <small>Piume viola + cristalli</small></button>
         <button class="preset" data-preset="oro"><b>Oro &amp; Bianco</b> <small>Elegante + perle oro</small></button>
         <button class="preset" data-preset="natale"><b>Natale</b> <small>Fiocchi + campanelline</small></button>
         <button class="preset" data-preset="albero"><b>Albero di cerchi</b> <small>Molti cerchi + luci</small></button>
         <button class="preset" data-preset="real"><b>REAL HASTA‚Ä¶</b> <small>Rosso/Nero + simboli</small></button>
        </div>
       </div>
       <div class="sim-panel" data-simpanel="accessori">
        <h3>Accessori (tocca per aggiungere)</h3>
        <div class="accessory-drawer">
         <div class="acc-cats" id="accCats"></div>
         <div class="acc-grid" id="accGrid"></div>
         <div class="smallhint">Tocca un accessorio per aggiungerlo. Tocca un elemento sul cerchio per selezionarlo, poi cambia colore (se disponibile).</div>
         <div style="display:flex;gap:10px;margin-top:10px;align-items:center;justify-content:space-between">
          <button class="pill" id="accColorBtn" type="button" style="flex:1">üé® Colore elemento selezionato</button>
          <button class="pill" id="accBringFrontBtn" type="button" style="flex:1">‚¨ÜÔ∏è Porta davanti</button>
         </div>
        </div>
        <div class="color-pop" id="accColorPop" aria-hidden="true">
         <div class="row">
          <h4>Colore accessorio</h4>
          <button class="pill" id="accColorCloseBtn" type="button">Chiudi</button>
         </div>
         <div class="color-swatch" id="accColorSwatch"></div>
         <div class="smallhint">Se un accessorio non supporta colori, verr√† lasciato com‚Äô√®.</div>
        </div>
        <div class="sim-panel" data-simpanel="testo">
         <h3 class="sim-title">Scritta &amp; note</h3>
         <div>
          <label>Scritta (opzionale)</label> <input id="dlText" placeholder="Es: nome, frase, data...">
          <div class="hint">La scritta viene inviata nell‚Äôordine WhatsApp.</div>
         </div>
         <div style="margin-top:10px">
          <label>Note extra</label> <textarea id="dlNotes" placeholder="Es: perle rosse e nere, charm specifico, tema, ecc..."></textarea>
         </div>
        </div>
        <div class="sim-panel" data-simpanel="azioni">
         <h3 class="sim-title">Salva / Invia</h3>
         <div class="hr2"></div>
         <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="dlSave">üíæ Salva</button>
          <button class="btn primary" id="dlSend">üì≤ Invia su WhatsApp</button>
          <button class="btn primary" id="dlSaveSend">‚úÖ Salva &amp; Invia</button>
         </div>
         <div class="hint" style="margin-top:10px">Nota: l‚Äôanteprima √® ‚Äúsimbolica‚Äù (serve per scegliere la posizione degli accessori).</div>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <!-- MODAL: BOMBONIERE & REGALI (CLIENTI) -->
  <div class="modal-back" id="giftsBack">
   <div class="modal">
    <div class="modal-head">
     <h2>üéÅ Bomboniere &amp; Regali</h2>
     <div class="spacer"></div>
     <button class="btn" id="btnCloseGifts">‚úñ Chiudi</button>
    </div>
    <div class="modal-body">
     <div class="builder-grid">
      <div class="box">
       <h3>Scelta rapida</h3>
       <div class="row2">
        <div>
         <label>Categoria</label> <select id="gType"> <option value="9">9 ‚Ä¢ Bomboniera Portachiavi</option> <option value="10">10 ‚Ä¢ Pendenti</option> <option value="11">11 ‚Ä¢ Singolo</option> <option value="12">12 ‚Ä¢ Vasetto</option> <option value="13">13 ‚Ä¢ Scatola</option> <option value="14">14 ‚Ä¢ Personalizzato (Evento)</option> <option value="15">15 ‚Ä¢ Fiocco nascita</option> <option value="16">16 ‚Ä¢ Nome</option> </select>
        </div>
        <div>
         <label>Occasione</label> <select id="gOcc"> <option>‚Äî</option> <option>Battesimo</option> <option>Comunione</option> <option>Matrimonio</option> <option>Compleanno</option> <option>Nascita</option> <option>Laurea</option> <option>Evento</option> </select>
        </div>
       </div>
       <div class="hr2"></div>
       <h3>üî• Esempi pronti</h3>
       <div class="preset-grid" id="gPresets">
        <button class="preset" data-gpreset="confetti"><b>Con confetti</b><small>Bustina + bigliettino</small></button>
        <button class="preset" data-gpreset="name"><b>Con Nome</b><small>Scritta frontale</small></button>
        <button class="preset" data-gpreset="baby"><b>Nascita</b><small>Fiocco + data</small></button>
        <button class="preset" data-gpreset="event"><b>Evento</b><small>Tema personalizzato</small></button>
       </div>
       <div class="hr2"></div>
       <div class="row2">
        <div>
         <label>Nome / Scritta</label> <input id="gName" placeholder="Es: Aurora / Buone Feste / Buon Battesimo...">
        </div>
        <div>
         <label>Data (opzionale)</label> <input id="gDate" placeholder="Es: 12/06/2026">
        </div>
        <div>
         <label>Colori</label> <input id="gColors" placeholder="Es: bianco e oro / rosa / blu e argento...">
        </div>
        <div>
         <label>Dettagli</label> <input id="gDetails" placeholder="Es: confetti, bustina, bigliettino, tema, ecc...">
        </div>
       </div>
       <div class="hr2"></div>
       <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn" id="gReset">‚ôªÔ∏è Reset</button>
        <button class="btn" id="gSave">üíæ Salva</button>
        <button class="btn primary" id="gSend">üì≤ Invia su WhatsApp</button>
        <button class="btn primary" id="gSaveSend">‚úÖ Salva &amp; Invia</button>
       </div>
      </div>
      <div class="box">
       <h3>Riepilogo</h3>
       <div class="preview">
        <div class="preview-inner">
         <span class="badge2" id="gCode">Codice: ‚Äî</span>
         <div class="hr2"></div>
         <div class="small" id="gSummary"></div>
        </div>
       </div>
       <div class="hint" style="margin-top:8px">Nota: questa sezione √® separata dal catalogo e non cambia nulla ai prodotti.</div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const DEFAULT_WA = "+393440260906";
    const ADMIN_PASS_DEFAULT = "1234";
    const PRODUCTS_URL = "data/products.json";

    const IMAGE_BASE_PATH = "assets/assets/images/assets/images/acchiappasogni_hd/";
    const IMAGE_BASE_CANDIDATES = [
      "assets/assets/images/assets/images/acchiappasogni_hd/",
      "assets/images/acchiappasogni_hd/",
      "assets/img/acchiappasogni_hd/",
      "assets/images/",
      "assets/img/",
      "images/",
      "img/",
      "assets/",
      ""
    ];

    const NOIMG_DATA = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='800' height='600'%3E%3Crect width='100%25' height='100%25' fill='%23101423'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23a9b3d1' font-family='Arial' font-size='28'%3EFoto non disponibile%3C/text%3E%3C/svg%3E";


    const K = {
adminPass: "ae_admin_pass",
      wa: "ae_wa_number",
      productsOverride: "ae_products_override",
      cart: "ae_cart_v1",
      broken: "ae_broken_images_v2",
      deleted: "ae_deleted_ids",
      prices: "ae_builder_prices_v1",
      projects: "ae_builder_projects_v1",
      categories: "ae_categories_v1"
    };

    const IMG_OPT = { maxSide: 1200, quality: 0.72, mime: "image/jpeg" };

    const euro = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString("it-IT", { style: "currency", currency: "EUR" });
    };

    const uid = () => "P-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);

    

    // --- Mobile-safe image resolution (prevents empty catalog if images 404) ---
    function isAbsoluteUrl(u){
      return /^https?:\/\//i.test(u) || /^data:/i.test(u) || u.startsWith("/");
    }
    function resolveImageCandidates(imageValue){
      let raw = String(imageValue || "").trim();
      if (!raw) return [];

      // GitHub Pages subfolder safe: convert "/assets/..." to relative "assets/..."
      if (raw.startsWith("/") && !raw.startsWith("//")) raw = raw.slice(1);

      // Absolute http(s) and data:
      if (/^https?:\/\//i.test(raw) || /^data:/i.test(raw)) return [raw];

      // If already contains folders, try as-is + common normalizations
      if (raw.includes("/")) {
        const cleaned = raw.startsWith("./") ? raw.slice(2) : raw;
        return Array.from(new Set([raw, "./" + cleaned, cleaned]));
      }

      // If only filename, try common base folders
      return IMAGE_BASE_CANDIDATES.map(base => base + raw);
    }
    function setImgWithFallback(imgEl, candidates, onAllFail, onOk){
      let idx = 0;

      const cleanup = () => {
        imgEl.removeEventListener("error", onErr);
        imgEl.removeEventListener("load", onLoad);
      };

      const onLoad = () => {
        if (typeof onOk === "function") onOk();
        cleanup();
      };

      const onErr = () => {
        if (idx < candidates.length){
          imgEl.src = candidates[idx++];
          return;
        }
        cleanup();
        if (typeof onAllFail === "function") onAllFail();
      };

      imgEl.addEventListener("error", onErr);
      imgEl.addEventListener("load", onLoad);

      if (candidates && candidates.length){
        imgEl.src = candidates[idx++];
      } else if (typeof onAllFail === "function"){
        onAllFail();
      }
    }
function getAdminPass(){ return localStorage.getItem(K.adminPass) || ADMIN_PASS_DEFAULT; }
    function setAdminPass(p){ localStorage.setItem(K.adminPass, p); }

    function getWa(){ return localStorage.getItem(K.wa) || DEFAULT_WA; }
    function setWa(v){ localStorage.setItem(K.wa, v); }

    function loadCart(){ try { return JSON.parse(localStorage.getItem(K.cart) || "{}"); } catch { return {}; } }
    function saveCart(c){ localStorage.setItem(K.cart, JSON.stringify(c)); }

    function loadBrokenSet(){
      try{
        const arr = JSON.parse(localStorage.getItem(K.broken) || "[]");
        return new Set(Array.isArray(arr) ? arr : []);
      }catch{ return new Set(); }
    }
    function saveBrokenSet(set){ localStorage.setItem(K.broken, JSON.stringify(Array.from(set))); }
    let brokenImages = loadBrokenSet();

    function loadDeleted(){
      try{
        const arr = JSON.parse(localStorage.getItem(K.deleted) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveDeleted(arr){ localStorage.setItem(K.deleted, JSON.stringify(arr)); }

    async function fetchBaseProducts(){
      const r = await fetch(PRODUCTS_URL, { cache: "no-store" });
      if(!r.ok) throw new Error("Impossibile caricare " + PRODUCTS_URL);
      const data = await r.json();
      return Array.isArray(data) ? data : [];
    }

    function loadOverride(){
      try { return JSON.parse(localStorage.getItem(K.productsOverride) || "[]"); } catch { return []; }
    }
    function saveOverride(list){
      localStorage.setItem(K.productsOverride, JSON.stringify(list));
    }

    async function fetchProductsWithLocalOverride(){
      const base = await fetchBaseProducts();
      const over = loadOverride();
      const map = new Map(base.map(p => [p.id, p]));
      for(const p of over) map.set(p.id, p);
      return Array.from(map.values());
    }

    let allProducts = [];
    let visibleProducts = [];
    let categories = [];
    let activeCategory = "Tutti";
    let q = "";
    let cart = loadCart();

    const grid = document.getElementById("grid");
    const search = document.getElementById("search");
    const filters = document.getElementById("filters");
    const cartCount = document.getElementById("cartCount");
    const cartTotal = document.getElementById("cartTotal");
    const cartTotal2 = document.getElementById("cartTotal2");

    const cartModalBack = document.getElementById("cartModalBack");
    const adminModalBack = document.getElementById("adminModalBack");

    function rebuildCategories(){
      const set = new Set(allProducts.map(p => p.category || "Altro"));
      // categorie salvate (anche vuote)
      let saved = [];
      try{ saved = JSON.parse(localStorage.getItem(K.categories) || "[]"); }catch{}
      if(!Array.isArray(saved)) saved = [];
      for(const c of saved){ if(c && typeof c === "string") set.add(c); }
      categories = ["Tutti", ...Array.from(set).sort((a,b)=>a.localeCompare(b,"it"))];
      refreshCategoryDatalist();
    }

    function renderFilters(){
      filters.innerHTML = "";
      for(const c of categories){
        const b = document.createElement("div");
        b.className = "chip" + (c === activeCategory ? " active" : "");
        b.textContent = c;
        b.onclick = () => { activeCategory = c; applyFilters(); };
        filters.appendChild(b);
      }
    }

    function applyFilters(){
      const s = (q || "").trim().toLowerCase();
      visibleProducts = allProducts.filter(p => {
        const catOk = (activeCategory === "Tutti") || ((p.category || "Altro") === activeCategory);
        const text = ((p.title || "") + " " + (p.category || "") + " " + (p.description || "")).toLowerCase();
        const searchOk = !s || text.includes(s);
        const pubOk = (p.published !== false);
        const imgOk = !brokenImages.has(p.id);
        return catOk && searchOk && pubOk && imgOk;
      });
      renderGrid();
    }

    function renderGrid(){
      grid.innerHTML = "";
      for(const p of visibleProducts){
        const cardEl = document.createElement("div");
        cardEl.className = "card";

        const imgWrap = document.createElement("div");
        imgWrap.className = "img";

        const img = document.createElement("img");
        img.alt = p.title || "";
        img.loading = "lazy";
        img.decoding = "async";
        // Resolve image path safely (GitHub Pages + mobile)
        const candidates = resolveImageCandidates(p.image);
        setImgWithFallback(img, candidates, () => {
          // Se l'immagine non si apre: NON mostrare il prodotto in Home (come prima)
          try {
            brokenImages.add(p.id);
            saveBrokenSet(brokenImages);
          } catch (e) {}
          try { cardEl.remove(); } catch(e){}
        }, () => {
          // Auto-heal: se torna a caricarsi, rimuovi dalla lista "broken"
          if (brokenImages.has(p.id)){
            try {
              brokenImages.delete(p.id);
              saveBrokenSet(brokenImages);
            } catch(e){}
          }
        });
            const badge = document.createElement("div");
        badge.className = "badge";
        badge.textContent = (p.category || "Altro");

        imgWrap.appendChild(img);
        imgWrap.appendChild(badge);

        const content = document.createElement("div");
        content.className = "content";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = p.title || "";

        const meta = document.createElement("div");
        meta.className = "meta";

        const price = document.createElement("div");
        price.className = "price";
        price.textContent = euro(p.price_from ?? 0);

        meta.appendChild(price);

        content.appendChild(title);

        if (p.description) {
          const desc = document.createElement("div");
          desc.style.color = "rgba(185,198,255,.85)";
          desc.style.fontSize = "12px";
          desc.style.lineHeight = "1.25";
          desc.textContent = p.description;
          content.appendChild(desc);
        }

        content.appendChild(meta);

        const row = document.createElement("div");
        row.className = "row";

        const qtyWrap = document.createElement("div");
        qtyWrap.className = "qty";

        const minus = document.createElement("div");
        minus.className = "qbtn";
        minus.textContent = "‚àí";

        const count = document.createElement("div");
        count.textContent = String(cart[p.id] || 0);

        const plus = document.createElement("div");
        plus.className = "qbtn";
        plus.textContent = "+";

        minus.onclick = () => {
          const cur = cart[p.id] || 0;
          if(cur <= 0) return;
          cart[p.id] = cur - 1;
          if(cart[p.id] <= 0) delete cart[p.id];
          saveCart(cart);
          count.textContent = String(cart[p.id] || 0);
          updateCartUI();
        };

        plus.onclick = () => {
          const cur = cart[p.id] || 0;
          cart[p.id] = cur + 1;
          saveCart(cart);
          count.textContent = String(cart[p.id] || 0);
          updateCartUI();
        };

        qtyWrap.appendChild(minus);
        qtyWrap.appendChild(count);
        qtyWrap.appendChild(plus);

        const add = document.createElement("button");
        add.className = "btn primary add";
        add.textContent = "Aggiungi";
        add.onclick = () => {
          const cur = cart[p.id] || 0;
          cart[p.id] = cur + 1;
          saveCart(cart);
          count.textContent = String(cart[p.id] || 0);
          updateCartUI();
        };

        row.appendChild(qtyWrap);
        row.appendChild(add);

        content.appendChild(row);

        cardEl.appendChild(imgWrap);
        cardEl.appendChild(content);

        grid.appendChild(cardEl);
      }
    }

    function cartTotals(){
      let items = 0;
      let tot = 0;
      const byId = new Map(allProducts.map(p => [p.id, p]));
      for(const [id, qty] of Object.entries(cart)){
        const p = byId.get(id);
        if(!p) continue;
        items += qty;
        tot += (Number(p.price_from || 0) * qty);
      }
      return { items, tot };
    }

    function updateCartUI(){
      const { items, tot } = cartTotals();
      cartCount.textContent = String(items);
      cartTotal.textContent = euro(tot);
      cartTotal2.textContent = euro(tot);
    }

    function renderCartModal(){
      const list = document.getElementById("cartList");
      list.innerHTML = "";
      const byId = new Map(allProducts.map(p => [p.id, p]));
      const ids = Object.keys(cart);

      if(ids.length === 0){
        const empty = document.createElement("div");
        empty.className = "hint";
        empty.textContent = "Carrello vuoto.";
        list.appendChild(empty);
        updateCartUI();
        return;
      }

      for(const id of ids){
        const p = byId.get(id);
        if(!p) continue;
        const qty = cart[id];

        const item = document.createElement("div");
        item.className = "admin-item";

        const th = document.createElement("div");
        th.className = "thumb";
        const im = document.createElement("img");
        im.src = (p.image || "");
        im.onerror = () => { im.onerror=null; brokenImages.add(p.id); saveBrokenSet(brokenImages); };
        th.appendChild(im);

        const info = document.createElement("div");
        info.className = "info";
        info.innerHTML = `<b>${escapeHtml(p.title||"")}</b><small>${escapeHtml(p.category||"")} ‚Ä¢ ${euro(p.price_from||0)} √ó ${qty}</small>`;

        const actions = document.createElement("div");
        actions.className = "actions";

        const m = document.createElement("button");
        m.className = "btn mini";
        m.textContent = "‚àí";
        m.onclick = () => {
          const cur = cart[id] || 0;
          if(cur <= 1) delete cart[id];
          else cart[id] = cur - 1;
          saveCart(cart);
          renderCartModal();
          updateCartUI();
          applyFilters();
        };

        const pbtn = document.createElement("button");
        pbtn.className = "btn mini";
        pbtn.textContent = "+";
        pbtn.onclick = () => {
          cart[id] = (cart[id] || 0) + 1;
          saveCart(cart);
          renderCartModal();
          updateCartUI();
          applyFilters();
        };

        const del = document.createElement("button");
        del.className = "btn danger mini";
        del.textContent = "Rimuovi";
        del.onclick = () => {
          delete cart[id];
          saveCart(cart);
          renderCartModal();
          updateCartUI();
          applyFilters();
        };

        actions.appendChild(m);
        actions.appendChild(pbtn);
        actions.appendChild(del);

        item.appendChild(th);
        item.appendChild(info);
        item.appendChild(actions);

        list.appendChild(item);
      }
      updateCartUI();
    }

    function openCart(){ renderCartModal(); cartModalBack.style.display = "flex"; }
    function closeCart(){ cartModalBack.style.display = "none"; }

    function buildWhatsAppMessage(){
      const byId = new Map(allProducts.map(p => [p.id, p]));
      let lines = [];
      lines.push("Ciao! Vorrei ordinare:");
      let tot = 0;

      for(const [id, qty] of Object.entries(cart)){
        const p = byId.get(id);
        if(!p) continue;
        const price = Number(p.price_from || 0);
        const sub = price * qty;
        tot += sub;
        lines.push(`- ${p.title} √ó ${qty} = ${euro(sub)}`);
      }
      lines.push("");
      lines.push(`Totale: ${euro(tot)}`);
      lines.push("Grazie!");
      return lines.join("\n");
    }

    function openWhatsApp(){
      const { items } = cartTotals();
      if(items <= 0){ alert("Il carrello √® vuoto."); return; }
      const number = getWa();
      const msg = buildWhatsAppMessage();
      const url = `https://wa.me/${encodeURIComponent(number.replace(/\s+/g,""))}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    /* btnCustomizer: handler impostato dal configuratore */

    function openAdmin(){
      document.getElementById("adminLogin").style.display = "block";
      document.getElementById("adminPanel").style.display = "none";
      document.getElementById("adminPass").value = "";
      adminModalBack.style.display = "flex";
    }
    function closeAdmin(){ adminModalBack.style.display = "none"; }

    function adminLogin(){
      const pass = document.getElementById("adminPass").value || "";
      if(pass !== getAdminPass()){ alert("Password errata."); return; }
      document.getElementById("adminLogin").style.display = "none";
      document.getElementById("adminPanel").style.display = "block";
      document.getElementById("waNumber").value = getWa();
      document.getElementById("newAdminPass").value = "";
      rebuildEditSelect();
      injectAdminPricesUI();
    }

    function rebuildEditSelect(){
      const sel = document.getElementById("editSelect");
      sel.innerHTML = "";
      const sorted = [...allProducts].sort((a,b)=>(a.title||"").localeCompare(b.title||"","it"));
      for(const p of sorted){
        const o = document.createElement("option");
        o.value = p.id;
        o.textContent = `${p.title || p.id}`;
        sel.appendChild(o);
      }
    }

    function loadSelectedToForm(){
      const id = document.getElementById("editSelect").value;
      const p = allProducts.find(x => x.id === id);
      if(!p){ alert("Prodotto non trovato"); return; }
      document.getElementById("fTitle").value = p.title || "";
      document.getElementById("fCategory").value = p.category || "";
      document.getElementById("fDesc").value = p.description || "";
      document.getElementById("fPrice").value = Number(p.price_from || 0);
      document.getElementById("fPublished").checked = (p.published !== false);
      document.getElementById("fImagePath").value = (p.image && !p.image.startsWith("data:")) ? p.image : "";
      document.getElementById("fImageFile").value = "";
    }

    function clearFormForNew(){
      document.getElementById("editSelect").value = "";
      document.getElementById("fTitle").value = "";
      document.getElementById("fCategory").value = "Acchiappasogni Classici";
      document.getElementById("fDesc").value = "";
      document.getElementById("fPrice").value = 5;
      document.getElementById("fPublished").checked = false;
      document.getElementById("fImagePath").value = "";
      document.getElementById("fImageFile").value = "";
    }

    async function fileToDataUrl(file){
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(String(r.result || ""));
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    function loadImg(src){
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
      });
    }

    async function optimizeImageFile(file){
      const dataUrl = await fileToDataUrl(file);
      const img = await loadImg(dataUrl);

      const w = img.naturalWidth || img.width;
      const h = img.naturalHeight || img.height;
      const longSide = Math.max(w, h);
      const scale = longSide > IMG_OPT.maxSide ? (IMG_OPT.maxSide / longSide) : 1;

      const nw = Math.max(1, Math.round(w * scale));
      const nh = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement("canvas");
      canvas.width = nw; canvas.height = nh;
      const ctx = canvas.getContext("2d", { alpha: false });

      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, nw, nh);
      ctx.drawImage(img, 0, 0, nw, nh);

      return canvas.toDataURL(IMG_OPT.mime, IMG_OPT.quality);
    }

    async function saveProduct(){
      const title = document.getElementById("fTitle").value.trim();
      const category = document.getElementById("fCategory").value.trim() || "Altro";
      const description = (document.getElementById("fDesc").value || "").trim();
      const price = Number(document.getElementById("fPrice").value || 0);
      const published = !!document.getElementById("fPublished").checked;

      let path = document.getElementById("fImagePath").value.trim();
      const file = document.getElementById("fImageFile").files?.[0] || null;

      if(!title){ alert("Metti un titolo."); return; }

      if (path && !path.includes("/") && !path.startsWith("http") && !path.startsWith("data:")) {
        path = IMAGE_BASE_PATH + path;
      }

      let id = document.getElementById("editSelect").value;
      const isNew = !id;
      if(!id) id = uid();

      const existing = allProducts.find(x => x.id === id) || null;

      let image = path || "";
      if(file){
        try{
          image = await optimizeImageFile(file);
        }catch(e){
          console.error(e);
          alert("Errore: impossibile leggere/ottimizzare la foto scelta.");
          return;
        }
      }
      if(!image && existing) image = existing.image || "";
      if(!image){ alert("Seleziona una foto (galleria) oppure inserisci il percorso GitHub."); return; }

      if (brokenImages.has(id)) {
        brokenImages.delete(id);
        saveBrokenSet(brokenImages);
      }

      const newP = {
        id,
        title,
        category,
        description,
        price_from: price,
        image,
        featured: !!(existing?.featured),
        published
      };

      const over = loadOverride();
      const idx = over.findIndex(x => x.id === id);
      if(idx >= 0) over[idx] = newP;
      else over.push(newP);
      saveOverride(over);

      await reloadProducts();
      rebuildEditSelect();
      injectAdminPricesUI();
      document.getElementById("editSelect").value = id;
      document.getElementById("fImageFile").value = "";

      alert(isNew ? "Salvato (bozza)!" : "Salvato!");
    }

    function ensureSelectedForPublish(){
      const id = document.getElementById("editSelect").value;
      if(!id){ alert("Prima salva il prodotto (bozza), poi pubblichi."); return null; }
      return id;
    }

    async function publishNow(){
      const id = ensureSelectedForPublish();
      if(!id) return;
      document.getElementById("fPublished").checked = true;
      await saveProduct();
    }

    async function hideNow(){
      const id = ensureSelectedForPublish();
      if(!id) return;
      document.getElementById("fPublished").checked = false;
      await saveProduct();
    }

    async function deleteSelected(){
      const id = document.getElementById("editSelect").value;
      if(!id){ alert("Seleziona un prodotto"); return; }
      if(!confirm("Eliminare questo prodotto?")) return;

      const dels = loadDeleted();
      if(!dels.includes(id)) dels.push(id);
      saveDeleted(dels);

      const over = loadOverride();
      const nextOver = over.filter(p => p.id !== id);
      saveOverride(nextOver);

      delete cart[id];
      saveCart(cart);

      await reloadProducts();
      rebuildEditSelect();
      injectAdminPricesUI();
      alert("Eliminato!");
    }

    async function deleteCategory(){
      const cat = (document.getElementById("fCategory").value || "").trim();
      if(!cat){ alert("Scrivi/Seleziona una categoria nel campo Categoria."); return; }

      const count = allProducts.filter(p => (p.category || "Altro") === cat).length;
      if(count === 0){
        alert("Nessun prodotto trovato in questa categoria.");
        return;
      }

      if(!confirm(`Eliminare la categoria "${cat}"?\nVerranno eliminati anche ${count} prodotti.`)) return;

      const dels = loadDeleted();

      for(const p of allProducts){
        if((p.category || "Altro") === cat){
          if(!dels.includes(p.id)) dels.push(p.id);
          if(cart[p.id]) delete cart[p.id];
        }
      }
      saveDeleted(dels);
      saveCart(cart);

      const over = loadOverride();
      const nextOver = over.filter(p => (p.category || "Altro") !== cat);
      saveOverride(nextOver);

      await reloadProducts();
      rebuildEditSelect();
      injectAdminPricesUI();
      alert("Categoria eliminata!");
    }

    async function applyBulkPrice(){
      const v = Number(document.getElementById("bulkPrice").value || 0);
      if(!v || v < 0){ alert("Inserisci un prezzo valido."); return; }

      const over = loadOverride();
      const overMap = new Map(over.map(p => [p.id, p]));
      const nextOver = [];

      for(const p of allProducts){
        const base = overMap.get(p.id) || p;
        nextOver.push({ ...base, price_from: v });
      }
      saveOverride(nextOver);
      await reloadProducts();
      alert("Prezzi aggiornati!");
    }

    async function resetAll(){
      if(!confirm("Reset completo? Cancella modifiche e torna al catalogo originale.")) return;
      localStorage.removeItem(K.productsOverride);
      localStorage.removeItem(K.deleted);
      localStorage.removeItem(K.broken);
      brokenImages = new Set();
      await reloadProducts();
      alert("Ripristinato!");
    }

    function applyDeleted(products){
      const dels = loadDeleted();
      if(!dels.length) return products;
      return products.filter(p => !dels.includes(p.id));
    }

    function downloadText(filename, text, mime="application/json"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function exportConfig(){
      try{
        const merged = await fetchProductsWithLocalOverride();
        const finalList = applyDeleted(merged).map(p => ({
          id: String(p.id || uid()),
          title: String(p.title || ""),
          category: String(p.category || "Altro"),
          description: String(p.description || ""),
          price_from: Number(p.price_from ?? 0),
          image: String(p.image || ""),
          featured: !!p.featured,
          published: (p.published === undefined ? true : !!p.published)
        }));

        finalList.sort((a,b) => (a.category||"").localeCompare(b.category||"","it") || (a.title||"").localeCompare(b.title||"","it"));

        downloadText("products.json", JSON.stringify(finalList, null, 2));
        alert("Scaricato products.json ‚úÖ\nOra caricalo su GitHub dentro la cartella data/ sostituendo il vecchio file.");
      }catch(e){
        console.error(e);
        alert("Errore export: " + (e?.message || e));
      }
    }

    async function importConfigFromFile(file){
      try{
        const text = await file.text();
        const arr = JSON.parse(text);

        if(!Array.isArray(arr)) {
          alert("Il file JSON deve contenere una lista di prodotti (array).");
          return;
        }

        const normalized = arr.map(p => ({
          id: String(p.id || uid()),
          title: String(p.title || ""),
          category: String(p.category || "Altro"),
          description: String(p.description || ""),
          price_from: Number(p.price_from ?? 0),
          image: String(p.image || ""),
          featured: !!p.featured,
          published: (p.published === undefined ? true : !!p.published)
        }));

        saveOverride(normalized);
        await reloadProducts();
        rebuildEditSelect();
      injectAdminPricesUI();
        alert("Configurazione importata nel telefono ‚úÖ");
      }catch(e){
        console.error(e);
        alert("Errore import: " + (e?.message || e));
      }
    }

    document.getElementById("btnCart").onclick = openCart;
    document.getElementById("btnCloseCart").onclick = closeCart;
    cartModalBack.addEventListener("click", (e)=>{ if(e.target === cartModalBack) closeCart(); });

    document.getElementById("btnWhatsApp").onclick = openWhatsApp;
    document.getElementById("btnWhatsApp2").onclick = openWhatsApp;

    document.getElementById("btnClearCart").onclick = () => {
      if(!confirm("Svuotare il carrello?")) return;
      cart = {};
      saveCart(cart);
      renderCartModal();
      updateCartUI();
      applyFilters();
    };

    document.getElementById("btnSettings").onclick = openAdmin;
    document.getElementById("btnCloseAdmin").onclick = closeAdmin;
    adminModalBack.addEventListener("click", (e)=>{ if(e.target === adminModalBack) closeAdmin(); });

    document.getElementById("btnAdminLogin").onclick = adminLogin;
    document.getElementById("btnAdminCancel").onclick = closeAdmin;

    document.getElementById("btnLoadToForm").onclick = loadSelectedToForm;
    document.getElementById("btnNewProduct").onclick = clearFormForNew;
    document.getElementById("btnSaveProduct").onclick = saveProduct;
    document.getElementById("btnPublishNow").onclick = publishNow;
    document.getElementById("btnHideNow").onclick = hideNow;
    document.getElementById("btnDeleteSelected").onclick = deleteSelected;
    document.getElementById("btnDeleteCategory").onclick = deleteCategory;

    document.getElementById("btnBulkApply").onclick = applyBulkPrice;
    document.getElementById("btnResetAll").onclick = resetAll;

    document.getElementById("waNumber").addEventListener("change", (e)=> setWa(e.target.value.trim()));
    document.getElementById("newAdminPass").addEventListener("change", (e)=>{
      const v = e.target.value.trim();
      if(v){
        setAdminPass(v);
        alert("Password aggiornata!");
        e.target.value = "";
      }
    });

    document.getElementById("btnExportConfig").onclick = exportConfig;
    document.getElementById("importConfigFile").addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      if(!f) return;
      importConfigFromFile(f);
      e.target.value = "";
    });

    search.addEventListener("input", (e)=>{
      q = e.target.value;
      applyFilters();
    });

    async function reloadProducts(){
      const products = await fetchProductsWithLocalOverride();
      allProducts = applyDeleted(products);

      allProducts = allProducts.map(p => ({
        id: String(p.id || uid()),
        title: String(p.title || ""),
        category: String(p.category || "Altro"),
        description: String(p.description || ""),
        price_from: Number(p.price_from ?? 0),
        image: String(p.image || ""),
        featured: !!p.featured,
        published: (p.published === undefined ? true : !!p.published)
      }));

      rebuildCategories();
      renderFilters();
      applyFilters();
      updateCartUI();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    reloadProducts().catch(err=>{
      console.error(err);
      alert("Errore caricamento catalogo: " + err.message);
    });
  
    /* =========================================================
       CONFIGURATORE UTENTE + PREZZI (ADMIN) + CATEGORIE SALVATE
       ========================================================= */

    // Prezzi di default (modesti)
    const DEFAULT_PRICES = {
      base_model: 12.00,
      ring_extra: 3.00,
      feathers_group: 2.50,
      accessory_beads: 1.50,
      accessory_glitter: 1.00,
      accessory_charm: 2.00,
      accessory_symbol: 1.50,
      accessory_text: 2.00,
      lights: 4.00,
      photo: 0.00
    };

    function loadPrices(){
      try{
        const p = JSON.parse(localStorage.getItem(K.prices) || "null");
        return p && typeof p === "object" ? { ...DEFAULT_PRICES, ...p } : { ...DEFAULT_PRICES };
      }catch{
        return { ...DEFAULT_PRICES };
      }
    }
    function savePrices(p){ localStorage.setItem(K.prices, JSON.stringify(p)); }

    function loadSavedCategories(){
      try{
        const arr = JSON.parse(localStorage.getItem(K.categories) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveSavedCategories(arr){ localStorage.setItem(K.categories, JSON.stringify(arr)); }

    // Aggiorna datalist categorie nel form Admin
    function refreshCategoryDatalist(){
      const dl = document.getElementById("catDatalist");
      if(!dl) return;
      dl.innerHTML = "";
      for(const c of categories.filter(x => x && x !== "Tutti")){
        const o = document.createElement("option");
        o.value = c;
        dl.appendChild(o);
      }
    }

    // Pulsante "Crea categoria" (Admin)
    const btnCreateCategory = document.getElementById("btnCreateCategory");
    if(btnCreateCategory){
      btnCreateCategory.onclick = () => {
        const name = prompt("Nome nuova categoria:");
        if(!name) return;
        const clean = name.trim();
        if(!clean) return;

        // normalizza per evitare doppioni
        const norm = clean.toLowerCase();
        const existing = new Set(categories.map(c => String(c).toLowerCase()));
        if(existing.has(norm)){
          alert("Questa categoria esiste gi√† ‚úÖ");
          document.getElementById("fCategory").value = categories.find(c => String(c).toLowerCase() === norm) || clean;
          return;
        }

        const saved = loadSavedCategories();
        const savedNorm = new Set(saved.map(c => String(c).toLowerCase()));
        if(!savedNorm.has(norm)) saved.push(clean);
        saveSavedCategories(saved);

        document.getElementById("fCategory").value = clean;

        // ricostruisci categorie e filtri
        rebuildCategories();
        renderFilters();
        refreshCategoryDatalist();
        alert("Categoria creata ‚úÖ");
      };
    }

    /* =========================
       ADMIN: Sezione prezzi privata
       ========================= */
    function injectAdminPricesUI(){
      const panel = document.getElementById("adminPanel");
      if(!panel) return;
      if(document.getElementById("adminPricesBox")) return;

      const box = document.createElement("div");
      box.id = "adminPricesBox";
      box.innerHTML = `
        <div class="hr"></div>
        <h3 style="margin:0 0 10px 0;font-size:13px">üí∂ Prezzi configuratore (privati)</h3>
        <div class="form">
          ${Object.keys(DEFAULT_PRICES).map(k => `
            <div>
              <label>${k.replaceAll("_"," ")}</label>
              <input type="number" step="0.01" id="price_${k}" />
            </div>
          `).join("")}
          <div style="grid-column:1/-1;display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end">
            <button class="btn primary" id="btnSavePrices" type="button">üíæ Salva prezzi</button>
            <button class="btn danger" id="btnResetPrices" type="button">‚ôªÔ∏è Ripristina default</button>
          </div>
          <div class="hint" style="grid-column:1/-1">
            Questi prezzi li vedi solo tu (Admin). Servono per la stima nel configuratore.
          </div>
        </div>
      `;
      panel.appendChild(box);

      const fill = () => {
        const p = loadPrices();
        for(const k of Object.keys(DEFAULT_PRICES)){
          const el = document.getElementById(`price_${k}`);
          if(el) el.value = Number(p[k] ?? DEFAULT_PRICES[k]);
        }
      };
      fill();

      document.getElementById("btnSavePrices").onclick = () => {
        const p = loadPrices();
        for(const k of Object.keys(DEFAULT_PRICES)){
          const v = Number(document.getElementById(`price_${k}`).value || 0);
          p[k] = v;
        }
        savePrices(p);
        alert("Prezzi salvati ‚úÖ");
        updateBuilderSummary();
      };

      document.getElementById("btnResetPrices").onclick = () => {
        if(!confirm("Ripristinare i prezzi di default?")) return;
        savePrices({ ...DEFAULT_PRICES });
        fill();
        updateBuilderSummary();
      };
    }

    /* =========================
       CONFIGURATORE (UTENTE)
       ========================= */
    /* =========================================================
       CONFIGURATORE SEMPLICE (CLIENTI) - LOGICA (preview + drag)
       Non tocca carrello/catalogo/admin: √® isolato in un modal dedicato.
       ========================================================= */
    const builderLiteBack = document.getElementById("builderLiteBack");
    const dlStage = document.getElementById("dlStage");
    const dlBaseRing = document.getElementById("dlBaseRing");
    const dlBaseSvg = document.getElementById("dlBaseSvg");

    const dlModel = document.getElementById("dlModel");
    const dlDiameter = document.getElementById("dlDiameter");
    const dlRingColor = document.getElementById("dlRingColor");
    const dlFeatherColor = document.getElementById("dlFeatherColor");
    const dlWeave = document.getElementById("dlWeave");
    const dlWeaveNote = document.getElementById("dlWeaveNote");
    const dlWebSvg = document.getElementById("dlWebSvg");
    const dlText = document.getElementById("dlText");
    const dlNotes = document.getElementById("dlNotes");

    const K_LITE = {
      projects: "ae_builderlite_projects_v1"
    };

    let lite = null;
    let liteSelectedId = null;
    let liteWeaveTouched = false;

    function loadLiteProjects(){
      try{
        const arr = JSON.parse(localStorage.getItem(K_LITE.projects) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveLiteProjects(arr){ localStorage.setItem(K_LITE.projects, JSON.stringify(arr)); }

    
    // --- STUDIO MODE (fullscreen + layout ottimizzato mobile) ---
    function enterStudioMode(){
      // aggiunge classi per layout "da app"
      document.body.classList.add("studio-mode");
      builderLiteBack.classList.add("studio-mode");
      // prova a nascondere la barra indirizzi: scroll top
      try{ window.scrollTo({top:0, left:0, behavior:"instant"}); }catch(e){ window.scrollTo(0,0); }

      // prova a forzare landscape (se supportato); altrimenti nessun errore
      const so = screen.orientation || screen.mozOrientation || screen.msOrientation;
      if(so && so.lock){
        so.lock("landscape").catch(()=>{});
      }
      // prova fullscreen API sul modal; fallback CSS se negato
      const target = builderLiteBack;
      const isFs = document.fullscreenElement || document.webkitFullscreenElement;
      if(!isFs){
        (target.requestFullscreen?.() || target.webkitRequestFullscreen?.()).catch(()=> {
          builderLiteBack.classList.add("fs-fallback");
        });
      }
    }
    function exitStudioMode(){
      document.body.classList.remove("studio-mode");
      builderLiteBack.classList.remove("studio-mode");
      builderLiteBack.classList.remove("fs-fallback");
      const so = screen.orientation || screen.mozOrientation || screen.msOrientation;
      if(so && so.unlock){
        try{ so.unlock(); }catch(e){}
      }
      const isFs = document.fullscreenElement || document.webkitFullscreenElement;
      if(isFs){
        (document.exitFullscreen?.() || document.webkitExitFullscreen?.()).catch(()=>{});
      }
    }
function openBuilderLite(){
      lite = {
        id: uid(),
        created_at: new Date().toISOString(),
        base: {
          model: dlModel.value || "Classico",
          diameter: dlDiameter.value || "30",
          ringColor: "",
          featherColor: "",
          weave: (dlWeave?.value || "classico"),
          weave_note: ""
        },
        elements: [],
        text: "",
        notes: ""
      };
      liteSelectedId = null;
      liteWeaveTouched = false;

      dlRingColor.value = "";
      dlFeatherColor.value = "";
      if(dlWeave) dlWeave.value = "classico";
      if(dlWeaveNote) dlWeaveNote.value = "";
      dlText.value = "";
      dlNotes.value = "";

      // pulisci stage (lascia base + web)
      Array.from(dlStage.querySelectorAll(".dl-el")).forEach(n => n.remove());
      applyLiteBaseStyle();
      setLiteShapeByModel(dlModel.value);
      setLiteWeave(dlWeave?.value || "classico");
      seedLiteByModel(dlModel.value);

      builderLiteBack.style.display = "flex";
      document.body.classList.add("builder-open");
          enterStudioMode();
      simSetup();
      simRecalcStage();
    }

    function closeBuilderLite(){
      exitStudioMode();
      document.body.classList.remove("builder-open");
      builderLiteBack.style.display = "none";
      liteSelectedId = null;
    }

    document.getElementById("btnCloseBuilderLite").onclick = closeBuilderLite;
    builderLiteBack.addEventListener("click",(e)=>{ if(e.target===builderLiteBack) closeBuilderLite(); });

    // aggiornamenti live (solo configuratore clienti)
    if(dlRingColor){ dlRingColor.addEventListener("input", ()=>{ applyLiteBaseStyle(); }); }
    if(dlWeave){ dlWeave.addEventListener("change", ()=>{ liteWeaveTouched = true; setLiteWeave(dlWeave.value); }); }
    if(dlWeaveNote){ dlWeaveNote.addEventListener("input", ()=>{ if(lite) lite.base.weave_note = (dlWeaveNote.value||"").trim(); }); }
    if(dlModel){
      dlModel.addEventListener("change", ()=>{
        // cambia modello => suggeriamo tessitura coerente (senza toccare altri dati)
        seedLiteByModel(dlModel.value);
      });
    }


    function applyLiteBaseStyle(){
  const v = (dlRingColor.value || "").trim();
  const col = v ? v : "rgba(233,239,255,.92)";
  if(dlBaseRing){ dlBaseRing.style.borderColor = col; } // legacy, nascosto
  if(dlBaseSvg){ dlBaseSvg.style.color = col; }
}

    /* =========================
       TESSITURA (ANTEPRIMA) - CONFIGURATORE CLIENTI
       ========================= */
    const LITE_SHAPES = {
  circle: (opts={}) => {
    const dash = opts.dash ? ' stroke-dasharray="6 5"' : "";
    return `<circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="6"${dash}/>`;
  },
  moon: () => {
    // crescent outline (semplice)
    return `
      <path d="M62 12
               A38 38 0 1 0 62 88
               A28 28 0 1 1 62 12Z"
            fill="none" stroke="currentColor" stroke-width="6" stroke-linejoin="round"/>
    `;
  },
  heart: () => {
    return `
      <path d="M50 82
               C35 70 18 56 18 38
               C18 26 28 18 38 18
               C44 18 48 21 50 25
               C52 21 56 18 62 18
               C72 18 82 26 82 38
               C82 56 65 70 50 82Z"
            fill="none" stroke="currentColor" stroke-width="6" stroke-linejoin="round"/>
    `;
  },
  star: () => {
    return `
      <path d="M50 12 L61 36 L87 38
               L67 54 L73 80
               L50 67 L27 80
               L33 54 L13 38
               L39 36 Z"
            fill="none" stroke="currentColor" stroke-width="6" stroke-linejoin="round"/>
    `;
  },
  chakra: () => {
    return `
      <circle cx="50" cy="34" r="24" fill="none" stroke="currentColor" stroke-width="6"/>
      <circle cx="50" cy="66" r="24" fill="none" stroke="currentColor" stroke-width="6"/>
      <path d="M50 10 L50 90" fill="none" stroke="currentColor" stroke-width="3" opacity=".7"/>
    `;
  },
  yinyang: () => {
    return `
      <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="6"/>
      <path d="M50 5
               A45 45 0 0 1 50 95
               A22 22 0 0 0 50 50
               A22 22 0 0 1 50 5Z"
            fill="none" stroke="currentColor" stroke-width="3" opacity=".85"/>
      <circle cx="50" cy="28" r="5" fill="currentColor" opacity=".85"/>
      <circle cx="50" cy="72" r="5" fill="currentColor" opacity=".35"/>
    `;
  }
};

function setLiteShapeByModel(mv){
  if(!dlBaseSvg) return;
  const m = String(mv || dlModel.value || "1");
  let shape = "circle";
  let dash = false;
  if(m === "3") shape = "moon";
  else if(m === "4") shape = "heart";
  else if(m === "5") shape = "star";
  else if(m === "6") shape = "chakra";
  else if(m === "7") shape = "yinyang";
  else if(m === "8"){ shape = "circle"; dash = true; }

  const tplFn = LITE_SHAPES[shape] || LITE_SHAPES.circle;
  dlBaseSvg.innerHTML = tplFn({ dash });
}

const WEAVE_TEMPLATES = {
      classico: `
        <g fill="none" stroke="rgba(233,239,255,.75)" stroke-width="1.2">
          <circle cx="50" cy="50" r="45"/>
          <circle cx="50" cy="50" r="35"/>
          <circle cx="50" cy="50" r="25"/>
          <circle cx="50" cy="50" r="15"/>
          <path d="M50 5 L50 95"/>
          <path d="M5 50 L95 50"/>
          <path d="M18 18 L82 82"/>
          <path d="M82 18 L18 82"/>
        </g>
      `,
      fitta: `
        <g fill="none" stroke="rgba(233,239,255,.78)" stroke-width="1.1">
          <circle cx="50" cy="50" r="45"/>
          <circle cx="50" cy="50" r="40"/>
          <circle cx="50" cy="50" r="35"/>
          <circle cx="50" cy="50" r="30"/>
          <circle cx="50" cy="50" r="25"/>
          <circle cx="50" cy="50" r="20"/>
          <circle cx="50" cy="50" r="15"/>
          <circle cx="50" cy="50" r="10"/>
          ${Array.from({length:12}).map((_,i)=>{
            const a = (Math.PI*2/12)*i;
            const x = 50 + Math.cos(a)*45;
            const y = 50 + Math.sin(a)*45;
            return `<path d="M50 50 L${x.toFixed(2)} ${y.toFixed(2)}"/>`;
          }).join("")}
        </g>
      `,
      pizzo: `
        <g fill="none" stroke="rgba(233,239,255,.72)" stroke-width="1.1">
          <circle cx="50" cy="50" r="45" stroke-dasharray="2.2 2.8"/>
          <circle cx="50" cy="50" r="36" stroke-dasharray="1.6 2.4"/>
          <circle cx="50" cy="50" r="28" stroke-dasharray="1.2 2.0"/>
          <circle cx="50" cy="50" r="20" stroke-dasharray="1.0 1.8"/>
          <circle cx="50" cy="50" r="12" stroke-dasharray="1.0 1.6"/>
          ${Array.from({length:8}).map((_,i)=>{
            const a = (Math.PI*2/8)*i;
            const x = 50 + Math.cos(a)*45;
            const y = 50 + Math.sin(a)*45;
            const x2 = 50 + Math.cos(a)*12;
            const y2 = 50 + Math.sin(a)*12;
            return `<path d="M${x2.toFixed(2)} ${y2.toFixed(2)} L${x.toFixed(2)} ${y.toFixed(2)}" opacity=".85"/>`;
          }).join("")}
        </g>
      `,
      chakra: `
        <g fill="none" stroke="rgba(233,239,255,.78)" stroke-width="1.1">
          <circle cx="50" cy="50" r="45"/>
          <circle cx="50" cy="50" r="32"/>
          <circle cx="50" cy="50" r="20"/>
          <circle cx="50" cy="50" r="10"/>
          ${Array.from({length:14}).map((_,i)=>{
            const a = (Math.PI*2/14)*i;
            const x = 50 + Math.cos(a)*45;
            const y = 50 + Math.sin(a)*45;
            return `<path d="M50 50 L${x.toFixed(2)} ${y.toFixed(2)}"/>`;
          }).join("")}
        </g>
      `,
      yinyang: `
        <g fill="none" stroke="rgba(233,239,255,.78)" stroke-width="1.2">
          <circle cx="50" cy="50" r="45"/>
          <path d="M50 5
                   A45 45 0 0 0 50 95
                   A22.5 22.5 0 0 1 50 50
                   A22.5 22.5 0 0 0 50 5" />
          <path d="M50 5
                   A45 45 0 0 1 50 95
                   A22.5 22.5 0 0 0 50 50
                   A22.5 22.5 0 0 1 50 5" opacity=".55"/>
          <circle cx="50" cy="28" r="5" />
          <circle cx="50" cy="72" r="5" opacity=".55"/>
        </g>
      `,
      stella: `
        <g fill="none" stroke="rgba(233,239,255,.78)" stroke-width="1.15">
          <circle cx="50" cy="50" r="45"/>
          <path d="M50 10 L61 38 L90 38 L66 55 L75 85 L50 67 L25 85 L34 55 L10 38 L39 38 Z" opacity=".75"/>
          <circle cx="50" cy="50" r="18" opacity=".55"/>
        </g>
      `
    };

    function setLiteWeave(kind){
      const k = String(kind || "classico");
      const tpl = WEAVE_TEMPLATES[k] || WEAVE_TEMPLATES.classico;
      if(dlWebSvg) dlWebSvg.innerHTML = tpl;
      if(lite){
        lite.base.weave = k;
        lite.base.weave_note = (dlWeaveNote?.value || "").trim();
      }
    }



    function seedLiteByModel(modelValue){
      if(!lite) return;

      const mv = String(modelValue || dlModel.value || "1");

      // cambia anche la FORMA base in anteprima (solo configuratore clienti)
      setLiteShapeByModel(mv);

      // Suggerimento tessitura in base al modello (solo anteprima)
      let suggested = "classico";
      if(mv === "6") suggested = "chakra";
      else if(mv === "7") suggested = "yinyang";
      else if(mv === "5") suggested = "stella";
      // se l‚Äôutente NON ha gi√† toccato la tessitura, suggeriamo quella coerente col modello
      if(!liteWeaveTouched){
        if(dlWeave) dlWeave.value = suggested;
        setLiteWeave(suggested);
      }

      // aggiunge una base "tipo" SOLO se non ci sono elementi (cos√¨ non distrugge il lavoro)
      if(lite.elements.length) return;

      // centro
      if(mv === "1"){ // Classico
        liteAdd("bead");
        liteAdd("feather"); lite.elements[lite.elements.length-1].x -= 70; lite.elements[lite.elements.length-1].y += 60;
        liteAdd("feather"); lite.elements[lite.elements.length-1].y += 80;
        liteAdd("feather"); lite.elements[lite.elements.length-1].x += 70; lite.elements[lite.elements.length-1].y += 60;
        syncLiteStageFromData();
      }else if(mv === "2"){ // Cerchio
        liteAdd("ring_small"); lite.elements[lite.elements.length-1].y += 40;
        liteAdd("feather"); lite.elements[lite.elements.length-1].x -= 40; lite.elements[lite.elements.length-1].y += 110;
        liteAdd("feather"); lite.elements[lite.elements.length-1].x += 40; lite.elements[lite.elements.length-1].y += 110;
        syncLiteStageFromData();
      }else if(mv === "3"){ // Luna
        liteAdd("moon"); lite.elements[lite.elements.length-1].y -= 40;
        syncLiteStageFromData();
      }else if(mv === "4"){ // Cuore
        liteAdd("heart"); lite.elements[lite.elements.length-1].y -= 40;
        syncLiteStageFromData();
      }else if(mv === "5"){ // Stella
        liteAdd("star"); lite.elements[lite.elements.length-1].y -= 40;
        syncLiteStageFromData();
      }else if(mv === "6"){ // Chakra
        // catena di cerchi piccoli
        for(let i=0;i<7;i++){
          liteAdd("ring_small");
          lite.elements[lite.elements.length-1].x = dlStage.getBoundingClientRect().width*0.50;
          lite.elements[lite.elements.length-1].y = dlStage.getBoundingClientRect().height*(0.30 + i*0.08);
        }
        syncLiteStageFromData();
      }else if(mv === "7"){ // Yin & Yang
        liteAdd("yinyang"); lite.elements[lite.elements.length-1].y -= 40;
        syncLiteStageFromData();
      }
    }

    
    // ====== LITE: Accessori + Gesture (drag / pinch / rotate) ======
    const LITE_EMOJI = {
      feather:"ü™∂",
      crystal:"üíé",
      bead:"‚ö™",
      bead_red:"üî¥",
      bead_black:"‚ö´",
      bead_blue:"üîµ",
      bead_green:"üü¢",
      bead_purple:"üü£",
      bead_yellow:"üü°",
      bead_pink:"üíó",
      bead_gold:"üü°",
      bead_silver:"‚ö™",
      bow:"üéÄ",
      bell:"üîî",
      snow:"‚ùÑÔ∏è",
      glitter:"‚ú®",
      orc:"üëπ",
      symbolA:"üÖ∞Ô∏è",
      lace:"üßµ",
      light:"üí°",
      ring_small:"‚≠ï",
      ring:"‚≠ï",
      chain:"‚õìÔ∏è",
      chain_gold:"üîó",
      chain_silver:"‚õìÔ∏è",
      moon:"üåô",
      heart:"‚ù§Ô∏è",
      star:"‚≠ê",
      yinyang:"‚òØÔ∏è"
    };

    function liteEmoji(type){
      const t = String(type || "").trim();
      if(t.startsWith("emoji:")) return t.slice(6) || "‚ú®";
      return LITE_EMOJI[t] || "‚ú®";

    // Pinch/rotate anche sulla STAGE quando un elemento √® selezionato (utile per emoji piccole)
    (function(){
      const st = dlStage;
      if(!st) return;
      st.style.touchAction = "none";
      const state = { pointers:new Map(), startDist:0, startAng:0, startScale:1, startRot:0, active:false };
      const toStage = (e)=>{
        const r = st.getBoundingClientRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      };
      const getSel = ()=>{
        if(!liteSelectedId || !lite) return null;
        return lite.elements.find(x=>x && x.id===liteSelectedId) || null;
      };
      st.addEventListener("pointerdown", (ev)=>{
        // se tocchi direttamente un elemento, ci pensa attachLiteGesture
        if(ev.target && ev.target.closest && ev.target.closest(".dl-el")) return;
        const sel = getSel();
        if(!sel) return;
        ev.preventDefault();
        state.pointers.set(ev.pointerId, toStage(ev));
        st.setPointerCapture(ev.pointerId);
        if(state.pointers.size===2){
          const pts = Array.from(state.pointers.values()).slice(0,2);
          const dx = pts[1].x-pts[0].x, dy=pts[1].y-pts[0].y;
          state.startDist = Math.max(1, Math.hypot(dx,dy));
          state.startAng = Math.atan2(dy,dx);
          ensureLiteElDefaults(sel);
          state.startScale = sel.scale;
          state.startRot = sel.rot;
          state.active = true;
        }
      });
      st.addEventListener("pointermove", (ev)=>{
        if(!state.pointers.has(ev.pointerId)) return;
        const sel = getSel();
        if(!sel) return;
        state.pointers.set(ev.pointerId, toStage(ev));
        if(state.active && state.pointers.size>=2){
          const pts = Array.from(state.pointers.values()).slice(0,2);
          const dx = pts[1].x-pts[0].x, dy=pts[1].y-pts[0].y;
          const dist = Math.max(1, Math.hypot(dx,dy));
          const ang = Math.atan2(dy,dx);
          let nextScale = state.startScale * (dist/state.startDist);
          nextScale = Math.max(0.45, Math.min(3.0, nextScale));
          let nextRot = state.startRot + ((ang-state.startAng) * 180/Math.PI);
          nextRot = (nextRot+360)%360;
          sel.scale = nextScale;
          sel.rot = nextRot;
          const node = dlStage.querySelector('.dl-el[data-id="'+sel.id+'"]');
          if(node) applyLiteElTransform(node, sel);
        }
      });
      const end = (ev)=>{
        if(state.pointers.has(ev.pointerId)) state.pointers.delete(ev.pointerId);
        if(state.pointers.size<2) state.active=false;
      };
      st.addEventListener("pointerup", end);
      st.addEventListener("pointercancel", end);
      st.addEventListener("lostpointercapture", end);
    })();
    }

    function ensureLiteElDefaults(el){
      if(el.scale == null) el.scale = 1;
      if(el.rot == null) el.rot = 0;
    }

    function applyLiteElTransform(node, el){
      ensureLiteElDefaults(el);
      node.style.transformOrigin = "50% 50%";
      node.style.transform = `translate(-50%,-50%) rotate(${el.rot}deg) scale(${el.scale})`;
    }

    function attachLiteGesture(node, el){
      // Multi-touch su singolo elemento:
      // 1 dito = trascina
      // 2 dita = pinch (zoom) + rotate
      node.style.touchAction = "none";

      node.addEventListener("pointerdown", (ev)=>{
        ev.preventDefault();
        if(!lite) return;

        selectLite(el.id);

        const state = (node._liteGesture ||= {
          pointers: new Map(),
          mode: "drag",
          drag: { offX:0, offY:0 },
          tf: { startDist:0, startAng:0, startScale:1, startRot:0 }
        });

        const stageRect = ()=> dlStage.getBoundingClientRect();
        const toStage = (e)=>{
          const r = stageRect();
          return { x: e.clientX - r.left, y: e.clientY - r.top };
        };

        const p = toStage(ev);
        state.pointers.set(ev.pointerId, p);
        node.setPointerCapture(ev.pointerId);

        // Se √® il primo dito -> prepara drag
        if(state.pointers.size === 1){
          state.mode = "drag";
          state.drag.offX = p.x - el.x;
          state.drag.offY = p.y - el.y;
        }

        // Se arriva il secondo dito -> prepara transform
        if(state.pointers.size === 2){
          state.mode = "transform";
          const pts = Array.from(state.pointers.values());
          const dx = pts[1].x - pts[0].x;
          const dy = pts[1].y - pts[0].y;
          state.tf.startDist = Math.hypot(dx, dy);
          state.tf.startAng  = Math.atan2(dy, dx);
          ensureLiteElDefaults(el);
          state.tf.startScale = el.scale;
          state.tf.startRot   = el.rot;
        }

        const onMove = (e2)=>{
          if(!lite) return;
          if(!state.pointers.has(e2.pointerId)) return;

          state.pointers.set(e2.pointerId, toStage(e2));

          const r2 = stageRect();

          if(state.mode === "transform" && state.pointers.size >= 2){
            const pts = Array.from(state.pointers.values()).slice(0,2);
            const dx = pts[1].x - pts[0].x;
            const dy = pts[1].y - pts[0].y;
            const dist = Math.max(1, Math.hypot(dx, dy));
            const ang  = Math.atan2(dy, dx);

            // scale
            let nextScale = state.tf.startScale * (dist / Math.max(1, state.tf.startDist));
            nextScale = Math.max(0.45, Math.min(3.0, nextScale));

            // rotate
            let nextRot = state.tf.startRot + ((ang - state.tf.startAng) * 180 / Math.PI);
            // normalize (opzionale)
            if(nextRot > 180) nextRot -= 360;
            if(nextRot < -180) nextRot += 360;

            el.scale = nextScale;
            el.rot = nextRot;
            applyLiteElTransform(node, el);
            return;
          }

          // drag 1 dito
          const pt = state.pointers.get(e2.pointerId);
          if(!pt) return;

          el.x = Math.max(10, Math.min(r2.width - 10, pt.x - state.drag.offX));
          el.y = Math.max(10, Math.min(r2.height - 10, pt.y - state.drag.offY));

          node.style.left = el.x + "px";
          node.style.top  = el.y + "px";
        };

        const onUp = (e3)=>{
          if(state.pointers.has(e3.pointerId)) state.pointers.delete(e3.pointerId);

          // Se resta un dito, torna a drag con quello rimasto
          if(state.pointers.size === 1){
            state.mode = "drag";
            const pt = Array.from(state.pointers.values())[0];
            state.drag.offX = pt.x - el.x;
            state.drag.offY = pt.y - el.y;
          }

          // Se non resta nessun dito, stop
          if(state.pointers.size === 0){
            node.removeEventListener("pointermove", onMove);
            node.removeEventListener("pointerup", onUp);
            node.removeEventListener("pointercancel", onUp);
          }
        };

        node.addEventListener("pointermove", onMove);
        node.addEventListener("pointerup", onUp);
        node.addEventListener("pointercancel", onUp);
      });
    }

    
    // ====== PINCH/ROTATE su STAGE (anche se le dita non sono sopra l'elemento) ======
    (function bindStagePinch(){
      if(!dlStage) return;

      const st = {
        pointers: new Map(),
        mode: "idle", // idle | transform
        tf: { startDist:0, startAng:0, startScale:1, startRot:0 }
      };

      const stageRect = ()=> dlStage.getBoundingClientRect();
      const toStage = (e)=>{
        const r = stageRect();
        return { x: e.clientX - r.left, y: e.clientY - r.top };
      };
      const dist = (a,b)=> Math.hypot(b.x-a.x, b.y-a.y);
      const ang  = (a,b)=> Math.atan2(b.y-a.y, b.x-a.x);

      const getSelectedEl = ()=>{
        if(!lite || !liteSelectedId) return null;
        return lite.elements.find(e=>e.id === liteSelectedId) || null;
      };

      dlStage.addEventListener("pointerdown", (ev)=>{
        // Non interferire col drag dell'elemento (gestito dal nodo .dl-el)
        if(ev.target && ev.target.closest && ev.target.closest(".dl-el")) return;

        // Qui ci interessa il pinch con 2 dita sullo stage
        const sel = getSelectedEl();
        if(!sel) return;

        st.pointers.set(ev.pointerId, toStage(ev));

        // Attiva solo quando arrivano 2 dita
        if(st.pointers.size === 2){
          // Evita lo zoom pagina del browser
          ev.preventDefault();
          dlStage.setPointerCapture(ev.pointerId);
          st.mode = "transform";
          const pts = Array.from(st.pointers.values());
          st.tf.startDist = Math.max(10, dist(pts[0], pts[1]));
          st.tf.startAng  = ang(pts[0], pts[1]);
          ensureLiteElDefaults(sel);
          st.tf.startScale = sel.scale;
          st.tf.startRot   = sel.rot;
        }
      });

      dlStage.addEventListener("pointermove", (ev)=>{
        if(!st.pointers.has(ev.pointerId)) return;
        const sel = getSelectedEl();
        if(!sel) return;

        st.pointers.set(ev.pointerId, toStage(ev));

        if(st.mode === "transform" && st.pointers.size >= 2){
          const pts = Array.from(st.pointers.values()).slice(0,2);
          const d = Math.max(10, dist(pts[0], pts[1]));
          const a = ang(pts[0], pts[1]);

          let nextScale = st.tf.startScale * (d / st.tf.startDist);
          nextScale = Math.max(0.45, Math.min(3.0, nextScale));

          let nextRot = st.tf.startRot + ((a - st.tf.startAng) * 180 / Math.PI);
          if(nextRot > 180) nextRot -= 360;
          if(nextRot < -180) nextRot += 360;

          sel.scale = nextScale;
          sel.rot = nextRot;

          const node = dlStage.querySelector(`.dl-el[data-id="${CSS.escape(sel.id)}"]`);
          if(node) applyLiteElTransform(node, sel);
        }
      });

      const end = (ev)=>{
        if(st.pointers.has(ev.pointerId)) st.pointers.delete(ev.pointerId);
        if(st.pointers.size < 2){
          st.mode = "idle";
        }
      };
      dlStage.addEventListener("pointerup", end);
      dlStage.addEventListener("pointercancel", end);
      dlStage.addEventListener("lostpointercapture", end);
    })();
    // ====== /PINCH/ROTATE su STAGE ======


    function createLiteNode(el){
      const node = document.createElement("div");
      node.className = "dl-el";
      node.dataset.id = el.id;

      // contenuto
      if(el.type === "ring_small"){
        const c = document.createElement("div");
        c.className = "dl-ring small";
        node.appendChild(c);
      }else if(el.type === "ring"){
        const c = document.createElement("div");
        c.className = "dl-ring";
        node.appendChild(c);
      }else{
        const s = document.createElement("div");
        s.className = "emoji";
        s.textContent = liteEmoji(el.type);
        node.appendChild(s);
      }

      // pos + transform
      node.style.left = el.x + "px";
      node.style.top  = el.y + "px";
      applyLiteElTransform(node, el);
      applyLiteElTransform(node, el);

      // gesture
      attachLiteGesture(node, el);

      return node;
    }

    function syncLiteStageFromData(){
      // ricrea gli elementi nella stage da lite.elements (senza toccare base + web)
      Array.from(dlStage.querySelectorAll(".dl-el")).forEach(n=>n.remove());
      if(!lite) return;

      for(const el of lite.elements){
        if(!el || !el.id) continue;
        ensureLiteElDefaults(el);
        const node = createLiteNode(el);
        dlStage.appendChild(node);
      }
      selectLite(liteSelectedId);
    }


function applyLitePreset(id){
      if(!lite) return;
      // reset sicuro
      lite.elements = [];
      liteSelectedId = null;
      Array.from(dlStage.querySelectorAll(".dl-el")).forEach(n=>n.remove());

      const stageR = dlStage.getBoundingClientRect();
      const cx = stageR.width*0.50;
      const cy = stageR.height*0.55;

      const addAt = (type, x, y)=>{
        const el = { id: uid(), type, x, y, scale:1, rot:0 };
        lite.elements.push(el);
      };

      if(id === "viola"){
        dlModel.value = "1";
        dlRingColor.value = "viola";
        dlFeatherColor.value = "viola";
        if(dlWeave) dlWeave.value = "classico";
        setLiteWeave(dlWeave?.value || "classico");
        addAt("crystal", cx-70, cy+90);
        addAt("crystal", cx+70, cy+90);
        addAt("feather", cx-90, cy+140);
        addAt("feather", cx, cy+160);
        addAt("feather", cx+90, cy+140);
        addAt("bead", cx, cy-10);
      }else if(id === "oro"){
        dlModel.value = "2";
        dlRingColor.value = "oro";
        dlFeatherColor.value = "bianco";
        if(dlWeave) dlWeave.value = "classico";
        setLiteWeave(dlWeave?.value || "classico");
        addAt("bead", cx-60, cy+95);
        addAt("bead", cx, cy+105);
        addAt("bead", cx+60, cy+95);
        addAt("feather", cx-90, cy+150);
        addAt("feather", cx, cy+170);
        addAt("feather", cx+90, cy+150);
        addAt("crystal", cx, cy-10);
      }else if(id === "natale"){
        dlModel.value = "5";
        dlRingColor.value = "bianco";
        dlFeatherColor.value = "blu e oro";
        if(dlWeave) dlWeave.value = "fitta";
        liteWeaveTouched = true;
        setLiteWeave(dlWeave?.value || "fitta");
        addAt("star", cx, cy-35);
        addAt("bow", cx-110, cy+140);
        addAt("bow", cx, cy+160);
        addAt("bow", cx+110, cy+140);
        addAt("bell", cx-110, cy+170);
        addAt("bell", cx, cy+190);
        addAt("bell", cx+110, cy+170);
        addAt("snow", cx-90, cy-120);
        addAt("snow", cx+90, cy-120);
      }else if(id === "albero"){
        dlModel.value = "8";
        dlRingColor.value = "bianco";
        dlFeatherColor.value = "multicolor";
        if(dlWeave) dlWeave.value = "classico";
        setLiteWeave(dlWeave?.value || "classico");
        // molti cerchi piccoli in stile albero
        const rows = [
          [0],
          [-45,45],
          [-70,0,70],
          [-95,-30,30,95],
          [-120,-60,0,60,120]
        ];
        let y = stageR.height*0.20
        for(const r of rows){
          for(const dx of r){
            addAt("ring_small", cx+dx, y);
          }
          y += 48;
        }
        // luci
        for(let i=0;i<8;i++){
          addAt("light", cx + (i%2? -120:120) + (i*10), stageR.height*0.20 + i*40);
        }
      }else if(id === "real"){
        dlModel.value = "1";
        dlRingColor.value = "nero";
        dlFeatherColor.value = "rosso e nero";
        dlText.value = "REAL HASTA LA MUERTE";
        if(dlWeave) dlWeave.value = "fitta";
        liteWeaveTouched = true;
        if(dlWeaveNote) dlWeaveNote.value = "Brillantini + perle rosse/nere + simboli";
        setLiteWeave(dlWeave?.value || "fitta");
        addAt("bead_red", cx-70, cy+95);
        addAt("bead_black", cx-70, cy+125);
        addAt("bead_red", cx-70, cy+155);

        addAt("bead_red", cx+70, cy+95);
        addAt("bead_black", cx+70, cy+125);
        addAt("bead_red", cx+70, cy+155);

        addAt("orc", cx-110, cy+70);
        addAt("orc", cx+110, cy+70);
        addAt("symbolA", cx, cy+40);
        addAt("feather", cx-90, cy+170);
        addAt("feather", cx, cy+200);
        addAt("feather", cx+90, cy+170);
        addAt("glitter", cx-80, cy-120);
        addAt("glitter", cx+80, cy-120);
      }

      // aggiorna dati base
      lite.base.model = dlModel.value;
      lite.base.diameter = dlDiameter.value || "30";
      lite.base.ringColor = dlRingColor.value.trim();
      lite.base.featherColor = dlFeatherColor.value.trim();
      lite.base.weave = (dlWeave?.value || "classico");
      lite.base.weave_note = (dlWeaveNote?.value || "").trim();
      lite.text = dlText.value.trim();
      lite.notes = (dlNotes.value||"").trim();

      applyLiteBaseStyle();
      syncLiteStageFromData();
      seedLiteByModel(dlModel.value);
    }

    [dlModel, dlDiameter, dlRingColor, dlFeatherColor, dlText, dlNotes].forEach(el=>{
      el.addEventListener("input", ()=>{
        if(!lite) return;
        lite.base.model = dlModel.value;
        lite.base.diameter = dlDiameter.value;
        lite.base.ringColor = dlRingColor.value.trim();
        lite.base.featherColor = dlFeatherColor.value.trim();
        lite.text = dlText.value.trim();
        lite.notes = (dlNotes.value||"").trim();
        applyLiteBaseStyle();
      });
      el.addEventListener("change", ()=>{
        if(!lite) return;
        lite.base.model = dlModel.value;
        lite.base.diameter = dlDiameter.value;
        lite.base.ringColor = dlRingColor.value.trim();
        lite.base.featherColor = dlFeatherColor.value.trim();
        lite.text = dlText.value.trim();
        lite.notes = (dlNotes.value||"").trim();
        applyLiteBaseStyle();
      });
    });

    function liteAdd(type){
      if(!lite) return;

      const cleanType = String(type || "").trim();
      const id = uid();

      // posizione iniziale al centro stage
      const rect = dlStage.getBoundingClientRect();
      const x = rect.width * 0.50;
      const y = rect.height * 0.70;

      const el = { id, type: cleanType, x, y, scale: 1, rot: 0 };
      lite.elements.push(el);

      const node = createLiteNode(el);
      dlStage.appendChild(node);
      selectLite(id);
    }


function selectLite(id){
      liteSelectedId = id || null;
      Array.from(dlStage.querySelectorAll(".dl-el")).forEach(n=>{
        n.classList.toggle("selected", n.dataset.id === liteSelectedId);
      });
    }

    document.getElementById("dlSelectNone").onclick = ()=> selectLite(null);

    document.getElementById("dlDelete").onclick = ()=>{
      if(!lite || !liteSelectedId){ alert("Seleziona prima un elemento."); return; }
      const id = liteSelectedId;
      lite.elements = lite.elements.filter(e=>e.id!==id);
      const node = dlStage.querySelector(`.dl-el[data-id="${CSS.escape(id)}"]`);
      if(node) node.remove();
      selectLite(null);
    };

    document.getElementById("dlReset").onclick = ()=>{
      if(!lite) return;
      if(!confirm("Reset anteprima?")) return;
      lite.elements = [];
      liteSelectedId = null;
      Array.from(dlStage.querySelectorAll(".dl-el")).forEach(n => n.remove());
      selectLite(null);
      // dopo reset: ricalcola dimensioni stage/sheet (evita "layout strani")
      if(typeof simRecalcStage === "function") simRecalcStage();
    };

    // Fullscreen toggle (builder modal)
    const btnDlFs = document.getElementById("dlFullscreen");
    if(btnDlFs){
      btnDlFs.onclick = async ()=>{
        // Toggle modalit√† studio
        if(document.body.classList.contains("studio-mode")){
          exitStudioMode();
        }else{
          enterStudioMode();
      simSetup();
      simRecalcStage();
        }
      };
    // --- Color picker for selected accessory ---
    const dlColorBtn = document.getElementById("dlColorBtn");
    const dlColorOverlay = document.getElementById("dlColorOverlay");
    const dlColorSwatches = document.getElementById("dlColorSwatches");
    const dlColorClose = document.getElementById("dlColorClose");

    const DL_COLORS = ["#FFFFFF","#F2F2F2","#000000","#2C3E50","#E74C3C","#FF6FB1","#F1C40F","#2ECC71","#3498DB","#9B59B6","#AEEBFF","#B388FF"];

    function isColorableType(t){
      return (t==="bead" || t==="piuma" || t==="crystal" || t==="fiocco" || (t && t.startsWith("perla")));
    }

    function refreshColorButton(){
      if(!dlColorBtn) return;
      if(!liteSelId){ dlColorBtn.style.display="none"; return; }
      const el = liteData.elements.find(x=>x.id===liteSelId);
      dlColorBtn.style.display = (el && isColorableType(el.type)) ? "" : "none";
    }

    function openColorPicker(){
      if(!liteSelId) return;
      const el = liteData.elements.find(x=>x.id===liteSelId);
      if(!el || !isColorableType(el.type)) return;

      dlColorSwatches.innerHTML = "";
      DL_COLORS.forEach(c=>{
        const b = document.createElement("button");
        b.className = "dl-swatch";
        b.style.background = c;
        b.addEventListener("click", ()=>{
          el.color = c;
          syncLiteStageFromData();
          dlColorOverlay.style.display = "none";
          refreshColorButton();
        });
        dlColorSwatches.appendChild(b);
      });

      dlColorOverlay.style.display = "flex";
    }

    dlColorBtn?.addEventListener("click", openColorPicker);
    dlColorClose?.addEventListener("click", ()=> dlColorOverlay.style.display="none");
    dlColorOverlay?.addEventListener("click", (e)=>{ if(e.target===dlColorOverlay) dlColorOverlay.style.display="none"; });

    }


    // Palette buttons
    // Palette accessori (delegation)
    document.querySelectorAll('.palette .chip[data-add]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const t = btn.getAttribute('data-add');
        // Emoji: consenti scelta emoji personalizzata (zoomabile come gli altri elementi)
        if(t === 'orc'){
          const val = prompt('Inserisci un emoji (es: ü•∞ ‚≠êÔ∏è ‚ù§Ô∏è)', 'üëπ');
          if(val && String(val).trim()){
            liteAdd('emoji:' + String(val).trim());
          }
          return;
        }
        liteAdd(t);
      });
    });

    // Preset rapidi
    const dlPresets = document.getElementById("dlPresets");
    if(dlPresets){
      dlPresets.addEventListener("click", (e)=>{
        const b = e.target.closest("[data-preset]");
        if(!b) return;
        applyLitePreset(b.getAttribute("data-preset"));
      });
    }

    function liteSummaryForWhatsApp(project){
      const rect = dlStage.getBoundingClientRect();
      const counts = {};
      for(const e of (project.elements||[])){
        counts[e.type] = (counts[e.type]||0) + 1;
      }
      const typeName = (t)=>({
        feather:"Piuma",
        crystal:"Cristallo",
        bead:"Perla",
        bow:"Fiocco",
        snow:"Fiocco neve",
        light:"Luci",
        ring_small:"Cerchio piccolo",
        ring:"Cerchio"
      })[t] || t;

      const weaveLabel = (w)=>({classico:"Classica", fitta:"Ragnatela fitta", pizzo:"Centrino/Pizzo", chakra:"Chakra", yinyang:"Yin & Yang", stella:"Stella"})[w] || w;

      const lines = [];
      lines.push("Ciao! Vorrei un acchiappasogni personalizzato:");
      lines.push(`‚Ä¢ Modello: ${project.base.model}`);
      lines.push(`‚Ä¢ Diametro: ${project.base.diameter} cm`);
      if(project.base.ringColor) lines.push(`‚Ä¢ Colore cerchio: ${project.base.ringColor}`);
      if(project.base.featherColor) lines.push(`‚Ä¢ Colore piume: ${project.base.featherColor}`);

      if(project.base.weave) lines.push(`‚Ä¢ Tessitura: ${weaveLabel(project.base.weave)}`);
      if(project.base.weave_note) lines.push(`‚Ä¢ Intreccio: ${project.base.weave_note}`);

      if(Object.keys(counts).length){
        lines.push("");
        lines.push("ACCESSORI (anteprima):");
        for(const [t,n] of Object.entries(counts)){
          lines.push(`‚Ä¢ ${typeName(t)} √ó ${n}`);
        }
      }

      // posizioni (in percentuale) ‚Äî utile per ‚Äúcome in foto‚Äù
      if(project.elements?.length){
        lines.push("");
        lines.push("POSIZIONI (indicative):");
        project.elements.forEach((e,i)=>{
          const xp = Math.round((e.x / rect.width) * 100);
          const yp = Math.round((e.y / rect.height) * 100);
          lines.push(`‚Ä¢ ${i+1}) ${typeName(e.type)} ‚Üí ${xp}% x, ${yp}% y`);
        });
      }

      if(project.text) lines.push(`\nScritta: ${project.text}`);
      if(project.notes) lines.push(`\nNote: ${project.notes}`);

      lines.push("\nGrazie!");
      return lines.join("\n");
    }

    async function liteOpenWhatsApp(project){
      const number = getWa();
      const msg = liteSummaryForWhatsApp(project);

      // Prova a condividere FOTO + TESTO (WhatsApp) usando il pannello "Condividi" del telefono
      try{
        const stage = document.getElementById("dlStage");
        if(stage && window.html2canvas && navigator.share){
          const canvas = await html2canvas(stage, {
            backgroundColor: null,
            scale: Math.min(2, window.devicePixelRatio || 2),
            useCORS: true
          });

          const blob = await new Promise(res => canvas.toBlob(res, "image/png", 1.0));
          if(blob){
            const file = new File([blob], "anteprima_acchiappasogni.png", { type: "image/png" });

            // Alcuni telefoni richiedono canShare per i file
            if(!navigator.canShare || navigator.canShare({ files: [file] })){
              await navigator.share({
                files: [file],
                text: msg
              });
              return; // ‚úÖ fatto (foto + testo)
            }
          }
        }
      }catch(err){
        // Se fallisce, andiamo in fallback a WhatsApp con testo
        console.warn("Condivisione con immagine non disponibile:", err);
      }

      // Fallback: apre WhatsApp con il testo (l‚Äôutente allega la foto manualmente se vuole)
      const url = `https://wa.me/${encodeURIComponent(number.replace(/\s+/g,""))}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }


    function liteSave(){
      if(!lite){ return; }
      // sync base
      lite.base.model = dlModel.value;
      lite.base.diameter = dlDiameter.value;
      lite.base.ringColor = dlRingColor.value.trim();
      lite.base.featherColor = dlFeatherColor.value.trim();
      lite.text = dlText.value.trim();
      lite.notes = (dlNotes.value||"").trim();

      const all = loadLiteProjects();
      all.push(JSON.parse(JSON.stringify(lite)));
      saveLiteProjects(all);
      alert("Progetto salvato ‚úÖ");
    }

    document.getElementById("dlSave").onclick = liteSave;
    document.getElementById("dlSend").onclick = ()=>{
      if(!lite){ return; }
      lite.base.model = dlModel.value;
      lite.base.diameter = dlDiameter.value;
      lite.base.ringColor = dlRingColor.value.trim();
      lite.base.featherColor = dlFeatherColor.value.trim();
      lite.text = dlText.value.trim();
      lite.notes = (dlNotes.value||"").trim();
      liteOpenWhatsApp(lite);
    };
    document.getElementById("dlSaveSend").onclick = ()=>{
      liteSave();
      if(lite) liteOpenWhatsApp(lite);
    };

    const builderModalBack = document.getElementById("builderModalBack");
    const btnCloseBuilder = document.getElementById("btnCloseBuilder");

    const bModel = document.getElementById("bModel");
    const bDiameter = document.getElementById("bDiameter");
    const bRingColor = document.getElementById("bRingColor");
    const bFeatherColor = document.getElementById("bFeatherColor");

    const bRingsList = document.getElementById("bRingsList");
    const bFeathersList = document.getElementById("bFeathersList");
    const bAccList = document.getElementById("bAccList");

    const bHasPhoto = document.getElementById("bHasPhoto");
    const bPhotoFile = document.getElementById("bPhotoFile");
    const bPhotoPreview = document.getElementById("bPhotoPreview");

    const bText = document.getElementById("bText");
    const bNotes = document.getElementById("bNotes");

    const bSummary = document.getElementById("bSummary");
    const bEstimate = document.getElementById("bEstimate");
    const bCode = document.getElementById("bCode");

    let currentBuilder = null;

    function builderCode(){
      const n = Date.now().toString().slice(-6);
      return `AE-${new Date().getFullYear()}-${n}`;
    }

    function loadProjects(){
      try{
        const arr = JSON.parse(localStorage.getItem(K.projects) || "[]");
        return Array.isArray(arr) ? arr : [];
      }catch{ return []; }
    }
    function saveProjects(arr){ localStorage.setItem(K.projects, JSON.stringify(arr)); }

    function openBuilder(){
      currentBuilder = {
        id: uid(),
        code: builderCode(),
        created_at: new Date().toISOString(),
        base: { model: bModel.value, diameter: bDiameter.value, ringColor:"", featherColor:"" },
        rings: [],
        feathers: [],
        accessories: [],
        hasPhoto: "no",
        photoDataUrl: "",
        text: "",
        notes: ""
      };

      bRingColor.value = "";
      bFeatherColor.value = "";
      bText.value = "";
      bNotes.value = "";
      bHasPhoto.value = "no";
      bPhotoFile.value = "";
      bPhotoPreview.style.display = "none";
      bPhotoPreview.src = "";

      bRingsList.innerHTML = "";
      bFeathersList.innerHTML = "";
      bAccList.innerHTML = "";

      addRing();
      addFeathersGroup("centro");
      addAccessory();

      bCode.textContent = "Codice: " + currentBuilder.code;

      builderModalBack.style.display = "flex";
      updateBuilderSummary();
    }

    function closeBuilder(){ builderModalBack.style.display = "none"; }

    btnCloseBuilder.onclick = closeBuilder;
    builderModalBack.addEventListener("click",(e)=>{ if(e.target===builderModalBack) closeBuilder(); });

    // attacca al pulsante in alto
    document.getElementById("btnCustomizer").onclick = openBuilderLite;
    function loadIntoBuilder(project){
      if(!project) return;
      // Clone to avoid mutating saved object accidentally
      currentBuilder = JSON.parse(JSON.stringify(project));
      const _rings = Array.isArray(currentBuilder.rings) ? currentBuilder.rings : [];
      const _feathers = Array.isArray(currentBuilder.feathers) ? currentBuilder.feathers : [];
      const _accessories = Array.isArray(currentBuilder.accessories) ? currentBuilder.accessories : [];
      currentBuilder.rings = [];
      currentBuilder.feathers = [];
      currentBuilder.accessories = [];
      currentBuilder.photoDataUrl = currentBuilder.photoDataUrl || "";

      // Base fields
      bModel.value = currentBuilder.base?.model || bModel.value;
      bDiameter.value = currentBuilder.base?.diameter || bDiameter.value;
      bRingColor.value = currentBuilder.base?.ringColor || "";
      bFeatherColor.value = currentBuilder.base?.featherColor || "";

      bHasPhoto.value = currentBuilder.hasPhoto || "no";
      bText.value = currentBuilder.text || "";
      bNotes.value = currentBuilder.notes || "";

      // Photo preview
      if(currentBuilder.photoDataUrl){
        bPhotoPreview.src = currentBuilder.photoDataUrl;
        bPhotoPreview.style.display = "block";
      } else {
        bPhotoPreview.src = "";
        bPhotoPreview.style.display = "none";
      }
      bPhotoFile.value = "";

      // Rebuild lists
      bRingsList.innerHTML = "";
      bFeathersList.innerHTML = "";
      bAccList.innerHTML = "";

      (_rings || []).forEach(r => addRing(r));
      (_feathers || []).forEach(f => addFeathersGroup(null, f));
      (_accessories || []).forEach(a => addAccessory(a));

      bCode.textContent = "Codice: " + (currentBuilder.code || "‚Äî");
      updateBuilderSummary();
    }

    function resumeLastProject(){
      const all = loadProjects();
      if(!all.length){
        alert("Non ci sono progetti salvati da riprendere.");
        return;
      }
      const last = all[all.length - 1];
      // Se il modal non √® aperto, aprilo
      if(builderModalBack.style.display !== "flex"){
        builderModalBack.style.display = "flex";
      }
      loadIntoBuilder(last);
      alert("Progetto ripristinato ‚úÖ");
    }


    document.getElementById("btnAddRing").onclick = addRing;
    document.getElementById("btnAddFeathers").onclick = () => addFeathersGroup();
    document.getElementById("btnAddAcc").onclick = addAccessory;

    [bModel, bDiameter, bRingColor, bFeatherColor, bHasPhoto, bText, bNotes].forEach(el=>{
      el.addEventListener("input", updateBuilderSummary);
      el.addEventListener("change", updateBuilderSummary);
    });

    bPhotoFile.addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f){
        currentBuilder.photoDataUrl="";
        bPhotoPreview.style.display="none";
        updateBuilderSummary();
        return;
      }
      try{
        // usa l‚Äôottimizzatore gi√† presente
        const dataUrl = await optimizeImageFile(f);
        currentBuilder.photoDataUrl = dataUrl;
        bPhotoPreview.src = dataUrl;
        bPhotoPreview.style.display = "block";
        updateBuilderSummary();
      }catch(err){
        console.error(err);
        alert("Errore nel caricamento foto.");
      }
    });

    function addRing(init){
      const id = uid();
      const ring = { id, diameter:(init?.diameter||""), color:(init?.color||""), weave:(init?.weave||""), decor:(init?.decor||"") };
      currentBuilder.rings.push(ring);

      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = id;
      el.innerHTML = `
        <div class="item-head">
          <b>üßø Cerchio</b>
          <div class="item-actions">
            <button class="btn danger mini" data-del type="button">Elimina</button>
          </div>
        </div>
        <div class="row2">
          <div><label>Diametro (cm)</label><input data-k="diameter" placeholder="Es: 30" /></div>
          <div><label>Colore cerchio</label><input data-k="color" placeholder="Es: bianco/nero/oro" /></div>
          <div><label>Intreccio</label><input data-k="weave" placeholder="Es: pizzo / classico" /></div>
          <div><label>Decorazioni</label><input data-k="decor" placeholder="Es: brillanti, perline, charm..." /></div>
        </div>
      `;
      bRingsList.appendChild(el);

      el.querySelectorAll("input").forEach(inp=>{
        inp.value = ring[inp.dataset.k] || "";
        inp.addEventListener("input", ()=>{
          ring[inp.dataset.k] = inp.value.trim();
          updateBuilderSummary();
        });
      });

      el.querySelector("[data-del]").onclick = () => {
        currentBuilder.rings = currentBuilder.rings.filter(r=>r.id!==id);
        el.remove();
        updateBuilderSummary();
      };

      updateBuilderSummary();
    }

    function addFeathersGroup(pos, init){
      const id = uid();
      const fg = { id, position: (init?.position || pos || "sinistra"), color:(init?.color||""), qty:(init?.qty||""), length:(init?.length||"") };
      currentBuilder.feathers.push(fg);

      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = id;
      el.innerHTML = `
        <div class="item-head">
          <b>ü™∂ Gruppo piume</b>
          <div class="item-actions">
            <button class="btn danger mini" data-del type="button">Elimina</button>
          </div>
        </div>
        <div class="row2">
          <div>
            <label>Posizione</label>
            <select data-k="position">
              <option ${fg.position==="sinistra"?"selected":""}>sinistra</option>
              <option ${fg.position==="centro"?"selected":""}>centro</option>
              <option ${fg.position==="destra"?"selected":""}>destra</option>
            </select>
          </div>
          <div><label>Colore</label><input data-k="color" placeholder="Es: rosso e nero" /></div>
          <div><label>Quantit√†</label><input data-k="qty" placeholder="Es: 3, 5, 7..." /></div>
          <div><label>Lunghezza</label><input data-k="length" placeholder="corta / media / lunga" /></div>
        </div>
      `;
      bFeathersList.appendChild(el);

      el.querySelectorAll("input,select").forEach(inp=>{
        if(inp.tagName==="INPUT") inp.value = fg[inp.dataset.k] || "";
        if(inp.tagName==="SELECT") inp.value = fg[inp.dataset.k] || inp.value;
        inp.addEventListener("input", ()=>{
          fg[inp.dataset.k] = inp.value.trim();
          updateBuilderSummary();
        });
        inp.addEventListener("change", ()=>{
          fg[inp.dataset.k] = inp.value.trim();
          updateBuilderSummary();
        });
      });

      el.querySelector("[data-del]").onclick = () => {
        currentBuilder.feathers = currentBuilder.feathers.filter(x=>x.id!==id);
        el.remove();
        updateBuilderSummary();
      };

      updateBuilderSummary();
    }

    function addAccessory(init){
      const id = uid();
      const acc = { id, type:(init?.type||"Perline"), color:(init?.color||""), details:(init?.details||""), qty:(init?.qty||"") };
      currentBuilder.accessories.push(acc);

      const el = document.createElement("div");
      el.className = "item";
      el.dataset.id = id;
      el.innerHTML = `
        <div class="item-head">
          <b>Accessorio</b>
          <div class="item-actions">
            <button class="btn danger mini" data-del type="button">Elimina</button>
          </div>
        </div>
        <div class="row2">
          <div>
            <label>Tipo</label>
            <select data-k="type">
              <option>Perline</option>
              <option>Brillanti</option>
              <option>Charm</option>
              <option>Simbolo</option>
              <option>Scritta</option>
              <option>Luci</option>
            </select>
          </div>
          <div><label>Colore</label><input data-k="color" placeholder="Es: oro / nero / rosso..." /></div>
          <div><label>Quantit√†</label><input data-k="qty" placeholder="Es: 5" /></div>
          <div><label>Dettagli</label><input data-k="details" placeholder="Es: emoji, perle rosse/nere..." /></div>
        </div>
      `;
      bAccList.appendChild(el);

      el.querySelectorAll("input,select").forEach(inp=>{
        if(inp.tagName==="INPUT") inp.value = acc[inp.dataset.k] || "";
        if(inp.tagName==="SELECT") inp.value = acc[inp.dataset.k] || inp.value;
        inp.addEventListener("input", ()=>{
          acc[inp.dataset.k] = inp.value.trim();
          updateBuilderSummary();
        });
        inp.addEventListener("change", ()=>{
          acc[inp.dataset.k] = inp.value.trim();
          updateBuilderSummary();
        });
      });

      el.querySelector("[data-del]").onclick = () => {
        currentBuilder.accessories = currentBuilder.accessories.filter(x=>x.id!==id);
        el.remove();
        updateBuilderSummary();
      };

      updateBuilderSummary();
    }

    function estimatePrice(project){
      project = project || currentBuilder;
      const P = loadPrices();
      let total = 0;
      total += Number(P.base_model || 0);

      total += (project.rings?.length || 0) * Number(P.ring_extra || 0);
      total += (project.feathers?.length || 0) * Number(P.feathers_group || 0);

      for(const a of (project.accessories || [])){
        const t = (a.type || "").toLowerCase();
        if(t.includes("perl")) total += Number(P.accessory_beads || 0);
        else if(t.includes("brill")) total += Number(P.accessory_glitter || 0);
        else if(t.includes("charm")) total += Number(P.accessory_charm || 0);
        else if(t.includes("simbol")) total += Number(P.accessory_symbol || 0);
        else if(t.includes("scritt")) total += Number(P.accessory_text || 0);
        else if(t.includes("luci")) total += Number(P.lights || 0);
      }

      if((bHasPhoto.value || "no") === "si") total += Number(P.photo || 0);
      return total;
    }

    function updateBuilderSummary(){
      if(!currentBuilder) return;

      currentBuilder.base.model = bModel.value;
      currentBuilder.base.diameter = bDiameter.value;
      currentBuilder.base.ringColor = bRingColor.value.trim();
      currentBuilder.base.featherColor = bFeatherColor.value.trim();

      currentBuilder.hasPhoto = bHasPhoto.value;
      currentBuilder.text = bText.value.trim();
      currentBuilder.notes = (bNotes.value || "").trim();

      const total = estimatePrice(currentBuilder);
      bEstimate.textContent = "Totale stimato: " + euro(total);

      const lines = [];
      lines.push(`<b>Modello:</b> ${escapeHtml(currentBuilder.base.model)}`);
      lines.push(`<b>Diametro:</b> ${escapeHtml(currentBuilder.base.diameter)} cm`);
      if(currentBuilder.base.ringColor) lines.push(`<b>Colore cerchio:</b> ${escapeHtml(currentBuilder.base.ringColor)}`);
      if(currentBuilder.base.featherColor) lines.push(`<b>Colore piume:</b> ${escapeHtml(currentBuilder.base.featherColor)}`);

      if((currentBuilder.rings||[]).length){
        lines.push(`<br><b>Cerchi:</b>`);
        currentBuilder.rings.forEach((r,i)=>{
          lines.push(`‚Ä¢ Cerchio ${i+1}: ${escapeHtml(r.diameter||"")} cm, ${escapeHtml(r.color||"")}, intreccio: ${escapeHtml(r.weave||"")}, decor: ${escapeHtml(r.decor||"")}`);
        });
      }

      if((currentBuilder.feathers||[]).length){
        lines.push(`<br><b>Piume:</b>`);
        currentBuilder.feathers.forEach((f,i)=>{
          lines.push(`‚Ä¢ Gruppo ${i+1}: ${escapeHtml(f.position||"")}, colore: ${escapeHtml(f.color||"")}, quantit√†: ${escapeHtml(f.qty||"")}, lunghezza: ${escapeHtml(f.length||"")}`);
        });
      }

      if((currentBuilder.accessories||[]).length){
        lines.push(`<br><b>Accessori:</b>`);
        currentBuilder.accessories.forEach((a,i)=>{
          lines.push(`‚Ä¢ ${i+1}) ${escapeHtml(a.type||"")} ‚Äî colore: ${escapeHtml(a.color||"")}, qty: ${escapeHtml(a.qty||"")}, dettagli: ${escapeHtml(a.details||"")}`);
        });
      }

      if((bHasPhoto.value||"no")==="si"){
        lines.push(`<br><b>Foto:</b> S√¨ (anteprima caricata) ‚Äî la invio in chat su WhatsApp dopo il messaggio.`);
      } else {
        lines.push(`<br><b>Foto:</b> No`);
      }

      if(currentBuilder.text) lines.push(`<br><b>Scritta:</b> ${escapeHtml(currentBuilder.text)}`);
      if(currentBuilder.notes) lines.push(`<br><b>Note:</b> ${escapeHtml(currentBuilder.notes)}`);

      bSummary.innerHTML = lines.join("<br>");
    }

    function buildWhatsAppBuilderMessage(project){
      const total = estimatePrice(project);
      const lines = [];
      lines.push("Ciao! Vorrei un acchiappasogni personalizzato con queste caratteristiche:");

      // Base
      lines.push(`‚Ä¢ Modello: ${project.base.model}`);
      lines.push(`‚Ä¢ Diametro: ${project.base.diameter} cm`);
      if(project.base.ringColor) lines.push(`‚Ä¢ Colore del cerchio principale: ${project.base.ringColor}`);
      if(project.base.featherColor) lines.push(`‚Ä¢ Colore delle piume principali: ${project.base.featherColor}`);

      // Cerchi
      if(project.rings?.length){
        lines.push("");
        lines.push("CERCHI AGGIUNTIVI:");
        project.rings.forEach((r,i)=>{
          const parts = [];
          if(r.diameter) parts.push(`${r.diameter} cm`);
          if(r.color) parts.push(`colore ${r.color}`);
          if(r.weave) parts.push(`intreccio ${r.weave}`);
          if(r.decor) parts.push(`decorazioni ${r.decor}`);
          lines.push(`- Cerchio ${i+1}: ${parts.join(", ") || "dettagli da definire"}`);
        });
      }

      // Piume
      if(project.feathers?.length){
        lines.push("");
        lines.push("PIUME:");
        project.feathers.forEach((f,i)=>{
          const parts = [];
          if(f.position) parts.push(`posizione ${f.position}`);
          if(f.color) parts.push(`colore ${f.color}`);
          if(f.qty) parts.push(`quantit√† ${f.qty}`);
          if(f.length) parts.push(`lunghezza ${f.length}`);
          lines.push(`- Gruppo piume ${i+1}: ${parts.join(", ") || "dettagli da definire"}`);
        });
      }

      // Accessori
      if(project.accessories?.length){
        lines.push("");
        lines.push("ACCESSORI:");
        project.accessories.forEach((a,i)=>{
          const parts = [];
          if(a.type) parts.push(a.type);
          if(a.color) parts.push(`colore ${a.color}`);
          if(a.qty) parts.push(`quantit√† ${a.qty}`);
          if(a.details) parts.push(`dettagli: ${a.details}`);
          lines.push(`- ${i+1}) ${parts.join(" ‚Äî ") || "dettagli da definire"}`);
        });
      }

      // Foto / Scritta / Note
      lines.push("");
      lines.push(`‚Ä¢ Foto: ${project.hasPhoto === "si" ? "S√¨ (allego la foto in chat dopo questo messaggio)" : "No"}`);
      if(project.text) lines.push(`‚Ä¢ Scritta: ${project.text}`);
      if(project.notes) lines.push(`‚Ä¢ Note extra: ${project.notes}`);

      lines.push("");
      lines.push(`Totale stimato: ${euro(total)} (da confermare)`);
      lines.push("Grazie!");

      return lines.join("\n");
    }

    function saveCurrentProject(){
      if(!currentBuilder) return null;

      const project = {
        ...currentBuilder,
        hasPhoto: bHasPhoto.value,
        photoDataUrl: currentBuilder.photoDataUrl || ""
      };

      const all = loadProjects();
      const idx = all.findIndex(p => p.id === project.id);
      if(idx >= 0) all[idx] = project;
      else all.push(project);
      saveProjects(all);
      return project;
    }

    function sendProject(project){
      const number = getWa();
      const msg = buildWhatsAppBuilderMessage(project);
      const url = `https://wa.me/${encodeURIComponent(number.replace(/\s+/g,""))}?text=${encodeURIComponent(msg)}`;
      window.open(url, "_blank");
    }

    document.getElementById("btnResumeProject").onclick = () => { resumeLastProject(); };

    document.getElementById("btnSaveProject").onclick = () => {
      const p = saveCurrentProject();
      if(!p) return;
      alert("Progetto salvato ‚úÖ");
    };

    document.getElementById("btnSendProject").onclick = () => {
      if(!currentBuilder) return;
      sendProject(currentBuilder);
    };

    document.getElementById("btnSaveAndSend").onclick = () => {
      const p = saveCurrentProject();
      if(!p) return;
      sendProject(p);
    };

  
    /* =========================
       BOMBONIERE & REGALI (CLIENTI) - LOGICA
       Separata dal catalogo: salva solo una bozza e genera messaggio WhatsApp.
       ========================= */
    const giftsBack = document.getElementById("giftsBack");
    const btnGifts = document.getElementById("btnGifts");
    const btnCloseGifts = document.getElementById("btnCloseGifts");

    const gType = document.getElementById("gType");
    const gOcc = document.getElementById("gOcc");
    const gName = document.getElementById("gName");
    const gDate = document.getElementById("gDate");
    const gColors = document.getElementById("gColors");
    const gDetails = document.getElementById("gDetails");
    const gSummary = document.getElementById("gSummary");
    const gCode = document.getElementById("gCode");

    const gReset = document.getElementById("gReset");
    const gSave = document.getElementById("gSave");
    const gSend = document.getElementById("gSend");
    const gSaveSend = document.getElementById("gSaveSend");
    const gPresets = document.getElementById("gPresets");

    const K_GIFTS = { drafts: "ae_gifts_drafts_v1" };
    let gift = null;

    function openGifts(){
      gift = {
        id: uid(),
        created_at: new Date().toISOString(),
        type: gType?.value || "9",
        occ: gOcc?.value || "‚Äî",
        name: "",
        date: "",
        colors: "",
        details: ""
      };
      gName.value = "";
      gDate.value = "";
      gColors.value = "";
      gDetails.value = "";
      renderGiftSummary();
      giftsBack.style.display = "flex";
    }
    function closeGifts(){ giftsBack.style.display = "none"; }

    function renderGiftSummary(){
      if(!gift) return;
      gift.type = gType.value;
      gift.occ = gOcc.value;
      gift.name = (gName.value||"").trim();
      gift.date = (gDate.value||"").trim();
      gift.colors = (gColors.value||"").trim();
      gift.details = (gDetails.value||"").trim();

      const tlabel = gType.options[gType.selectedIndex]?.text || gift.type;
      const code = "GE-" + new Date().getFullYear() + "-" + Math.random().toString(16).slice(2,8).toUpperCase();
      gift.code = gift.code || code;

      gCode.textContent = "Codice: " + gift.code;

      const lines = [];
      lines.push("<b>Categoria:</b> " + escapeHtml(tlabel));
      if(gift.occ && gift.occ !== "‚Äî") lines.push("<b>Occasione:</b> " + escapeHtml(gift.occ));
      if(gift.name) lines.push("<b>Nome/Scritta:</b> " + escapeHtml(gift.name));
      if(gift.date) lines.push("<b>Data:</b> " + escapeHtml(gift.date));
      if(gift.colors) lines.push("<b>Colori:</b> " + escapeHtml(gift.colors));
      if(gift.details) lines.push("<b>Dettagli:</b> " + escapeHtml(gift.details));

      gSummary.innerHTML = lines.join("<br/>") || "<span class='small'>Compila i campi per vedere il riepilogo.</span>";
    }

    function giftMessageForWhatsApp(){
      if(!gift) return "";
      const tlabel = gType.options[gType.selectedIndex]?.text || gift.type;
      const lines = [];
      lines.push("üéÅ *Bomboniere & Regali*");
      lines.push("Codice: " + (gift.code||"‚Äî"));
      lines.push("Categoria: " + tlabel);
      if(gift.occ && gift.occ !== "‚Äî") lines.push("Occasione: " + gift.occ);
      if(gift.name) lines.push("Nome/Scritta: " + gift.name);
      if(gift.date) lines.push("Data: " + gift.date);
      if(gift.colors) lines.push("Colori: " + gift.colors);
      if(gift.details) lines.push("Dettagli: " + gift.details);
      lines.push("");
      lines.push("Vorrei un preventivo e confermare disponibilit√† üòä");
      return lines.join("\n");
    }

    function saveGiftDraft(){
      const arr = (()=>{ try{ return JSON.parse(localStorage.getItem(K_GIFTS.drafts)||"[]"); }catch{ return []; } })();
      const clean = arr.filter(x=>x && x.id !== gift.id);
      clean.unshift(gift);
      localStorage.setItem(K_GIFTS.drafts, JSON.stringify(clean.slice(0,30)));
    }

    function sendGiftWhatsApp(){
      const msg = giftMessageForWhatsApp();
      const wa = getWa();
      const url = "https://wa.me/" + wa.replace(/[^0-9]/g,'') + "?text=" + encodeURIComponent(msg);
      window.open(url, "_blank");
    }

    [gType, gOcc, gName, gDate, gColors, gDetails].forEach(el=>{
      if(!el) return;
      el.addEventListener("input", renderGiftSummary);
      el.addEventListener("change", renderGiftSummary);
    });

    if(gPresets){
      gPresets.addEventListener("click", (e)=>{
        const b = e.target.closest("[data-gpreset]");
        if(!b) return;
        const id = b.getAttribute("data-gpreset");
        if(id === "confetti"){
          gDetails.value = "Confetti + bustina + bigliettino";
        }else if(id === "name"){
          gName.value = gName.value || "Nome";
          gDetails.value = "Scritta personalizzata frontale";
        }else if(id === "baby"){
          gOcc.value = "Nascita";
          gDetails.value = "Fiocco + data + nome";
        }else if(id === "event"){
          gOcc.value = "Evento";
          gDetails.value = "Tema personalizzato (colori, simboli, scritta)";
        }
        renderGiftSummary();
      });
    }

    if(btnGifts) btnGifts.onclick = openGifts;
    if(btnCloseGifts) btnCloseGifts.onclick = closeGifts;
    if(giftsBack) giftsBack.addEventListener("click", (e)=>{ if(e.target === giftsBack) closeGifts(); });

    if(gReset) gReset.onclick = ()=>{
      if(!confirm("Reset campi?")) return;
      gName.value=""; gDate.value=""; gColors.value=""; gDetails.value="";
      gift = null;
      openGifts();
    };
    if(gSave) gSave.onclick = ()=>{ if(!gift) return; renderGiftSummary(); saveGiftDraft(); alert("Salvato ‚úÖ"); };
    if(gSend) gSend.onclick = ()=>{ if(!gift) return; renderGiftSummary(); sendGiftWhatsApp(); };
    if(gSaveSend) gSaveSend.onclick = ()=>{ if(!gift) return; renderGiftSummary(); saveGiftDraft(); sendGiftWhatsApp(); };


</script>
  <script>
    if ("serviceWorker" in navigator) {
      // DISATTIVATO: il Service Worker causava pagina bianca su alcuni dispositivi (cache vecchia/rotta).
      // Se in futuro vuoi riattivarlo, rimetti la register().
      window.addEventListener("load", function () {
        navigator.serviceWorker.getRegistrations()
          .then(function (regs) { regs.forEach(function (r) { r.unregister(); }); })
          .catch(function (e) { console.log("SW unregister error:", e); });
      });
    }
  </script>
  <script>
  // Service Worker DISABILITATO temporaneamente (fix pagina bianca / cache)
  // Per riattivarlo, rimuovi questo blocco e ripristina il register originale.
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.getRegistrations().then((regs) => {
      regs.forEach((r) => r.unregister());
    });
    if (window.caches && caches.keys) {
      caches.keys().then((keys) => keys.forEach((k) => caches.delete(k)));
    }
  }
</script>
  <!-- html2canvas per condividere l‚Äôanteprima su WhatsApp -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
// Fullscreen toggle for Dreamcatcher builder
(function(){
  const back = document.getElementById('builderLiteBack');
  const btn = document.getElementById('dlFullscreen');
  const closeBtn = document.getElementById('btnCloseBuilderLite');
  if(!back || !btn) return;

  function isFs(){
    return document.fullscreenElement || document.webkitFullscreenElement;
  }
  async function enterFs(){
    const target = back.querySelector('.modal') || back;
    if(target.requestFullscreen){
      await target.requestFullscreen();
      return true;
    }
    if(target.webkitRequestFullscreen){
      target.webkitRequestFullscreen();
      return true;
    }
    // fallback CSS
    back.classList.add('fs-fallback');
    return false;
  }
  async function exitFs(){
    if(document.exitFullscreen){
      try{ await document.exitFullscreen(); } catch(e){}
    } else if(document.webkitExitFullscreen){
      try{ document.webkitExitFullscreen(); } catch(e){}
    }
    back.classList.remove('fs-fallback');
  }

  btn.addEventListener('click', async (e)=>{
    e.preventDefault();
    if(isFs() || back.classList.contains('fs-fallback')){
      await exitFs();
      btn.textContent = '‚õ∂ Schermo intero';
    } else {
      await enterFs();
      btn.textContent = 'üóó Esci';
    }
  });

  // Ensure we exit fullscreen when closing modal
  if(closeBtn){
    closeBtn.addEventListener('click', ()=>{ exitFs(); btn.textContent='‚õ∂ Schermo intero'; }, {capture:true});
  }
  back.addEventListener('click', (e)=>{
    // if tap outside modal closes, also exit
    if(e.target === back){ exitFs(); btn.textContent='‚õ∂ Schermo intero'; }
  });

  document.addEventListener('fullscreenchange', ()=>{
    if(!isFs()){ btn.textContent='‚õ∂ Schermo intero'; }
    else { btn.textContent='üóó Esci'; }
  });
})();

</script>
  <script>
(function(){
  function qs(sel, root){ return (root||document).querySelector(sel); }

  function setupBuilderBottomSheet(){
    const back = document.getElementById('builderLiteBack');
    if(!back) return;
    if(!back.classList.contains('studio-mode')) return;

    const grid = qs('.lite-grid', back);
    if(!grid) return;

    const boxes = grid.querySelectorAll(':scope > .box');
    if(boxes.length < 2) return;

    const stageBox = boxes[0];
    const sheetBox = boxes[1];

    // Applica classi una sola volta
    if(!sheetBox.classList.contains('studio-sheet')){
      sheetBox.classList.add('studio-sheet');

      // crea wrapper scroll interno (cos√¨ il box pu√≤ essere overflow hidden)
      const scroll = document.createElement('div');
      scroll.className = 'studio-sheet-scroll';
      while(sheetBox.firstChild){
        scroll.appendChild(sheetBox.firstChild);
      }
      // handle in cima (zona di trascinamento)
      const handle = document.createElement('div');
      handle.className = 'studio-sheet-handle';
      handle.setAttribute('aria-label','Trascina per ridimensionare');
      scroll.prepend(handle);

      sheetBox.appendChild(scroll);

      // altezza iniziale (piccolo, non copre lo stage)
      const isLand = window.matchMedia && window.matchMedia('(orientation: landscape)').matches;
      const initK = isLand ? 0.22 : 0.30;
      sheetBox.style.height = Math.round(window.innerHeight * initK) + 'px';
      sheetBox.style.maxHeight = Math.round(window.innerHeight * 0.75) + 'px';
      sheetBox.style.minHeight = Math.round(window.innerHeight * 0.16) + 'px';

      // aggiorna variabili CSS per lasciare visibile la pagina di lavoro
      function setSheetVars(){
        const h = sheetBox.getBoundingClientRect().height;
        document.documentElement.style.setProperty('--studioSheetH', Math.round(h) + 'px');
        updateStudioStageSize();
      }

      // calcola una dimensione "sicura" per lo stage (quadrato) in base allo spazio sopra al cassetto
      function updateStudioStageSize(){
        try{
          if(!builderLiteBack || !builderLiteBack.classList.contains('studio-mode')) return;
          const stage = document.getElementById('dlStage');
          if(!stage) return;

          const sheet = sheetBox; // √® gi√† il foglio
          const sheetTop = sheet.getBoundingClientRect().top;

          // spazio disponibile tra top stage e top del foglio (meno padding)
          const stageWrap = stage.parentElement;
          const wrapRect = stageWrap.getBoundingClientRect();
          const topSafe = 10 + (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--safeTop')) || 0);
          // spazio disponibile tra top stage e top del foglio (meno padding)
          const availH = Math.max(200, (sheetTop - wrapRect.top - 66 - topSafe));
          // larghezza disponibile dentro il box (meno padding)
          const availW = Math.max(200, wrapRect.width - 28);

          // margine extra per evitare qualsiasi clipping (bordi + padding + variazioni browser)
          const size = Math.max(200, Math.floor(Math.min(availH, availW) - 90));

          document.documentElement.style.setProperty('--studioStageSize', size + 'px');
        }catch(e){}
      }
      // inizializza
      setSheetVars();


      // drag per cambiare altezza (cassetto)
      let startY = 0;
      let startH = 0;
      handle.style.touchAction = 'none';

      handle.addEventListener('pointerdown', (e)=>{
        startY = e.clientY;
        startH = sheetBox.getBoundingClientRect().height;
        handle.setPointerCapture(e.pointerId);
        e.preventDefault();
      });

      handle.addEventListener('pointermove', (e)=>{
        if(!startY) return;
        const dy = startY - e.clientY; // su = aumenta altezza
        let newH = startH + dy;

        const minH = window.innerHeight * 0.16;
        const maxH = window.innerHeight * 0.75;

        newH = Math.max(minH, Math.min(maxH, newH));
        sheetBox.style.height = Math.round(newH) + 'px';
        setSheetVars();
        e.preventDefault();
      });

      function endDrag(){
        startY = 0;
      }
      handle.addEventListener('pointerup', endDrag);
      handle.addEventListener('pointercancel', endDrag);


      // tap sulla maniglia: alterna tra compatto e grande
      let sheetExpanded = false;
      handle.addEventListener('click', ()=>{
        const minH = window.innerHeight * 0.16;
        const maxH = window.innerHeight * 0.60;
        const target = sheetExpanded ? minH : maxH;
        sheetExpanded = !sheetExpanded;
        sheetBox.style.height = Math.round(target) + 'px';
        setSheetVars();
      });
    }

    // Ricalcola limiti su resize/orientamento
    function refreshSheetLimits(){
      if(!sheetBox.classList.contains('studio-sheet')) return;
      sheetBox.style.maxHeight = Math.round(window.innerHeight * 0.75) + 'px';
      sheetBox.style.minHeight = Math.round(window.innerHeight * 0.16) + 'px';
      // se troppo grande dopo resize, riduci
      const h = sheetBox.getBoundingClientRect().height;
      const maxH = window.innerHeight * 0.75;
      if(h > maxH) sheetBox.style.height = Math.round(maxH) + 'px';
      // aggiorna variabili e stage
      const hh = sheetBox.getBoundingClientRect().height;
      document.documentElement.style.setProperty('--studioSheetH', Math.round(hh) + 'px');
      try{ updateStudioStageSize(); }catch(e){}
    }
    window.addEventListener('resize', refreshSheetLimits, {passive:true});
    setSheetVars();
}

  // osserva cambi classi (quando apri/chiudi personalizza e scatta studio-mode)
  const obs = new MutationObserver(()=>{
    setupBuilderBottomSheet();
  });
  obs.observe(document.documentElement, {subtree:true, attributes:true, attributeFilter:['class']});
  // fallback: prova anche quando cambia il back
  const back = document.getElementById('builderLiteBack');
  if(back){
    obs.observe(back, {attributes:true, attributeFilter:['class']});
  }
  // primo giro
  setupBuilderBottomSheet();
})();

/* ===== Simulator bottom-sheet + tabs ===== */
let simActiveTab = "base";
function simSetup(){
  const back = document.getElementById("builderLiteBack");
  if(!back) return;

  const sheet = document.getElementById("simSheet");
  const handle = document.getElementById("simHandle");
    });

  // Colori rapidi (scrive nel campo "Colore cerchio" e trigghera l'update)
  sheet.querySelectorAll(".sim-quick-colors .qdot").forEach(dot=>{
    dot.addEventListener("click", ()=>{
      const v = dot.dataset.ring || "";
      const inp = document.getElementById("dlRingColor");
      if(inp){
        inp.value = v;
        inp.dispatchEvent(new Event("input", {bubbles:true}));
        inp.dispatchEvent(new Event("change", {bubbles:true}));
      }
    });
  });

  if(!sheet) return;

  // Tabs
  sheet.querySelectorAll(".sim-tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      simSetTab(btn.dataset.simtab || "base");
      // quando tocchi un tab, apri un po' il cassetto (ma non coprire lo stage)
      simSetSheetHeightVH(Math.max(42, simGetSheetVH()));
      simRecalcStage();
    });
  });

  // Drag handle: resize sheet
  if(handle && !handle.dataset.bound){
    handle.dataset.bound="1";
    let startY=0, startH=0, dragging=false;
    handle.addEventListener("pointerdown",(e)=>{
      dragging=true;
      startY=e.clientY;
      startH=sheet.getBoundingClientRect().height;
      handle.setPointerCapture(e.pointerId);
      e.preventDefault();
    });
    handle.addEventListener("pointermove",(e)=>{
      if(!dragging) return;
      const dy = startY - e.clientY; // su aumenta
      let newH = startH + dy;
      const minH = window.innerHeight*0.30;
      const maxH = window.innerHeight*0.82;
      newH = Math.max(minH, Math.min(maxH, newH));
      sheet.style.setProperty("--simSheetH", (newH/window.innerHeight*100).toFixed(1) + "vh");
      simRecalcStage();
      e.preventDefault();
    });
    const endDrag=()=>{ dragging=false; };
    handle.addEventListener("pointerup", endDrag);
    handle.addEventListener("pointercancel", endDrag);
    // Tap handle = toggle
    handle.addEventListener("click", ()=>{
      const vh = simGetSheetVH();
      simSetSheetHeightVH(vh > 60 ? 42 : 72);
      simRecalcStage();
    });
  }

  // Ensure correct initial
  simSetTab(simActiveTab);
  if(window.matchMedia("(max-width: 900px)").matches){
    simSetSheetHeightVH(42);
  }
  simRecalcStage();
}

function simSetTab(tab){
  simActiveTab = tab;
  const sheet=document.getElementById("simSheet");
  if(!sheet) return;
  sheet.querySelectorAll(".sim-tab").forEach(b=>b.classList.toggle("active",(b.dataset.simtab===tab)));
  sheet.querySelectorAll(".sim-panel").forEach(p=>p.classList.toggle("active",(p.dataset.simpanel===tab)));
}

function simGetSheetVH(){
  const sheet=document.getElementById("simSheet");
  if(!sheet) return 42;
  const v = getComputedStyle(sheet).getPropertyValue("--simSheetH").trim();
  if(v.endsWith("vh")) return parseFloat(v)||42;
  // fallback height
  return (sheet.getBoundingClientRect().height / window.innerHeight)*100;
}
function simSetSheetHeightVH(vh){
  const sheet=document.getElementById("simSheet");
  if(!sheet) return;
  sheet.style.setProperty("--simSheetH", Math.max(30, Math.min(82, vh)).toFixed(1) + "vh");
}

function simRecalcStage(){
  // calcola stage size in base allo spazio sopra il cassetto
  const stage = document.getElementById("dlStage");
  const leftBox = stage?.closest(".box");
  const sheet = document.getElementById("simSheet");
  if(!stage || !leftBox || !sheet) return;

  const isMobile = window.matchMedia("(max-width: 900px)").matches;
  if(!isMobile) return;

  const head = document.querySelector("#builderLiteBack .modal-head");
  const headH = head ? head.getBoundingClientRect().height : 0;

  const sheetH = sheet.getBoundingClientRect().height;
  // spazio disponibile: viewport - header - sheet - padding / margini
  const safe = 120; // margine sicurezza per bordi/padding/testi
  const avail = Math.max(180, window.innerHeight - headH - sheetH - safe);

  // stage √® quadrato: prendi anche vincolo in larghezza
  const maxW = Math.min(window.innerWidth - 40, 420);
  const size = Math.max(220, Math.min(avail, maxW));
  document.documentElement.style.setProperty("--studioStageSize", size.toFixed(0) + "px");
}

// aggiorna stage quando ruoti / ridimensioni
window.addEventListener("resize", ()=>{ simRecalcStage(); }, {passive:true});


  // Quickbar: tap color dots to fill inputs (keeps existing logic)
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-quick-target][data-quick-value]');
    if(!btn) return;
    const targetId = btn.getAttribute('data-quick-target');
    const value = btn.getAttribute('data-quick-value');
    const el = document.getElementById(targetId);
    if(!el) return;
    el.value = value;
    // Trigger both input & change to be safe
    el.dispatchEvent(new Event('input', {bubbles:true}));
    el.dispatchEvent(new Event('change', {bubbles:true}));
  });
</script>
  <!-- Color picker overlay (for selected accessory) -->
  <div id="dlColorOverlay" class="dl-color-overlay" style="display:none" aria-hidden="true">
   <div class="dl-color-card">
    <div class="dl-color-title">Scegli un colore</div>
    <div id="dlColorSwatches" class="dl-color-swatches"></div>
    <div class="dl-color-actions">
     <button class="btn" id="dlColorClose">Chiudi</button>
    </div>
   </div>
  </div>
  <script>
/* ===== Accessori: catalogo + colori (configuratore) ===== */
(function(){
  const catsEl = () => document.getElementById('accCats');
  const gridEl = () => document.getElementById('accGrid');
  const popEl  = () => document.getElementById('accColorPop');
  const swEl   = () => document.getElementById('accColorSwatch');
  const colorBtn = () => document.getElementById('accColorBtn');
  const closeBtn = () => document.getElementById('accColorCloseBtn');
  const frontBtn = () => document.getElementById('accBringFrontBtn');

  // Palette colori (cristalli / piume / metallo)
  const PALETTES = {
    crystal: [
      {id:'clear',  name:'Trasparente',  hex:'#eaf6ff'},
      {id:'pink',   name:'Rosa',         hex:'#ff4fa3'},
      {id:'purple', name:'Viola',        hex:'#8b5cf6'},
      {id:'blue',   name:'Blu',          hex:'#3b82f6'},
      {id:'cyan',   name:'Azzurro',      hex:'#22d3ee'},
      {id:'green',  name:'Verde',        hex:'#22c55e'},
      {id:'yellow', name:'Giallo',       hex:'#facc15'},
      {id:'red',    name:'Rosso',        hex:'#ef4444'},
      {id:'amber',  name:'Ambra',        hex:'#f59e0b'},
      {id:'smoke',  name:'Fum√®',         hex:'#94a3b8'},
      {id:'black',  name:'Nero',         hex:'#111827'},
      {id:'white',  name:'Bianco',       hex:'#ffffff'}
    ],
    metal: [
      {id:'silver', name:'Argento', hex:'#d6dde7'},
      {id:'gold',   name:'Oro',     hex:'#f5c542'},
      {id:'rose',   name:'Oro rosa',hex:'#f0a5a5'},
      {id:'black',  name:'Nero',    hex:'#111827'}
    ],
    feather: [
      {id:'white',  name:'Bianco',  hex:'#ffffff'},
      {id:'black',  name:'Nero',    hex:'#0b1220'},
      {id:'pink',   name:'Rosa',    hex:'#ff4fa3'},
      {id:'purple', name:'Viola',   hex:'#8b5cf6'},
      {id:'blue',   name:'Blu',     hex:'#3b82f6'},
      {id:'green',  name:'Verde',   hex:'#22c55e'},
      {id:'yellow', name:'Giallo',  hex:'#facc15'},
      {id:'rain',   name:'Arcobaleno', hex:'#ffffff'} // gestito come gradiente
    ]
  };

  // Catalogo accessori (icone SVG inline -> leggerezza, niente asset esterni)
  const CATALOG = [
    {cat:'Cristalli', type:'crystal', id:'cr_heart',   label:'Cuore',      shape:'heart'},
    {cat:'Cristalli', type:'crystal', id:'cr_drop',    label:'Goccia',     shape:'drop'},
    {cat:'Cristalli', type:'crystal', id:'cr_oval',    label:'Ovale',      shape:'oval'},
    {cat:'Cristalli', type:'crystal', id:'cr_round',   label:'Tondo',      shape:'round'},
    {cat:'Cristalli', type:'crystal', id:'cr_bicone',  label:'Bicono',     shape:'bicone'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_moon',    label:'Luna',       shape:'moon'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_star',    label:'Stella',     shape:'star'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_sun',     label:'Sole',       shape:'sun'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_rose',    label:'Rosa',       shape:'rose'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_bfly',    label:'Farfalla',   shape:'butterfly'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_dragon',  label:'Libellula',  shape:'dragonfly'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_seah',    label:'Cavalluccio',shape:'seahorse'},
    {cat:'Ciondoli',  type:'metal',   id:'ch_turtle',  label:'Tartaruga',  shape:'turtle'},
    {cat:'Anelli',    type:'metal',   id:'rg_circle',  label:'Anello',     shape:'ring'},
    {cat:'Anelli',    type:'metal',   id:'rg_hex',     label:'Esagono',    shape:'hex'},
    {cat:'Anelli',    type:'metal',   id:'rg_square',  label:'Quadrato',   shape:'square'},
    {cat:'Perle',     type:'crystal', id:'bd_small',   label:'Perla piccola',shape:'bead'},
    {cat:'Perle',     type:'crystal', id:'bd_big',     label:'Perla grande', shape:'bead2'},
    {cat:'Piume',     type:'feather', id:'ft_small',   label:'Piuma',      shape:'feather'},
    {cat:'Piume',     type:'feather', id:'ft_long',    label:'Piuma lunga',shape:'feather2'},
    {cat:'Dettagli',  type:'metal',   id:'st_chain',   label:'Catena',     shape:'chain'},
    {cat:'Dettagli',  type:'metal',   id:'st_bow',     label:'Fiocco',     shape:'bow'},
    {cat:'Dettagli',  type:'metal',   id:'st_snow',    label:'Fiocco neve',shape:'snow'},
    {cat:'Dettagli',  type:'metal',   id:'st_spark',   label:'Brill.',     shape:'spark'},
    {cat:'Dettagli',  type:'metal',   id:'st_letter',  label:'Lettera',    shape:'letter'}
  ];

  const CAT_ORDER = ['Cristalli','Ciondoli','Perle','Piume','Anelli','Dettagli'];

  function svgIcon(item, colorHex){
    const c = colorHex || '#eaf6ff';
    const stroke = 'rgba(255,255,255,.85)';
    // piccoli SVG stilizzati (non realistici, ma utili per configurare)
    switch(item.shape){
      case 'heart': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M32 54s-20-12.5-24-25.5C5 19 11 12 20 12c5 0 9 3 12 7 3-4 7-7 12-7 9 0 15 7 12 16.5C52 41.5 32 54 32 54z" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'drop': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M32 6C24 18 14 28 14 40a18 18 0 0 0 36 0c0-12-10-22-18-34z" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'oval': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <ellipse cx="32" cy="32" rx="18" ry="24" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'round': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <circle cx="32" cy="32" r="20" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'bicone': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M32 8L46 28 32 56 18 28 32 8z" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'moon': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M40 8a22 22 0 1 0 16 40A18 18 0 1 1 40 8z" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'star': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M32 6l7 18 19 2-14 12 4 20-16-10-16 10 4-20-14-12 19-2 7-18z" fill="${c}" stroke="${stroke}" stroke-width="2" opacity="0.95"/>
      </svg>`;
      case 'sun': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <circle cx="32" cy="32" r="12" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <g stroke="${stroke}" stroke-width="2">
          <line x1="32" y1="6" x2="32" y2="16"/><line x1="32" y1="48" x2="32" y2="58"/>
          <line x1="6" y1="32" x2="16" y2="32"/><line x1="48" y1="32" x2="58" y2="32"/>
          <line x1="12" y1="12" x2="19" y2="19"/><line x1="45" y1="45" x2="52" y2="52"/>
          <line x1="12" y1="52" x2="19" y2="45"/><line x1="45" y1="19" x2="52" y2="12"/>
        </g>
      </svg>`;
      case 'rose': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M32 14c8-6 18 2 12 10 6 2 8 12-2 14 4 8-6 14-12 8-6 6-16 0-12-8-10-2-8-12-2-14-6-8 4-16 12-10z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
      </svg>`;
      case 'butterfly': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M30 30c-8-16-22-16-22-2 0 12 12 18 22 8z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <path d="M34 30c8-16 22-16 22-2 0 12-12 18-22 8z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <path d="M32 22v20" stroke="${stroke}" stroke-width="3"/>
      </svg>`;
      case 'dragonfly': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <ellipse cx="20" cy="24" rx="14" ry="8" fill="${c}" opacity=".9"/><ellipse cx="44" cy="24" rx="14" ry="8" fill="${c}" opacity=".9"/>
        <ellipse cx="20" cy="40" rx="12" ry="7" fill="${c}" opacity=".7"/><ellipse cx="44" cy="40" rx="12" ry="7" fill="${c}" opacity=".7"/>
        <rect x="29" y="14" width="6" height="36" rx="3" fill="${stroke}"/>
      </svg>`;
      case 'seahorse': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M40 10c-6 0-10 4-10 10 0 5 3 8 3 10 0 4-5 4-5 10 0 7 6 12 14 12 6 0 10-3 10-8 0-3-2-5-5-6 2-1 4-3 4-6 0-4-4-6-7-6 2-2 3-4 3-7 0-5-4-9-7-9z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
      </svg>`;
      case 'turtle': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <ellipse cx="32" cy="34" rx="18" ry="14" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <circle cx="50" cy="34" r="5" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <g stroke="${stroke}" stroke-width="2">
          <line x1="18" y1="22" x2="12" y2="18"/><line x1="18" y1="46" x2="12" y2="50"/>
          <line x1="30" y1="20" x2="28" y2="12"/><line x1="30" y1="48" x2="28" y2="56"/>
        </g>
      </svg>`;
      case 'ring': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <circle cx="32" cy="32" r="18" fill="none" stroke="${c}" stroke-width="6" />
      </svg>`;
      case 'hex': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M20 14h24l12 18-12 18H20L8 32 20 14z" fill="none" stroke="${c}" stroke-width="6"/>
      </svg>`;
      case 'square': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <rect x="16" y="16" width="32" height="32" fill="none" stroke="${c}" stroke-width="6" rx="6"/>
      </svg>`;
      case 'bead': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <circle cx="32" cy="32" r="14" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <circle cx="32" cy="32" r="4" fill="rgba(0,0,0,.25)"/>
      </svg>`;
      case 'bead2': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <circle cx="32" cy="32" r="18" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <circle cx="32" cy="32" r="5" fill="rgba(0,0,0,.25)"/>
      </svg>`;
      case 'feather': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M46 10C30 12 14 30 16 46c2 10 12 10 18 2 6-8 8-20 12-38z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <path d="M22 44c8-8 16-14 24-20" stroke="rgba(255,255,255,.6)" stroke-width="2"/>
      </svg>`;
      case 'feather2': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M48 8C28 14 10 34 14 52c3 12 14 12 22 2 10-12 10-26 12-46z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <path d="M22 50c10-10 18-16 26-24" stroke="rgba(255,255,255,.6)" stroke-width="2"/>
      </svg>`;
      case 'chain': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M22 26c0-6 4-10 10-10h8" stroke="${c}" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M42 38c0 6-4 10-10 10h-8" stroke="${c}" stroke-width="6" fill="none" stroke-linecap="round"/>
        <path d="M26 38l12-12" stroke="${c}" stroke-width="6" fill="none" stroke-linecap="round"/>
      </svg>`;
      case 'bow': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M14 26c10 0 12 10 18 10s8-10 18-10c4 0 8 3 8 6 0 8-12 14-26 14S6 40 6 32c0-3 4-6 8-6z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
        <circle cx="32" cy="34" r="4" fill="rgba(0,0,0,.25)"/>
      </svg>`;
      case 'snow': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <g stroke="${c}" stroke-width="4" stroke-linecap="round">
          <line x1="32" y1="10" x2="32" y2="54"/>
          <line x1="10" y1="32" x2="54" y2="32"/>
          <line x1="16" y1="16" x2="48" y2="48"/>
          <line x1="48" y1="16" x2="16" y2="48"/>
        </g>
      </svg>`;
      case 'spark': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <path d="M32 6l6 18 18 6-18 6-6 18-6-18-18-6 18-6 6-18z" fill="${c}" stroke="${stroke}" stroke-width="2"/>
      </svg>`;
      case 'letter': return `<svg viewBox="0 0 64 64" width="42" height="42">
        <rect x="14" y="14" width="36" height="36" rx="10" fill="none" stroke="${c}" stroke-width="6"/>
        <path d="M24 42l8-20 8 20M28 34h8" stroke="${c}" stroke-width="4" fill="none" stroke-linecap="round"/>
      </svg>`;
      default: return `<svg viewBox="0 0 64 64" width="42" height="42"><circle cx="32" cy="32" r="18" fill="${c}"/></svg>`;
    }
  }

  function uniqueCats(){
    const set = new Set(CATALOG.map(x=>x.cat));
    const arr = Array.from(set);
    arr.sort((a,b)=>CAT_ORDER.indexOf(a)-CAT_ORDER.indexOf(b));
    return arr;
  }

  function renderCats(active){
    const el = catsEl(); if(!el) return;
    const cats = uniqueCats();
    el.innerHTML = '';
    cats.forEach(cat=>{
      const b=document.createElement('button');
      b.type='button';
      b.textContent=cat;
      b.className = (cat===active?'active':'');
      b.addEventListener('click', ()=>{ renderCats(cat); renderGrid(cat); });
      el.appendChild(b);
    });
  }

  function renderGrid(cat){
    const el = gridEl(); if(!el) return;
    const list = CATALOG.filter(x=>x.cat===cat);
    el.innerHTML = '';
    list.forEach(item=>{
      const tile=document.createElement('div');
      tile.className='acc-tile';
      tile.setAttribute('role','button');
      tile.setAttribute('tabindex','0');
      const defaultColor = (PALETTES[item.type]||PALETTES.crystal)[0].hex;
      tile.innerHTML = `<div class="ico">${svgIcon(item, defaultColor)}</div><div class="lbl">${item.label}</div>`;
      tile.addEventListener('click', ()=> addAccessoryToStage(item, defaultColor));
      el.appendChild(tile);
    });
  }

  // Integrazione con configuratore esistente:
  // - stage: #dlStage (contenitore) e layer elementi: #dlLayer
  // - selezione: window.__dlSelectedEl
  function getStage(){
    return document.getElementById('dlStage') || document.querySelector('.dl-stage') || document.querySelector('[data-dl-stage]');
  }
  function getLayer(){
    return document.getElementById('dlLayer') || document.querySelector('.dl-layer') || getStage();
  }

  function addAccessoryToStage(item, colorHex){
    const layer = getLayer(); if(!layer) return;
    const el=document.createElement('div');
    el.className='dl-item';
    el.dataset.accId=item.id;
    el.dataset.accType=item.type;
    el.dataset.accColor=colorHex;
    el.style.position='absolute';
    el.style.left='50%';
    el.style.top='50%';
    el.style.transform='translate(-50%, -50%) scale(1)';
    el.style.width='64px';
    el.style.height='64px';
    el.style.touchAction='none';
    el.innerHTML = `<div class="dl-item-ico">${svgIcon(item, colorHex)}</div>`;
    layer.appendChild(el);

    // drag + pinch per-element (semplice e robusto)
    makeDraggableAndPinchable(el);
    selectItem(el);

    // se esiste la funzione originale, notifichiamo anche lei (non rompe nulla)
    if(typeof window.dlOnAccessoryAdded === 'function'){
      try{ window.dlOnAccessoryAdded(item.id); }catch(e){}
    }
  }

  function selectItem(el){
    window.__dlSelectedEl = el;
    // highlight semplice
    document.querySelectorAll('.dl-item').forEach(x=>x.style.outline='none');
    if(el) el.style.outline='2px solid rgba(170,180,255,.85)';
  }

  function bringFrontSelected(){
    const el = window.__dlSelectedEl;
    if(!el || !el.parentElement) return;
    el.parentElement.appendChild(el);
  }

  function showColorPicker(){
    const el = window.__dlSelectedEl;
    const pop = popEl(); const sw = swEl();
    if(!pop || !sw) return;
    if(!el){ pop.classList.add('show'); pop.querySelector('h4').textContent='Seleziona un elemento prima'; sw.innerHTML=''; return; }
    const type = el.dataset.accType || 'crystal';
    const palette = PALETTES[type] || PALETTES.crystal;
    pop.querySelector('h4').textContent = 'Colore accessorio';
    sw.innerHTML = '';
    const current = el.dataset.accColor || palette[0].hex;
    palette.forEach(p=>{
      const b=document.createElement('button');
      b.type='button';
      b.title=p.name;
      b.style.background = (p.id==='rain') ? 'linear-gradient(90deg,#ef4444,#f59e0b,#facc15,#22c55e,#3b82f6,#8b5cf6,#ec4899)' : p.hex;
      if(current===p.hex) b.classList.add('active');
      b.addEventListener('click', ()=>{
        applyColor(el, type, p);
        sw.querySelectorAll('button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
      });
      sw.appendChild(b);
    });
    pop.classList.add('show');
    pop.setAttribute('aria-hidden','false');
  }

  function hideColorPicker(){
    const pop = popEl();
    if(!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden','true');
  }

  function applyColor(el, type, p){
    // aggiorna SVG con nuovo colore (semplice)
    const item = CATALOG.find(x=>x.id===el.dataset.accId) || {shape:'round'};
    const hex = (p.id==='rain') ? '#ffffff' : p.hex;
    el.dataset.accColor = hex;
    // rainbow: aggiungiamo un filtro gradiente via CSS
    const ico = el.querySelector('.dl-item-ico');
    if(ico){
      ico.innerHTML = svgIcon(item, hex);
      if(p.id==='rain'){
        ico.style.filter = 'hue-rotate(0deg) saturate(1.4)';
      }else{
        ico.style.filter = '';
      }
    }
  }

  function makeDraggableAndPinchable(target){
    let pointers = new Map();
    let start = null;

    function getDist(a,b){
      const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
      return Math.hypot(dx,dy);
    }

    function getScaleFromTransform(el){
      const tr = el.style.transform || '';
      const m = tr.match(/scale\(([^)]+)\)/);
      return m ? parseFloat(m[1]) : 1;
    }
    function setScale(el, s){
      const tr = el.style.transform || 'translate(-50%, -50%) scale(1)';
      const tr2 = tr.replace(/scale\([^)]+\)/, `scale(${s})`);
      el.style.transform = tr2;
    }

    target.addEventListener('pointerdown', (e)=>{
      target.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, {clientX:e.clientX, clientY:e.clientY});
      selectItem(target);

      if(pointers.size===1){
        const rect = target.getBoundingClientRect();
        start = {
          left: target.style.left,
          top: target.style.top,
          x: e.clientX,
          y: e.clientY,
          rect,
          scale: getScaleFromTransform(target)
        };
      } else if(pointers.size===2){
        const [p1,p2] = Array.from(pointers.values());
        start = {
          left: target.style.left,
          top: target.style.top,
          x: (p1.clientX+p2.clientX)/2,
          y: (p1.clientY+p2.clientY)/2,
          dist: getDist(p1,p2),
          scale: getScaleFromTransform(target)
        };
      }
    });

    target.addEventListener('pointermove', (e)=>{
      if(!pointers.has(e.pointerId) || !start) return;
      pointers.set(e.pointerId, {clientX:e.clientX, clientY:e.clientY});

      if(pointers.size===1){
        const dx = e.clientX - start.x;
        const dy = e.clientY - start.y;

        // Convertiamo px in % rispetto al layer
        const layer = getLayer();
        const lr = layer.getBoundingClientRect();
        const leftPct = (( (lr.width/2) + dx ) / lr.width) * 100;
        const topPct  = (( (lr.height/2) + dy ) / lr.height) * 100;

        target.style.left = leftPct.toFixed(3) + '%';
        target.style.top  = topPct.toFixed(3) + '%';
      }

      if(pointers.size===2){
        const [p1,p2] = Array.from(pointers.values());
        const dist = getDist(p1,p2);
        let s = start.scale * (dist / start.dist);
        s = Math.max(0.35, Math.min(2.8, s));
        setScale(target, s);
      }
    });

    function endPointer(e){
      pointers.delete(e.pointerId);
      if(pointers.size===0){ start=null; }
    }
    target.addEventListener('pointerup', endPointer);
    target.addEventListener('pointercancel', endPointer);
  }

  function wireSelectionOnLayer(){
    const layer = getLayer();
    if(!layer) return;
    layer.addEventListener('click', (e)=>{
      const el = e.target.closest('.dl-item');
      if(el) selectItem(el);
    }, true);
  }

  function init(){
    // Render iniziale
    const cats = uniqueCats();
    const active = cats[0] || 'Cristalli';
    renderCats(active);
    renderGrid(active);

    wireSelectionOnLayer();

    // Bottoni
    const cb = colorBtn(); if(cb) cb.addEventListener('click', showColorPicker);
    const cl = closeBtn(); if(cl) cl.addEventListener('click', hideColorPicker);
    const fb = frontBtn(); if(fb) fb.addEventListener('click', bringFrontSelected);

    // Chiudi pop se tocchi fuori
    document.addEventListener('click', (e)=>{
      const pop = popEl();
      if(!pop || !pop.classList.contains('show')) return;
      if(e.target.closest('#accColorPop') || e.target.closest('#accColorBtn')) return;
      // non chiudere se si clicca su un elemento della palette
      if(e.target.closest('.color-swatch')) return;
      // chiudi solo se click in area configuratore
      hideColorPicker();
    }, true);
  }

  // Avvio quando DOM pronto
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();
})();
</script>
 </body>
</html>
