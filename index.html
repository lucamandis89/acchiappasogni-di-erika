<!doctype html>
<html lang="it">
 <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Configuratore Acchiappasogni</title>
  <style>
  :root{
    --bg:#ffffff;
    --ink:#111827;
    --muted:#6b7280;
    --line:#e5e7eb;
    --card:#f9fafb;
    --accent:#2563eb;
    --accent2:#7c3aed;
    --shadow:0 10px 30px rgba(0,0,0,.12);
    --radius:18px;
    --toolbarH:64px;
    --panelH:220px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    background:var(--bg);
    color:var(--ink);
    overscroll-behavior:none;
    -webkit-tap-highlight-color: transparent;
  }

  /* Top bar */
  .topbar{
    position:sticky; top:0; z-index:50;
    background:rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-bottom:1px solid var(--line);
    padding:14px 14px calc(14px + env(safe-area-inset-top));
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .topbar h1{
    margin:0; font-size:18px; line-height:1.15; font-weight:750;
    letter-spacing:.2px;
  }
  .btn{
    border:1px solid var(--line);
    background:linear-gradient(#fff,#f3f4f6);
    color:var(--ink);
    padding:10px 14px;
    border-radius:999px;
    font-weight:650;
    box-shadow: 0 1px 0 rgba(0,0,0,.03);
  }
  .btn:active{transform: translateY(1px)}
  .btn.primary{
    border-color:transparent;
    background:linear-gradient(180deg,#2563eb,#1d4ed8);
    color:white;
  }
  .btn.danger{
    background:linear-gradient(180deg,#fff,#fef2f2);
    border-color:#fecaca;
    color:#991b1b;
  }

  /* Layout */
  .wrap{
    max-width: 1024px;
    margin:0 auto;
    padding:14px;
  }
  .grid{
    display:grid;
    grid-template-columns: 1fr;
    gap:14px;
  }
  @media (min-width: 900px){
    .grid{ grid-template-columns: 1.2fr .8fr; align-items:start; }
  }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .cardHead{
    padding:12px 14px;
    border-bottom:1px solid var(--line);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .cardHead .title{
    font-size:14px; font-weight:800; color:var(--ink);
  }
  .hint{font-size:12px; color:var(--muted);}

  /* Stage */
  .stageWrap{
    position:relative;
    height: min(62vh, 560px);
    background:#ffffff;
    overflow:hidden;
    touch-action:none; /* we manage gestures */
  }
  @media (max-width: 420px){
    .stageWrap{ height: 58vh; }
  }
  canvas#stage{
    display:block;
    width:100%;
    height:100%;
    background:#ffffff;
  }
  .floatingTools{
    position:absolute;
    left:12px; top:12px;
    display:flex; flex-direction:column; gap:10px;
    z-index:10;
    pointer-events:none;
  }
  .toolRow{display:flex; gap:10px; pointer-events:auto}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px;
    border-radius:14px;
    background:rgba(255,255,255,.92);
    border:1px solid var(--line);
    box-shadow:0 10px 25px rgba(0,0,0,.10);
    font-weight:750;
    color:var(--ink);
    user-select:none;
  }
  .chip small{font-weight:700; color:var(--muted)}
  .chip:active{transform: translateY(1px)}
  .chip svg{width:18px;height:18px}

  /* Bottom panel */
  .bottom{
    position: fixed;
    left:0; right:0; bottom:0;
    z-index:60;
    pointer-events:auto;
  }
  .panel{
    max-width:1024px;
    margin:0 auto;
    padding: 10px 14px calc(10px + env(safe-area-inset-bottom));
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-top:1px solid var(--line);
    box-shadow: 0 -16px 40px rgba(0,0,0,.12);
  }
  .tabs{
    display:flex; gap:8px;
    padding-bottom:10px;
  }
  .tab{
    flex:1;
    border:1px solid var(--line);
    background:linear-gradient(#fff,#f3f4f6);
    border-radius:14px;
    padding:10px 8px;
    font-weight:800;
    text-align:center;
    user-select:none;
  }
  .tab.active{
    border-color: rgba(37,99,235,.35);
    background:linear-gradient(180deg, rgba(37,99,235,.14), rgba(124,58,237,.10));
    box-shadow: 0 6px 16px rgba(37,99,235,.12);
  }
  .tab:active{transform: translateY(1px)}
  .tabContent{
    display:none;
    max-height: var(--panelH);
    overflow:auto;
    padding-bottom: 6px;
  }
  .tabContent.active{display:block}
  .row{
    display:flex; gap:10px; flex-wrap:wrap; align-items:center;
  }
  .field{
    flex:1;
    min-width: 140px;
    display:flex; flex-direction:column; gap:6px;
    padding:10px;
    border:1px solid var(--line);
    background:#fff;
    border-radius:14px;
  }
  .field label{font-size:12px; color:var(--muted); font-weight:800}
  .field input, .field select{
    border:1px solid var(--line);
    border-radius:12px;
    padding:10px 10px;
    font-size:14px;
    outline:none;
    background:#fff;
  }
  .field input:focus, .field select:focus{border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 4px rgba(37,99,235,.12)}
  .palette{
    display:flex; gap:8px; flex-wrap:wrap;
  }
  .swatch{
    width:28px; height:28px; border-radius:999px;
    border:2px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,.18);
    outline: 1px solid rgba(0,0,0,.10);
  }
  .swatch.active{ outline:2px solid var(--accent2); transform: scale(1.05); }
  .swatch:active{transform: scale(.98)}
  .subTitle{font-size:13px;font-weight:900;margin:10px 0 6px}
  .tiny{font-size:12px;color:var(--muted)}
  .list{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .item{
    width:84px;
    border:1px solid var(--line);
    background:#fff;
    border-radius:16px;
    padding:8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:6px;
    user-select:none;
  }
  .item .icon{
    width:54px; height:54px;
    border-radius:14px;
    display:grid; place-items:center;
    border:1px solid var(--line);
    background: linear-gradient(180deg,#fff,#f3f4f6);
    font-size:26px;
  }
  .item .name{font-size:11px; font-weight:900; color:var(--ink); text-align:center}
  .item:active{transform: translateY(1px)}
  .actions{
    display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;
  }
  /* Make sure stage is not covered by bottom panel */
  .spacer{
    height: calc(var(--panelH) + var(--toolbarH) + 20px);
  }
  @media (min-width: 900px){
    :root{ --panelH: 260px; }
    .spacer{ height: 20px; } /* desktop doesn't need spacer much */
    .bottom{ position: sticky; bottom:auto; top: calc(64px + 14px); }
    .panel{ border-radius: var(--radius); border:1px solid var(--line); box-shadow: var(--shadow); }
  }
</style>
 </head>
 <body>
  <div class="topbar">
   <h1>Personalizza il tuo
    <br>
    Acchiappasogni</h1>
   <button class="btn" id="closeBtn" type="button">‚úï Chiudi</button>
  </div>
  <div class="wrap">
   <div class="grid">
    <div class="card">
     <div class="cardHead">
      <div>
       <div class="title">Anteprima (trascina gli accessori)</div>
       <div class="hint">Pinch per zoom ‚Ä¢ Trascina per spostare ‚Ä¢ Tocca per selezionare</div>
      </div>
      <div class="hint" id="zoomLabel">100%</div>
     </div>
     <div class="stageWrap" id="stageWrap">
      <canvas id="stage"></canvas>
      <div class="floatingTools">
       <div class="toolRow">
        <button class="chip" id="resetBtn" type="button" title="Reset">‚Ü∫ <small>Reset</small></button>
        <button class="chip danger" id="deleteBtn" type="button" title="Rimuovi selezionato">üóëÔ∏è <small>Rimuovi</small></button>
       </div>
       <div class="toolRow">
        <button class="chip" id="fitBtn" type="button" title="Adatta">‚§¢ <small>Adatta</small></button>
        <button class="chip" id="deselectBtn" type="button" title="Deseleziona">‚úã <small>Deseleziona</small></button>
       </div>
      </div>
     </div>
    </div>
    <div class="card" id="sideCard">
     <div class="cardHead">
      <div class="title">Scelte rapide</div>
      <div class="hint">Compila e invia su WhatsApp</div>
     </div>
     <div style="padding:14px">
      <div class="row">
       <div class="field">
        <label>Diametro (cm)</label> <select id="diametro"> <option>20</option><option selected>30</option><option>40</option><option>50</option> </select>
       </div>
       <div class="field">
        <label>Modello</label> <select id="modello"> <option selected>1 ‚Ä¢ Classico</option> <option>2 ‚Ä¢ Doppio cerchio</option> <option>3 ‚Ä¢ Con gocce</option> </select>
       </div>
      </div>
      <div class="subTitle">Colore cerchio</div>
      <div class="palette" id="ringPalette"></div>
      <div class="subTitle">Colore piume</div>
      <div class="palette" id="featherPalette"></div>
      <div class="subTitle">Note (opzionale)</div>
      <div class="field" style="min-width:100%">
       <label>Testo libero</label> <input id="note" placeholder="Es: nome, colori preferiti, stile, ecc.">
      </div>
      <div class="actions">
       <button class="btn primary" id="sendBtn" type="button">Invia su WhatsApp</button>
       <button class="btn" id="copyBtn" type="button">Copia riepilogo</button>
      </div>
      <div class="tiny" style="margin-top:8px">Suggerimento: dopo aver finito, invia il riepilogo e (se vuoi) uno screenshot del progetto.</div>
     </div>
    </div>
   </div>
   <div class="spacer"></div>
  </div>
  <!-- Mobile bottom tabs -->
  <div class="bottom" id="bottom">
   <div class="panel">
    <div class="tabs" role="tablist" aria-label="Sezioni">
     <div class="tab active" data-tab="base" role="tab" tabindex="0">Base</div>
     <div class="tab" data-tab="accessori" role="tab" tabindex="0">Accessori</div>
     <div class="tab" data-tab="testo" role="tab" tabindex="0">Testo</div>
     <div class="tab" data-tab="invio" role="tab" tabindex="0">Invio</div>
    </div>
    <div class="tabContent active" id="tab-base" role="tabpanel">
     <div class="subTitle" style="margin-top:0">Colori cerchio</div>
     <div class="palette" id="ringPalette2"></div>
     <div class="subTitle">Colori piume</div>
     <div class="palette" id="featherPalette2"></div>
     <div class="tiny">Tocca un colore per applicarlo.</div>
    </div>
    <div class="tabContent" id="tab-accessori" role="tabpanel">
     <div class="subTitle" style="margin-top:0">Aggiungi accessori</div>
     <div class="list" id="accessoryList"></div>
     <div class="subTitle">Colore accessorio selezionato</div>
     <div class="palette" id="accPalette"></div>
     <div class="tiny">Suggerimento: trascina e posiziona. Pinch per zoom.</div>
    </div>
    <div class="tabContent" id="tab-testo" role="tabpanel">
     <div class="subTitle" style="margin-top:0">Testo / Intreccio</div>
     <div class="field" style="min-width:100%">
      <label>Scritta (opzionale)</label> <input id="textInput" placeholder="Es: 'Sogni d'oro' / nome / frase breve">
     </div>
     <div class="tiny">Il testo viene salvato nel riepilogo (non √® disegnato sul cerchio, per ora).</div>
    </div>
    <div class="tabContent" id="tab-invio" role="tabpanel">
     <div class="subTitle" style="margin-top:0">Invio WhatsApp</div>
     <div class="field" style="min-width:100%">
      <label>Numero WhatsApp (con +39)</label> <input id="waNumber" value="+393440260906">
     </div>
     <div class="actions">
      <button class="btn primary" id="sendBtn2" type="button">Invia riepilogo</button>
      <button class="btn" id="copyBtn2" type="button">Copia riepilogo</button>
     </div>
     <div class="tiny">Per inviare anche un‚Äôimmagine: fai uno screenshot dell‚Äôanteprima e mandalo in chat.</div>
    </div>
   </div>
  </div>
  <script>
/** =========================
 *  CONFIG
 *  ========================= */
const COLORS = [
  {name:"Nero", hex:"#111827"},
  {name:"Bianco", hex:"#ffffff"},
  {name:"Oro", hex:"#d4af37"},
  {name:"Argento", hex:"#c0c0c0"},
  {name:"Rosa", hex:"#ec4899"},
  {name:"Viola", hex:"#7c3aed"},
  {name:"Blu", hex:"#2563eb"},
  {name:"Azzurro", hex:"#38bdf8"},
  {name:"Verde", hex:"#22c55e"},
  {name:"Rosso", hex:"#ef4444"}
];

const ACCESSORIES = [
  {id:"piuma", label:"Piuma", emoji:"ü™∂", kind:"feather"},
  {id:"stella", label:"Stella", emoji:"‚≠ê", kind:"metal"},
  {id:"luna", label:"Luna", emoji:"üåô", kind:"metal"},
  {id:"sole", label:"Sole", emoji:"‚òÄÔ∏è", kind:"metal"},
  {id:"cuore", label:"Cuore", emoji:"üíé", kind:"crystal"},
  {id:"goccia", label:"Goccia", emoji:"üíß", kind:"crystal"},
  {id:"farfalla", label:"Farfalla", emoji:"ü¶ã", kind:"metal"},
  {id:"rosa", label:"Rosa", emoji:"üåπ", kind:"metal"},
  {id:"perla", label:"Perla", emoji:"‚ö™", kind:"bead"},
  {id:"gemma", label:"Gemma", emoji:"üî∑", kind:"bead"},
  {id:"catena", label:"Catena", emoji:"‚õìÔ∏è", kind:"chain"},
  {id:"cerchietto", label:"Anello", emoji:"‚≠ï", kind:"ring"}
];

/** =========================
 *  DOM
 *  ========================= */
const canvas = document.getElementById('stage');
const wrap = document.getElementById('stageWrap');
const ctx = canvas.getContext('2d');
const zoomLabel = document.getElementById('zoomLabel');

const resetBtn = document.getElementById('resetBtn');
const deleteBtn = document.getElementById('deleteBtn');
const deselectBtn = document.getElementById('deselectBtn');
const fitBtn = document.getElementById('fitBtn');

const ringPalette = document.getElementById('ringPalette');
const featherPalette = document.getElementById('featherPalette');
const ringPalette2 = document.getElementById('ringPalette2');
const featherPalette2 = document.getElementById('featherPalette2');
const accPalette = document.getElementById('accPalette');

const accessoryList = document.getElementById('accessoryList');

const diametro = document.getElementById('diametro');
const modello = document.getElementById('modello');
const note = document.getElementById('note');
const textInput = document.getElementById('textInput');
const waNumber = document.getElementById('waNumber');

const sendBtn = document.getElementById('sendBtn');
const sendBtn2 = document.getElementById('sendBtn2');
const copyBtn = document.getElementById('copyBtn');
const copyBtn2 = document.getElementById('copyBtn2');

/** =========================
 *  STATE
 *  ========================= */
let dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
let vw = 0, vh = 0;

const view = {
  scale: 1,
  minScale: 0.6,
  maxScale: 3.0,
  tx: 0,
  ty: 0
};

const design = {
  ringColor: "#111827",
  featherColor: "#7c3aed",
  text: ""
};

let items = []; // {id,label,emoji,x,y,size,color,rot}
let selectedId = null;

// gesture pointers
const pointers = new Map(); // id -> {x,y}
let lastPan = null;
let lastPinchDist = null;
let lastPinchMid = null;

/** =========================
 *  UTIL
 *  ========================= */
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function mid(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }

function resize(){
  const rect = wrap.getBoundingClientRect();
  vw = Math.floor(rect.width);
  vh = Math.floor(rect.height);
  canvas.width = Math.floor(vw * dpr);
  canvas.height = Math.floor(vh * dpr);
  canvas.style.width = vw + "px";
  canvas.style.height = vh + "px";
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // keep view centered
  fitToScreen(false);
  draw();
}
window.addEventListener('resize', () => { resize(); });

function fitToScreen(resetScale=true){
  // center "ring" to stage
  if(resetScale){
    view.scale = 1;
    view.tx = 0;
    view.ty = 0;
  }
  // nothing fancy: ensure ring fully visible
  const pad = 24;
  const ringR = Math.min(vw, vh) * 0.35;
  const s = Math.min((vw-pad*2)/(ringR*2), (vh-pad*2)/(ringR*2));
  view.scale = clamp(s, view.minScale, view.maxScale);
  view.tx = vw/2;
  view.ty = vh/2;
  zoomLabel.textContent = Math.round(view.scale*100) + "%";
}

/** =========================
 *  DRAW
 *  ========================= */
function draw(){
  ctx.save();
  ctx.setTransform(dpr,0,0,dpr,0,0);
  // clear
  ctx.clearRect(0,0,vw,vh);

  // background pure white
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,vw,vh);

  // apply view transform (world -> screen)
  ctx.translate(view.tx, view.ty);
  ctx.scale(view.scale, view.scale);

  // ring + grid (single ring only!)
  const ringOuter = Math.min(vw, vh) * 0.36;
  const ringInner = ringOuter * 0.86;

  // guide grid (black but light)
  ctx.save();
  ctx.strokeStyle = "rgba(17,24,39,.18)";
  ctx.lineWidth = 1 / view.scale;
  const rings = [0.2,0.4,0.6,0.8].map(t=> ringInner*t);
  for(const r of rings){
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.stroke();
  }
  for(let i=0;i<8;i++){
    const a = i*(Math.PI/4);
    ctx.beginPath();
    ctx.moveTo(Math.cos(a)*ringInner, Math.sin(a)*ringInner);
    ctx.lineTo(Math.cos(a)*ringOuter, Math.sin(a)*ringOuter);
    ctx.stroke();
  }
  ctx.restore();

  // ring black
  ctx.save();
  ctx.fillStyle = design.ringColor;
  ctx.beginPath(); ctx.arc(0,0,ringOuter,0,Math.PI*2); ctx.fill();
  ctx.globalCompositeOperation = "destination-out";
  ctx.beginPath(); ctx.arc(0,0,ringInner,0,Math.PI*2); ctx.fill();
  ctx.restore();

  // items
  for(const it of items){
    const isSel = it.id === selectedId;
    ctx.save();
    ctx.translate(it.x, it.y);
    ctx.rotate(it.rot || 0);
    const size = it.size;
    // backplate
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.strokeStyle = isSel ? "rgba(124,58,237,.9)" : "rgba(17,24,39,.18)";
    ctx.lineWidth = (isSel ? 3 : 1.5) / view.scale;
    roundRect(ctx, -size/2, -size/2, size, size, 14);
    ctx.fill();
    ctx.stroke();

    // icon
    ctx.fillStyle = it.color || "#111827";
    ctx.font = `${Math.floor(size*0.55)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    // For emoji, fillStyle doesn't change color, but for ‚ö™üî∑ etc it's fine. We'll still show colored dot overlay for customization.
    ctx.fillText(it.emoji, 0, -1);

    // small color dot
    ctx.fillStyle = it.color || design.featherColor;
    ctx.beginPath();
    ctx.arc(size*0.33, -size*0.33, Math.max(4, size*0.10), 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  ctx.restore();
}

function roundRect(c,x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  c.beginPath();
  c.moveTo(x+rr,y);
  c.arcTo(x+w,y,x+w,y+h,rr);
  c.arcTo(x+w,y+h,x,y+h,rr);
  c.arcTo(x,y+h,x,y,rr);
  c.arcTo(x,y,x+w,y,rr);
  c.closePath();
}

/** =========================
 *  HIT TEST
 *  ========================= */
function screenToWorld(sx, sy){
  // inverse of translate(tx,ty)*scale(scale)
  const x = (sx - view.tx) / view.scale;
  const y = (sy - view.ty) / view.scale;
  return {x,y};
}

function hitTest(sx, sy){
  const p = screenToWorld(sx, sy);
  // iterate reverse (topmost last)
  for(let i=items.length-1;i>=0;i--){
    const it = items[i];
    const half = it.size/2;
    if(p.x >= it.x-half && p.x <= it.x+half && p.y >= it.y-half && p.y <= it.y+half){
      return it.id;
    }
  }
  return null;
}

/** =========================
 *  GESTURES (Pointer Events)
 *  ========================= */
wrap.addEventListener('pointerdown', (e)=>{
  wrap.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

  const hit = hitTest(e.clientX - wrap.getBoundingClientRect().left, e.clientY - wrap.getBoundingClientRect().top);
  if(hit){
    selectedId = hit;
  }else{
    // tap empty -> deselect
    selectedId = null;
  }
  // start pan/drag
  lastPan = {x:e.clientX, y:e.clientY};
  lastPinchDist = null;
  lastPinchMid = null;
  draw();
}, {passive:false});

wrap.addEventListener('pointermove', (e)=>{
  if(!pointers.has(e.pointerId)) return;
  pointers.set(e.pointerId, {x:e.clientX, y:e.clientY});

  const rect = wrap.getBoundingClientRect();
  const localX = e.clientX - rect.left;
  const localY = e.clientY - rect.top;

  if(pointers.size === 1){
    // drag selected item if exists, otherwise pan view
    const cur = {x:e.clientX, y:e.clientY};
    const dx = cur.x - lastPan.x;
    const dy = cur.y - lastPan.y;
    lastPan = cur;

    if(selectedId){
      const it = items.find(i=>i.id===selectedId);
      if(it){
        const wdx = dx / view.scale;
        const wdy = dy / view.scale;
        it.x += wdx;
        it.y += wdy;
      }
    }else{
      view.tx += dx;
      view.ty += dy;
    }
    draw();
    return;
  }

  if(pointers.size >= 2){
    // pinch zoom + pan (use first two pointers)
    const pts = Array.from(pointers.values());
    const a = pts[0], b = pts[1];
    const d = dist(a,b);
    const m = mid(a,b);

    if(lastPinchDist == null){
      lastPinchDist = d;
      lastPinchMid = m;
      return;
    }
    const scaleFactor = d / lastPinchDist;
    const newScale = clamp(view.scale * scaleFactor, view.minScale, view.maxScale);

    // keep midpoint stable in screen space
    const preWorld = screenToWorld((lastPinchMid.x-rect.left), (lastPinchMid.y-rect.top));
    view.scale = newScale;
    const postScreenX = preWorld.x * view.scale + view.tx;
    const postScreenY = preWorld.y * view.scale + view.ty;

    view.tx += ((lastPinchMid.x-rect.left) - postScreenX);
    view.ty += ((lastPinchMid.y-rect.top) - postScreenY);

    // also pan following finger midpoint movement
    view.tx += (m.x - lastPinchMid.x);
    view.ty += (m.y - lastPinchMid.y);

    lastPinchDist = d;
    lastPinchMid = m;

    zoomLabel.textContent = Math.round(view.scale*100) + "%";
    draw();
  }
}, {passive:false});

function endPointer(e){
  if(pointers.has(e.pointerId)) pointers.delete(e.pointerId);
  if(pointers.size < 2){
    lastPinchDist = null;
    lastPinchMid = null;
  }
}
wrap.addEventListener('pointerup', endPointer);
wrap.addEventListener('pointercancel', endPointer);
wrap.addEventListener('pointerleave', endPointer);

/** =========================
 *  UI: palettes + tabs
 *  ========================= */
function renderPalette(container, onPick, getActive){
  container.innerHTML = "";
  COLORS.forEach(c=>{
    const b = document.createElement('button');
    b.type="button";
    b.className = "swatch";
    b.style.background = c.hex;
    if(getActive && getActive() === c.hex) b.classList.add('active');
    b.title = c.name;
    b.addEventListener('click', ()=>{
      onPick(c.hex);
      // refresh active state
      renderAllPalettes();
      draw();
    });
    container.appendChild(b);
  });
}
function renderAllPalettes(){
  renderPalette(ringPalette, (hex)=> design.ringColor=hex, ()=>design.ringColor);
  renderPalette(ringPalette2,(hex)=> design.ringColor=hex, ()=>design.ringColor);
  renderPalette(featherPalette,(hex)=> design.featherColor=hex, ()=>design.featherColor);
  renderPalette(featherPalette2,(hex)=> design.featherColor=hex, ()=>design.featherColor);

  renderPalette(accPalette,(hex)=>{
    if(!selectedId) return;
    const it = items.find(i=>i.id===selectedId);
    if(it) it.color = hex;
  }, ()=>{
    const it = items.find(i=>i.id===selectedId);
    return it?.color || null;
  });
}

function uid(){
  return "it_" + Math.random().toString(16).slice(2,10);
}

function addAccessory(acc){
  const id = uid();
  // spawn near top-left of ring
  const ringOuter = Math.min(vw, vh) * 0.36;
  const p = {x: -ringOuter*0.75 + (Math.random()*20), y: -ringOuter*0.75 + (Math.random()*20)};
  items.push({
    id,
    label: acc.label,
    emoji: acc.emoji,
    x: p.x, y: p.y,
    size: 70,
    color: (acc.kind==="feather") ? design.featherColor : "#111827",
    rot: 0
  });
  selectedId = id;
  renderAllPalettes();
  draw();
}

function renderAccessoryList(){
  accessoryList.innerHTML = "";
  ACCESSORIES.forEach(acc=>{
    const d = document.createElement('div');
    d.className = "item";
    d.innerHTML = `
      <div class="icon">${acc.emoji}</div>
      <div class="name">${acc.label}</div>
    `;
    d.addEventListener('click', ()=> addAccessory(acc));
    accessoryList.appendChild(d);
  });
}

/** Tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=> setTab(t.dataset.tab));
});
function setTab(name){
  document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
  document.querySelectorAll('.tabContent').forEach(p=> p.classList.remove('active'));
  const panel = document.getElementById('tab-'+name);
  if(panel) panel.classList.add('active');
}

/** Buttons */
resetBtn.addEventListener('click', ()=>{
  items = [];
  selectedId = null;
  design.ringColor = "#111827";
  design.featherColor = "#7c3aed";
  note.value = "";
  textInput.value = "";
  renderAllPalettes();
  fitToScreen(true);
  draw();
});
deleteBtn.addEventListener('click', ()=>{
  if(!selectedId) return;
  items = items.filter(i=>i.id!==selectedId);
  selectedId = null;
  renderAllPalettes();
  draw();
});
deselectBtn.addEventListener('click', ()=>{
  selectedId = null;
  renderAllPalettes();
  draw();
});
fitBtn.addEventListener('click', ()=>{
  fitToScreen(true);
  draw();
});

textInput.addEventListener('input', ()=>{ design.text = textInput.value || ""; });
note.addEventListener('input', ()=>{ /* included in summary */ });

/** WhatsApp summary */
function buildSummary(){
  const accLines = items.map((it, idx)=>{
    const color = it.color || "default";
    return `${idx+1}) ${it.label} ${it.emoji} ‚Ä¢ colore: ${color}`;
  });
  const lines = [
    "üßµ *Richiesta Acchiappasogni Personalizzato*",
    `‚Ä¢ Modello: ${modello.value}`,
    `‚Ä¢ Diametro: ${diametro.value} cm`,
    `‚Ä¢ Colore cerchio: ${design.ringColor}`,
    `‚Ä¢ Colore piume: ${design.featherColor}`,
    design.text ? `‚Ä¢ Testo: ${design.text}` : null,
    note.value ? `‚Ä¢ Note: ${note.value}` : null,
    "",
    "üìé *Accessori scelti:*",
    accLines.length ? accLines.join("\n") : "‚Äî nessuno ‚Äî",
    "",
    "‚úÖ Se vuoi, invio anche screenshot dell'anteprima."
  ].filter(Boolean);
  return lines.join("\n");
}
async function copySummary(){
  const txt = buildSummary();
  try{
    await navigator.clipboard.writeText(txt);
    alert("Riepilogo copiato ‚úÖ");
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert("Riepilogo copiato ‚úÖ");
  }
}
function sendWhatsApp(){
  const number = (waNumber.value || "+393440260906").replace(/\s+/g,"");
  const msg = encodeURIComponent(buildSummary());
  // wa.me needs number without +
  const n = number.replace("+","");
  window.open(`https://wa.me/${n}?text=${msg}`, "_blank");
}

copyBtn.addEventListener('click', copySummary);
copyBtn2.addEventListener('click', copySummary);
sendBtn.addEventListener('click', sendWhatsApp);
sendBtn2.addEventListener('click', sendWhatsApp);

/** Close (demo) */
document.getElementById('closeBtn').addEventListener('click', ()=>{
  // if embedded in app, you can hook this; in browser we just scroll to top and flash
  window.scrollTo({top:0, behavior:"smooth"});
});

/** Init */
renderAccessoryList();
renderAllPalettes();
resize();
</script>
 </body>
</html>
